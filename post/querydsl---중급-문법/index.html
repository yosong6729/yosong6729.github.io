<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Querydsl] 중급 문법 | Yosong6729 Blog</title>
<meta name=keywords content="Querydsl"><meta name=description content='해당 글은 김영한님의 인프런 강의 실전! Querydsl을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
프로젝션 결과 반환 - 기본 프로젝션은 select절의 대상을 지정하는것을 말한다.
프로젝션 대상이 하나 @Test public void simplePorjection() { List<String> result = queryFactory .select(member.username) .from(member) .fetch(); for (String s : result) { System.out.println("s = " + s); } } select절에 member.username으로 프로젝션 대상이 하나 이기 때문에 String 타입으로 명확하게 지정이 가능하다.'><meta name=author content="yosong6729"><link rel=canonical href=https://yosong6729.github.io/post/querydsl---%EC%A4%91%EA%B8%89-%EB%AC%B8%EB%B2%95/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://yosong6729.github.io/post/querydsl---%EC%A4%91%EA%B8%89-%EB%AC%B8%EB%B2%95/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="[Querydsl] 중급 문법"><meta property="og:description" content='해당 글은 김영한님의 인프런 강의 실전! Querydsl을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
프로젝션 결과 반환 - 기본 프로젝션은 select절의 대상을 지정하는것을 말한다.
프로젝션 대상이 하나 @Test public void simplePorjection() { List<String> result = queryFactory .select(member.username) .from(member) .fetch(); for (String s : result) { System.out.println("s = " + s); } } select절에 member.username으로 프로젝션 대상이 하나 이기 때문에 String 타입으로 명확하게 지정이 가능하다.'><meta property="og:type" content="article"><meta property="og:url" content="https://yosong6729.github.io/post/querydsl---%EC%A4%91%EA%B8%89-%EB%AC%B8%EB%B2%95/"><meta property="og:image" content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-10-09T22:07:15+09:00"><meta property="article:modified_time" content="2024-10-09T22:07:15+09:00"><meta property="og:site_name" content="Yosong6729 Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="[Querydsl] 중급 문법"><meta name=twitter:description content='해당 글은 김영한님의 인프런 강의 실전! Querydsl을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
프로젝션 결과 반환 - 기본 프로젝션은 select절의 대상을 지정하는것을 말한다.
프로젝션 대상이 하나 @Test public void simplePorjection() { List<String> result = queryFactory .select(member.username) .from(member) .fetch(); for (String s : result) { System.out.println("s = " + s); } } select절에 member.username으로 프로젝션 대상이 하나 이기 때문에 String 타입으로 명확하게 지정이 가능하다.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yosong6729.github.io/post/"},{"@type":"ListItem","position":2,"name":"[Querydsl] 중급 문법","item":"https://yosong6729.github.io/post/querydsl---%EC%A4%91%EA%B8%89-%EB%AC%B8%EB%B2%95/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Querydsl] 중급 문법","name":"[Querydsl] 중급 문법","description":"해당 글은 김영한님의 인프런 강의 실전! Querydsl을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\n프로젝션 결과 반환 - 기본 프로젝션은 select절의 대상을 지정하는것을 말한다.\n프로젝션 대상이 하나 @Test public void simplePorjection() { List\u0026lt;String\u0026gt; result = queryFactory .select(member.username) .from(member) .fetch(); for (String s : result) { System.out.println(\u0026#34;s = \u0026#34; + s); } } select절에 member.username으로 프로젝션 대상이 하나 이기 때문에 String 타입으로 명확하게 지정이 가능하다.","keywords":["Querydsl"],"articleBody":" 해당 글은 김영한님의 인프런 강의 실전! Querydsl을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\n프로젝션 결과 반환 - 기본 프로젝션은 select절의 대상을 지정하는것을 말한다.\n프로젝션 대상이 하나 @Test public void simplePorjection() { List\u003cString\u003e result = queryFactory .select(member.username) .from(member) .fetch(); for (String s : result) { System.out.println(\"s = \" + s); } } select절에 member.username으로 프로젝션 대상이 하나 이기 때문에 String 타입으로 명확하게 지정이 가능하다.\n쿼리 결과와 result 출력 결과를 보면 username의 데이터만 가져오는것을 확인할수 있다.\n튜플 조회 프로젝션 대상이 둘 이상일때 튜플로 결과를 반환한다.\n@Test public void tupleProjection() { List\u003cTuple\u003e result = queryFactory .select(member.username, member.age) .from(member) .fetch(); for (Tuple tuple : result) { String username = tuple.get(member.username); Integer age = tuple.get(member.age); System.out.println(\"username = \" + username); System.out.println(\"age = \" + age); } } 튜플은 con.querydsl.core.Tuple인 Querydsl에 종속적인 타입이기 때문에 리포지토리 계층안에서만 사용하고 다른 계층으로 넘길때는 DTO로 반환하는것을 권장한다.\n쿼리 결과와 result 출력 결과를 보면 username과 age의 데이터를 가져오는것을 확인할수 있다\n프로젝션과 결과 반환 - DTO 조회 먼저 순수 JPA에서 DTO를 조회 해보자\nMemberDto\n@Data @NoArgsConstructor public class MemberDto { private String username; private int age; public MemberDto(String username, int age) { this.username = username; this.age = age; } } 순수 JPA에서 DTO 조회 코드\nList\u003cMemberDto\u003e result = em.createQuery( \"select new study.querydsl.dto.MemberDto(m.username, m.age) from Member m\" , MemberDto.class) .getResultList(); 순수 JPA에서 DTO를 조회할 때는 new 명령어를 사용하기때문에 DTO의 package이름을 다 적어줘야해서 지저분하고 생성자 방식(프리티어 방식X)만 지원한다.\nQuerydsl 빈 생성(Bean population) 결과를 DTO 반환할때 사용한다.\n다음 3가지 방법을 지원한다.\n프로퍼티 접근 필드 직접 접근 생성자 사용 프로퍼티 접근 - Setter\n@Test public void findDtoBySetter() { List\u003cMemberDto\u003e result = queryFactory .select(Projections.bean(MemberDto.class, member.username, member.age)) .from(member) .fetch(); for (MemberDto memberDto : result) { System.out.println(\"memberDto = \" + memberDto); } } DTO에 Setter가 있어야지 접근이 가능하다.\n쿼리 결과와 result 출력결과를 보면 DTO에 맞게 username, age 값을 가져온다.\n필드 직접 접근\n@Test public void findDtoByField() { List\u003cMemberDto\u003e result = queryFactory .select(Projections.fields(MemberDto.class, member.username, member.age)) .from(member) .fetch(); for (MemberDto memberDto : result) { System.out.println(\"memberDto = \" + memberDto); } } Setter가 없어도 되고 필드에 값을 초기화 하는 방식이다\nDTO의 필드명과 프로젝션의 필드명이 동일해야 한다.\n별칭이 다를 경우(DTO의 필드명과 엔티티의 필드명이 다를경우)\n@Data public class UserDto { private String name; private int age; } @Test public void findUserDto() { QMember memberSub = new QMember(\"memberSub\"); List\u003cUserDto\u003e result = queryFactory .select(Projections.fields(UserDto.class, member.username.as(\"name\"), ExpressionUtils.as( JPAExpressions .select(memberSub.age.max()) .from(memberSub), \"age\") )) .from(member) .fetch(); for (UserDto userDto : result) { System.out.println(\"userDto = \" + userDto); } } 프로퍼티나 필드 접근 생성 방식에서 이름이 다를때 해결 방안\nExpressionUtils.as(Source, alias): 필드나, 서브 쿼리에 별칭을 적용한다. username.as(”memberName”): 필드에 별칭을 적용한다. 쿼리 결과와 result 출력 결과를 보면 쿼리문에 별칭이 적용된것을 확인할수있고 결과도 올바르게 나오는것을 확인할수 있다.\n생성자 사용\n@Test public void findDtoByConstructor() { List\u003cMemberDto\u003e result = queryFactory .select(Projections.constructor(MemberDto.class, member.username, member.age)) .from(member) .fetch(); for (MemberDto memberDto : result) { System.out.println(\"memberDto = \" + memberDto); } } memberDto의 생성자 파라미터 타입과 프로젝션 타입을 동일하게 맞춰주야 한다.\n프로젝션과 결과 반환 - @QueryProjection 생성자 + @QueryProjection\n@Data @NoArgsConstructor public class MemberDto { private String username; private int age; @QueryProjection public MemberDto(String username, int age) { this.username = username; this.age = age; } } @QueryProjection을 작성후 ./gradlew compileJava를 실행하면 아래 사진처럼 QMemberDto가 생성되는것을 확인할수 있다.\n@QueryProjection 활용\n@Test public void findDtoByQueryProjection() { List\u003cMemberDto\u003e result = queryFactory .select(new QMemberDto(member.username, member.age)) .from(member) .fetch(); for (MemberDto memberDto : result) { System.out.println(\"memberDto = \" + memberDto); } } 이 방법은 컴파일 시점에 오류를 잡아주고 타입을 체크할수 있으므로 가장 안전한 방법이다. 하지만 DTO에 QueryDSL 어노테이션을 유지해야 하는 점과 DTO까지 Q 파일을 생성해야하는 단점이 있고, DTO에 @QueryProjection 어노테이션으로 인해 Querydsl 라이브러리를 의존해서 나중에 Querydsl의 기술을 바꾸게 된다면 리포지토리 이외의 계층에 영향을 미칠수 있다는 단점이 있다.\n쿼리 결과와 result 출력 결과를 보면 Dto에 맞게 쿼리 겨로가와 result 결과가 나온것을 확인할 수 있다.\ndistinct List\u003cString\u003e result = queryFactory .select(member.username).distinct() .from(member) .fetch(); 동적 쿼리 - BooleanBuilder 사용 동적 쿼리를 해결하는 두가지 방식이 있다.\nBooleanBuilder Where 다중 파라미터 사용 BooleanBuilder 사용\n@Test public void dynamicQuery_BooleanBuilder() { String usernameParam = \"member1\"; Integer ageParam = 10; List\u003cMember\u003e result = searchMember1(usernameParam, ageParam); assertThat(result.size()).isEqualTo(1); } private List\u003cMember\u003e searchMember1(String usernameCond, Integer ageCond) { BooleanBuilder builder = new BooleanBuilder(); if (usernameCond != null) { builder.and(member.username.eq(usernameCond)); } if (ageCond != null) { builder.and(member.age.eq(ageCond)); } return queryFactory .selectFrom(member) .where(builder) .fetch(); } BooleanBuilder를 사용해서 username과 age의 값의 null 여부를 판단해서 where절에 조건을 추가할지를 결정한다.\nusername과 age값이 있다면 다음 쿼리 결과와 같이 파라미터 바인딩이 2개 된것을 확인할 수 있다.\nage을 null로 하면 파라미터 바인딩이 1개만 된것을 확인할 수 있다.\n동적 쿼리 - Where 다중 파라미터 사용 @Test public void dynamicQuery_WhereParam() { String usernameParam = \"member1\"; Integer ageParam = 10; List\u003cMember\u003e result = searchMember2(usernameParam, ageParam); assertThat(result.size()).isEqualTo(1); } private List\u003cMember\u003e searchMember2(String usernameCond, Integer ageCond) { return queryFactory .selectFrom(member) .where(usernameEq(usernameCond), ageEq(ageCond)) .fetch(); } private BooleanExpression usernameEq(String usernameCond) { return usernameCond != null ? member.username.eq(usernameCond) : null; } private BooleanExpression ageEq(Integer ageCond) { return ageCond != null ? member.age.eq(ageCond) : null; } where 조건에 null은 무시되는 점을 이용하여 여러 조건을 메서드로 생성하여 동적 쿼리를 작성한다. 위 방법은 메서드를 다른 쿼리에서도 재활용할수 있고 메서드의 이름으로 쿼리 자체의 가독성이 높아진다.\n조합 가능\nprivate BooleanExpression allEq(String usernameCond, Integer ageCond) { return usernameEq(usernameCond).and(ageEq(ageCond)); } 두개의 조건을 조합하여 하나로 만들수도 있다.\n파라미터 값의 null 체크는 주의 해서 처리해야 한다.\n수정, 삭제 벌크 연산 쿼리 한번으로 대량의 데이터를 수정 해보자\n@Test public void bulkUpdate() { long count = queryFactory .update(member) .set(member.username, \"비회원\") .where(member.age.lt(28)) .execute(); } 반환값은 변경된 row 수이다.\n벌크 연산은 영속성 컨텍스트 말고 DB에 바로 쿼리가 나간다. 그래서 DB의 상태와 영속성 컨텍스트의 상태가 달라진다.\n만약 데이터 수정 이후 meber의 값을 가져오는 코드를 실행하면 DB에 sql문을 실행해서 값을 가져오고 가져온 값을 영속성 컨텍스트에 저장하는데 PK값이 같은 것이 영속성 컨텍스트에 있으면 DB에서 가져온 값을 버리고 영속성 컨텍스트의 값을 유지한다.\n이러한 문제를 해결하기 위해서는 벌크 연산 이후 아래 코드로 DB와 영속성 컨텍스트의 값을 맞춰준다.\nem.flush(); em.clear(); 기존 숫자에 1 더하기\n@Test public void bulkAdd() { long count = queryFactory .update(member) .set(member.age, member.age.add(1)) .execute(); } 빼기 명령어는 없기때문에 값을 뺄때는 add(-1)처럼 작성하면된다.\n곱하기는 multiply(x)를 사용하면 된다.\n쿼리 한번으로 대량 데이터 삭제\n@Test public void bulkDelete() { long count = queryFactory .delete(member) .where(member.age.gt(18)) .execute(); } SQL function 호출하기 SQL function은 JPA와 같이 Dialect에 등록된 내용만 호출이 가능하다.\nmember → M으로 변경하는 replace 함수를 사용해보자.\n@Test public void sqlFunction() { List\u003cString\u003e result = queryFactory .select(Expressions.stringTemplate( \"function('replace', {0}, {1}, {2})\", member.username, \"member\", \"M\" )) .from(member) .fetch(); for (String s : result) { System.out.println(\"s = \" + s); } } 쿼리 결과를 보면 jpql은 Expressions.stringTemplate에 작성한것과 동일하게 적용되고 sql문도 replace가 적용된것을 확인할수 있다.\nresult 출력 결과\n소문자로 변경해서 비교해보자.\n예제가 좋은 예제가 아니기 때문에 쿼리 문에 집중하자.\n@Test public void sqlFunction2() { List\u003cString\u003e result = queryFactory .select(member.username) .from(member) .where(member.username.eq( Expressions.stringTemplate(\"function('lower', {0})\", member.username) )) .fetch(); } 쿼리 결과를 확인해보면 lower function이 적용된것을 확인할수 있다.\nlower 같은 ansi 표준 함수들은 querydsl이 상당부분 내장하고있기 대문에 다음과 같이 처리해도 결과는 동일하다.\n.where(member.username.eq(member.username.lower())) ","wordCount":"1102","inLanguage":"en","image":"https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-10-09T22:07:15+09:00","dateModified":"2024-10-09T22:07:15+09:00","author":{"@type":"Person","name":"yosong6729"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yosong6729.github.io/post/querydsl---%EC%A4%91%EA%B8%89-%EB%AC%B8%EB%B2%95/"},"publisher":{"@type":"Organization","name":"Yosong6729 Blog","logo":{"@type":"ImageObject","url":"https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yosong6729.github.io/ accesskey=h title="Yosong6729 블로그 (Alt + H)"><img src=https://yosong6729.github.io/apple-touch-icon.png alt aria-label=logo height=35>Yosong6729 블로그</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yosong6729.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://yosong6729.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yosong6729.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yosong6729.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">[Querydsl] 중급 문법</h1><div class=post-meta><span title='2024-10-09 22:07:15 +0900 KST'>October 9, 2024</span>&nbsp;·&nbsp;yosong6729&nbsp;|&nbsp;<a href=https://github.com/yosong6729/blog/tree/main/content/post/Querydsl%20-%20%ec%a4%91%ea%b8%89%20%eb%ac%b8%eb%b2%95/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%ed%94%84%eb%a1%9c%ec%a0%9d%ec%85%98-%ea%b2%b0%ea%b3%bc-%eb%b0%98%ed%99%98---%ea%b8%b0%eb%b3%b8 aria-label="프로젝션 결과 반환 - 기본">프로젝션 결과 반환 - 기본</a><ul><li><a href=#%ed%94%84%eb%a1%9c%ec%a0%9d%ec%85%98-%eb%8c%80%ec%83%81%ec%9d%b4-%ed%95%98%eb%82%98 aria-label="프로젝션 대상이 하나">프로젝션 대상이 하나</a></li><li><a href=#%ed%8a%9c%ed%94%8c-%ec%a1%b0%ed%9a%8c aria-label="튜플 조회">튜플 조회</a></li></ul></li><li><a href=#%ed%94%84%eb%a1%9c%ec%a0%9d%ec%85%98%ea%b3%bc-%ea%b2%b0%ea%b3%bc-%eb%b0%98%ed%99%98---dto-%ec%a1%b0%ed%9a%8c aria-label="프로젝션과 결과 반환 - DTO 조회">프로젝션과 결과 반환 - DTO 조회</a><ul><li><a href=#querydsl-%eb%b9%88-%ec%83%9d%ec%84%b1bean-population aria-label="Querydsl 빈 생성(Bean population)">Querydsl 빈 생성(Bean population)</a></li></ul></li><li><a href=#%ed%94%84%eb%a1%9c%ec%a0%9d%ec%85%98%ea%b3%bc-%ea%b2%b0%ea%b3%bc-%eb%b0%98%ed%99%98---queryprojection aria-label="프로젝션과 결과 반환 - @QueryProjection">프로젝션과 결과 반환 - @QueryProjection</a><ul><li><a href=#distinct aria-label=distinct>distinct</a></li></ul></li><li><a href=#%eb%8f%99%ec%a0%81-%ec%bf%bc%eb%a6%ac---booleanbuilder-%ec%82%ac%ec%9a%a9 aria-label="동적 쿼리 - BooleanBuilder 사용">동적 쿼리 - BooleanBuilder 사용</a></li><li><a href=#%eb%8f%99%ec%a0%81-%ec%bf%bc%eb%a6%ac---where-%eb%8b%a4%ec%a4%91-%ed%8c%8c%eb%9d%bc%eb%af%b8%ed%84%b0-%ec%82%ac%ec%9a%a9 aria-label="동적 쿼리 - Where 다중 파라미터 사용">동적 쿼리 - Where 다중 파라미터 사용</a></li><li><a href=#%ec%88%98%ec%a0%95-%ec%82%ad%ec%a0%9c-%eb%b2%8c%ed%81%ac-%ec%97%b0%ec%82%b0 aria-label="수정, 삭제 벌크 연산">수정, 삭제 벌크 연산</a></li><li><a href=#sql-function-%ed%98%b8%ec%b6%9c%ed%95%98%ea%b8%b0 aria-label="SQL function 호출하기">SQL function 호출하기</a></li></ul></div></details></div><div class=post-content><blockquote><p>해당 글은 김영한님의 인프런 강의 <a href=https://www.inflearn.com/course/querydsl-%EC%8B%A4%EC%A0%84>실전! Querydsl</a>을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.</p></blockquote><hr><h2 id=프로젝션-결과-반환---기본>프로젝션 결과 반환 - 기본<a hidden class=anchor aria-hidden=true href=#프로젝션-결과-반환---기본>#</a></h2><p>프로젝션은 select절의 대상을 지정하는것을 말한다.</p><h3 id=프로젝션-대상이-하나>프로젝션 대상이 하나<a hidden class=anchor aria-hidden=true href=#프로젝션-대상이-하나>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>simplePorjection</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;s = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>s</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>select절에 member.username으로 프로젝션 대상이 하나 이기 때문에 String 타입으로 명확하게 지정이 가능하다.</p><p>쿼리 결과와 result 출력 결과를 보면 username의 데이터만 가져오는것을 확인할수 있다.</p><p><img loading=lazy src=images/image.png alt=image.png></p><p><img loading=lazy src=images/image%201.png alt=image.png></p><h3 id=튜플-조회>튜플 조회<a hidden class=anchor aria-hidden=true href=#튜플-조회>#</a></h3><p>프로젝션 대상이 둘 이상일때 튜플로 결과를 반환한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>tupleProjection</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Tuple</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Tuple</span><span class=w> </span><span class=n>tuple</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tuple</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>age</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tuple</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;username = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;age = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>age</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>튜플은 con.querydsl.core.Tuple인 Querydsl에 종속적인 타입이기 때문에 리포지토리 계층안에서만 사용하고 다른 계층으로 넘길때는 DTO로 반환하는것을 권장한다.</p><p>쿼리 결과와 result 출력 결과를 보면 username과 age의 데이터를 가져오는것을 확인할수 있다</p><p><img loading=lazy src=images/image%202.png alt=image.png></p><p><img loading=lazy src=images/image%203.png alt=image.png></p><hr><h2 id=프로젝션과-결과-반환---dto-조회>프로젝션과 결과 반환 - DTO 조회<a hidden class=anchor aria-hidden=true href=#프로젝션과-결과-반환---dto-조회>#</a></h2><p>먼저 순수 JPA에서 DTO를 조회 해보자</p><p><strong>MemberDto</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MemberDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>age</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MemberDto</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>age</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>age</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>age</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>순수 JPA에서 DTO 조회 코드</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>MemberDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;select new study.querydsl.dto.MemberDto(m.username, m.age) from Member m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>,</span><span class=w> </span><span class=n>MemberDto</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>순수 JPA에서 DTO를 조회할 때는 new 명령어를 사용하기때문에 DTO의 package이름을 다 적어줘야해서 지저분하고 생성자 방식(프리티어 방식X)만 지원한다.</p><h3 id=querydsl-빈-생성bean-population>Querydsl 빈 생성(Bean population)<a hidden class=anchor aria-hidden=true href=#querydsl-빈-생성bean-population>#</a></h3><p>결과를 DTO 반환할때 사용한다.</p><p>다음 3가지 방법을 지원한다.</p><ol><li>프로퍼티 접근</li><li>필드 직접 접근</li><li>생성자 사용</li></ol><p><strong>프로퍼티 접근 - Setter</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>findDtoBySetter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>MemberDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>Projections</span><span class=p>.</span><span class=na>bean</span><span class=p>(</span><span class=n>MemberDto</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>MemberDto</span><span class=w> </span><span class=n>memberDto</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;memberDto = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>memberDto</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>DTO에 Setter가 있어야지 접근이 가능하다.</p><p>쿼리 결과와 result 출력결과를 보면 DTO에 맞게 username, age 값을 가져온다.</p><p><img loading=lazy src=images/image%204.png alt=image.png></p><p><img loading=lazy src=images/image%205.png alt=image.png></p><p><strong>필드 직접 접근</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>findDtoByField</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>MemberDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>Projections</span><span class=p>.</span><span class=na>fields</span><span class=p>(</span><span class=n>MemberDto</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>MemberDto</span><span class=w> </span><span class=n>memberDto</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;memberDto = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>memberDto</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Setter가 없어도 되고 필드에 값을 초기화 하는 방식이다</p><p>DTO의 필드명과 프로젝션의 필드명이 동일해야 한다.</p><p><strong>별칭이 다를 경우(DTO의 필드명과 엔티티의 필드명이 다를경우)</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UserDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>age</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>findUserDto</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>QMember</span><span class=w> </span><span class=n>memberSub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QMember</span><span class=p>(</span><span class=s>&#34;memberSub&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>UserDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>Projections</span><span class=p>.</span><span class=na>fields</span><span class=p>(</span><span class=n>UserDto</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ExpressionUtils</span><span class=p>.</span><span class=na>as</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>JPAExpressions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>memberSub</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>max</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>memberSub</span><span class=p>),</span><span class=w> </span><span class=s>&#34;age&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>UserDto</span><span class=w> </span><span class=n>userDto</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;userDto = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>userDto</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>프로퍼티나 필드 접근 생성 방식에서 이름이 다를때 해결 방안</p><ul><li>ExpressionUtils.as(Source, alias): 필드나, 서브 쿼리에 별칭을 적용한다.</li><li>username.as(”memberName”): 필드에 별칭을 적용한다.</li></ul><p>쿼리 결과와 result 출력 결과를 보면 쿼리문에 별칭이 적용된것을 확인할수있고 결과도 올바르게 나오는것을 확인할수 있다.</p><p><img loading=lazy src=images/image%206.png alt=image.png></p><p><img loading=lazy src=images/image%207.png alt=image.png></p><p><strong>생성자 사용</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>findDtoByConstructor</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>MemberDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>Projections</span><span class=p>.</span><span class=na>constructor</span><span class=p>(</span><span class=n>MemberDto</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>MemberDto</span><span class=w> </span><span class=n>memberDto</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;memberDto = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>memberDto</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>memberDto의 생성자 파라미터 타입과 프로젝션 타입을 동일하게 맞춰주야 한다.</p><hr><h2 id=프로젝션과-결과-반환---queryprojection>프로젝션과 결과 반환 - @QueryProjection<a hidden class=anchor aria-hidden=true href=#프로젝션과-결과-반환---queryprojection>#</a></h2><p><strong>생성자 + @QueryProjection</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MemberDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>age</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@QueryProjection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MemberDto</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>age</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>age</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>age</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>@QueryProjection을 작성후 ./gradlew compileJava를 실행하면 아래 사진처럼 QMemberDto가 생성되는것을 확인할수 있다.</p><p><img loading=lazy src=images/image%208.png alt=image.png></p><p><strong>@QueryProjection 활용</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>findDtoByQueryProjection</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>MemberDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>QMemberDto</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>MemberDto</span><span class=w> </span><span class=n>memberDto</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;memberDto = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>memberDto</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>이 방법은 컴파일 시점에 오류를 잡아주고 타입을 체크할수 있으므로 가장 안전한 방법이다. 하지만 DTO에 QueryDSL 어노테이션을 유지해야 하는 점과 DTO까지 Q 파일을 생성해야하는 단점이 있고, DTO에 @QueryProjection 어노테이션으로 인해 Querydsl 라이브러리를 의존해서 나중에 Querydsl의 기술을 바꾸게 된다면 리포지토리 이외의 계층에 영향을 미칠수 있다는 단점이 있다.</p><p>쿼리 결과와 result 출력 결과를 보면 Dto에 맞게 쿼리 겨로가와 result 결과가 나온것을 확인할 수 있다.</p><p><img loading=lazy src=images/image%209.png alt=image.png></p><p><img loading=lazy src=images/image%2010.png alt=image.png></p><h3 id=distinct>distinct<a hidden class=anchor aria-hidden=true href=#distinct>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>).</span><span class=na>distinct</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><hr><h2 id=동적-쿼리---booleanbuilder-사용>동적 쿼리 - BooleanBuilder 사용<a hidden class=anchor aria-hidden=true href=#동적-쿼리---booleanbuilder-사용>#</a></h2><p><strong>동적 쿼리를 해결하는 두가지 방식이 있다.</strong></p><ol><li>BooleanBuilder</li><li>Where 다중 파라미터 사용</li></ol><p><strong>BooleanBuilder 사용</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dynamicQuery_BooleanBuilder</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>usernameParam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;member1&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Integer</span><span class=w> </span><span class=n>ageParam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>searchMember1</span><span class=p>(</span><span class=n>usernameParam</span><span class=p>,</span><span class=w> </span><span class=n>ageParam</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>size</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=nf>searchMember1</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>usernameCond</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>ageCond</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BooleanBuilder</span><span class=w> </span><span class=n>builder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BooleanBuilder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>usernameCond</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>builder</span><span class=p>.</span><span class=na>and</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=n>usernameCond</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ageCond</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>builder</span><span class=p>.</span><span class=na>and</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=n>ageCond</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>builder</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>BooleanBuilder를 사용해서 username과 age의 값의 null 여부를 판단해서 where절에 조건을 추가할지를 결정한다.</p><p>username과 age값이 있다면 다음 쿼리 결과와 같이 파라미터 바인딩이 2개 된것을 확인할 수 있다.</p><p><img loading=lazy src=images/image%2011.png alt=image.png></p><p>age을 null로 하면 파라미터 바인딩이 1개만 된것을 확인할 수 있다.</p><p><img loading=lazy src=images/image%2012.png alt=image.png></p><hr><h2 id=동적-쿼리---where-다중-파라미터-사용>동적 쿼리 - Where 다중 파라미터 사용<a hidden class=anchor aria-hidden=true href=#동적-쿼리---where-다중-파라미터-사용>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>dynamicQuery_WhereParam</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>usernameParam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;member1&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Integer</span><span class=w> </span><span class=n>ageParam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>searchMember2</span><span class=p>(</span><span class=n>usernameParam</span><span class=p>,</span><span class=w> </span><span class=n>ageParam</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>size</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=nf>searchMember2</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>usernameCond</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>ageCond</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>usernameEq</span><span class=p>(</span><span class=n>usernameCond</span><span class=p>),</span><span class=w> </span><span class=n>ageEq</span><span class=p>(</span><span class=n>ageCond</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>BooleanExpression</span><span class=w> </span><span class=nf>usernameEq</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>usernameCond</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>usernameCond</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=n>usernameCond</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>BooleanExpression</span><span class=w> </span><span class=nf>ageEq</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>ageCond</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ageCond</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=n>ageCond</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>where 조건에 null은 무시되는 점을 이용하여 여러 조건을 메서드로 생성하여 동적 쿼리를 작성한다. 위 방법은 메서드를 다른 쿼리에서도 재활용할수 있고 메서드의 이름으로 쿼리 자체의 가독성이 높아진다.</p><p><strong>조합 가능</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>BooleanExpression</span><span class=w> </span><span class=nf>allEq</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>usernameCond</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>ageCond</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>usernameEq</span><span class=p>(</span><span class=n>usernameCond</span><span class=p>).</span><span class=na>and</span><span class=p>(</span><span class=n>ageEq</span><span class=p>(</span><span class=n>ageCond</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>두개의 조건을 조합하여 하나로 만들수도 있다.</p><p>파라미터 값의 null 체크는 주의 해서 처리해야 한다.</p><hr><h2 id=수정-삭제-벌크-연산>수정, 삭제 벌크 연산<a hidden class=anchor aria-hidden=true href=#수정-삭제-벌크-연산>#</a></h2><p><strong>쿼리 한번으로 대량의 데이터를 수정 해보자</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>bulkUpdate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w> </span><span class=s>&#34;비회원&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>lt</span><span class=p>(</span><span class=n>28</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>execute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>반환값은 변경된 row 수이다.</p><p>벌크 연산은 영속성 컨텍스트 말고 DB에 바로 쿼리가 나간다. 그래서 DB의 상태와 영속성 컨텍스트의 상태가 달라진다.</p><p>만약 데이터 수정 이후 meber의 값을 가져오는 코드를 실행하면 DB에 sql문을 실행해서 값을 가져오고 가져온 값을 영속성 컨텍스트에 저장하는데 PK값이 같은 것이 영속성 컨텍스트에 있으면 DB에서 가져온 값을 버리고 영속성 컨텍스트의 값을 유지한다.</p><p>이러한 문제를 해결하기 위해서는 벌크 연산 이후 아래 코드로 DB와 영속성 컨텍스트의 값을 맞춰준다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>em</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>em</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p><strong>기존 숫자에 1 더하기</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>bulkAdd</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>,</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>execute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>빼기 명령어는 없기때문에 값을 뺄때는 add(-1)처럼 작성하면된다.</p><p>곱하기는 multiply(x)를 사용하면 된다.</p><p><strong>쿼리 한번으로 대량 데이터 삭제</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>bulkDelete</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>delete</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>gt</span><span class=p>(</span><span class=n>18</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>execute</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><hr><h2 id=sql-function-호출하기>SQL function 호출하기<a hidden class=anchor aria-hidden=true href=#sql-function-호출하기>#</a></h2><p>SQL function은 JPA와 같이 Dialect에 등록된 내용만 호출이 가능하다.</p><p>member → M으로 변경하는 replace 함수를 사용해보자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sqlFunction</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>Expressions</span><span class=p>.</span><span class=na>stringTemplate</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;function(&#39;replace&#39;, {0}, {1}, {2})&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w> </span><span class=s>&#34;member&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;M&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;s = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>s</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과를 보면 jpql은 Expressions.stringTemplate에 작성한것과 동일하게 적용되고 sql문도 replace가 적용된것을 확인할수 있다.</p><p><img loading=lazy src=images/image%2013.png alt=image.png></p><p>result 출력 결과</p><p><img loading=lazy src=images/image%2014.png alt=image.png></p><p>소문자로 변경해서 비교해보자.</p><p>예제가 좋은 예제가 아니기 때문에 쿼리 문에 집중하자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sqlFunction2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Expressions</span><span class=p>.</span><span class=na>stringTemplate</span><span class=p>(</span><span class=s>&#34;function(&#39;lower&#39;, {0})&#34;</span><span class=p>,</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과를 확인해보면 lower function이 적용된것을 확인할수 있다.</p><p><img loading=lazy src=images/image%2015.png alt=image.png></p><p>lower 같은 ansi 표준 함수들은 querydsl이 상당부분 내장하고있기 대문에 다음과 같이 처리해도 결과는 동일하다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>lower</span><span class=p>()))</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://yosong6729.github.io/tags/querydsl/>Querydsl</a></li></ul><nav class=paginav><a class=next href=https://yosong6729.github.io/post/querydsl---%EA%B8%B0%EB%B3%B8-%EB%AC%B8%EB%B2%95/><span class=title>Next »</span><br><span>[Querydsl]기본 문법</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://yosong6729.github.io/>Yosong6729 Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>