<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>컬렉션 조회 최적화 | Yosong6729 Blog</title>
<meta name=keywords content="spring boot,JPA"><meta name=description content='해당 글은 김영한님의 인프런 강의 스프링부트와 JPA활용2 - API 개발과 성능 최적화을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
주문내역에서 추가로 주문한 상품 정보를 추가로 조회를 한다.
Order 기준으로 컬렉션인 OrderItem와 Item이 필요하다.
컬렉션인 일대다 관계(OneToMany)를 조회하고 최적화 하는 방법을 알아본다.
주문 조회 V1: 엔티티 직접노출 @RestController @RequiredArgsConstructor public class OrderApiController { private final OrderRepository orderRepository; /** * V1. 엔티티 직접 노출 * - Hibernate5Module 모듈 등록, LAZY=null 처리 * - 양방향 관계 문제 발생 -> @JsonIgnore */ @GetMapping("/api/v1/orders") public List<Order> ordersV1() { List<Order> all = orderRepository.'><meta name=author content="yosong6729"><link rel=canonical href=https://yosong6729.github.io/post/%EC%BB%AC%EB%A0%89%EC%85%98-%EC%A1%B0%ED%9A%8C-%EC%B5%9C%EC%A0%81%ED%99%94/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://yosong6729.github.io/post/%EC%BB%AC%EB%A0%89%EC%85%98-%EC%A1%B0%ED%9A%8C-%EC%B5%9C%EC%A0%81%ED%99%94/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="컬렉션 조회 최적화"><meta property="og:description" content='해당 글은 김영한님의 인프런 강의 스프링부트와 JPA활용2 - API 개발과 성능 최적화을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
주문내역에서 추가로 주문한 상품 정보를 추가로 조회를 한다.
Order 기준으로 컬렉션인 OrderItem와 Item이 필요하다.
컬렉션인 일대다 관계(OneToMany)를 조회하고 최적화 하는 방법을 알아본다.
주문 조회 V1: 엔티티 직접노출 @RestController @RequiredArgsConstructor public class OrderApiController { private final OrderRepository orderRepository; /** * V1. 엔티티 직접 노출 * - Hibernate5Module 모듈 등록, LAZY=null 처리 * - 양방향 관계 문제 발생 -> @JsonIgnore */ @GetMapping("/api/v1/orders") public List<Order> ordersV1() { List<Order> all = orderRepository.'><meta property="og:type" content="article"><meta property="og:url" content="https://yosong6729.github.io/post/%EC%BB%AC%EB%A0%89%EC%85%98-%EC%A1%B0%ED%9A%8C-%EC%B5%9C%EC%A0%81%ED%99%94/"><meta property="og:image" content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-09-25T20:34:54+09:00"><meta property="article:modified_time" content="2024-09-25T20:34:54+09:00"><meta property="og:site_name" content="Yosong6729 Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="컬렉션 조회 최적화"><meta name=twitter:description content='해당 글은 김영한님의 인프런 강의 스프링부트와 JPA활용2 - API 개발과 성능 최적화을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
주문내역에서 추가로 주문한 상품 정보를 추가로 조회를 한다.
Order 기준으로 컬렉션인 OrderItem와 Item이 필요하다.
컬렉션인 일대다 관계(OneToMany)를 조회하고 최적화 하는 방법을 알아본다.
주문 조회 V1: 엔티티 직접노출 @RestController @RequiredArgsConstructor public class OrderApiController { private final OrderRepository orderRepository; /** * V1. 엔티티 직접 노출 * - Hibernate5Module 모듈 등록, LAZY=null 처리 * - 양방향 관계 문제 발생 -> @JsonIgnore */ @GetMapping("/api/v1/orders") public List<Order> ordersV1() { List<Order> all = orderRepository.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yosong6729.github.io/post/"},{"@type":"ListItem","position":2,"name":"컬렉션 조회 최적화","item":"https://yosong6729.github.io/post/%EC%BB%AC%EB%A0%89%EC%85%98-%EC%A1%B0%ED%9A%8C-%EC%B5%9C%EC%A0%81%ED%99%94/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"컬렉션 조회 최적화","name":"컬렉션 조회 최적화","description":"해당 글은 김영한님의 인프런 강의 스프링부트와 JPA활용2 - API 개발과 성능 최적화을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\n주문내역에서 추가로 주문한 상품 정보를 추가로 조회를 한다.\nOrder 기준으로 컬렉션인 OrderItem와 Item이 필요하다.\n컬렉션인 일대다 관계(OneToMany)를 조회하고 최적화 하는 방법을 알아본다.\n주문 조회 V1: 엔티티 직접노출 @RestController @RequiredArgsConstructor public class OrderApiController { private final OrderRepository orderRepository; /** * V1. 엔티티 직접 노출 * - Hibernate5Module 모듈 등록, LAZY=null 처리 * - 양방향 관계 문제 발생 -\u0026gt; @JsonIgnore */ @GetMapping(\u0026#34;/api/v1/orders\u0026#34;) public List\u0026lt;Order\u0026gt; ordersV1() { List\u0026lt;Order\u0026gt; all = orderRepository.","keywords":["spring boot","JPA"],"articleBody":" 해당 글은 김영한님의 인프런 강의 스프링부트와 JPA활용2 - API 개발과 성능 최적화을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\n주문내역에서 추가로 주문한 상품 정보를 추가로 조회를 한다.\nOrder 기준으로 컬렉션인 OrderItem와 Item이 필요하다.\n컬렉션인 일대다 관계(OneToMany)를 조회하고 최적화 하는 방법을 알아본다.\n주문 조회 V1: 엔티티 직접노출 @RestController @RequiredArgsConstructor public class OrderApiController { private final OrderRepository orderRepository; /** * V1. 엔티티 직접 노출 * - Hibernate5Module 모듈 등록, LAZY=null 처리 * - 양방향 관계 문제 발생 -\u003e @JsonIgnore */ @GetMapping(\"/api/v1/orders\") public List\u003cOrder\u003e ordersV1() { List\u003cOrder\u003e all = orderRepository.findAllByString(new OrderSearch()); for (Order order : all) { order.getMember().getName(); //Lazy 강제 초기화 order.getDelivery().getAddress(); //Lazy 강제 초기화 List\u003cOrderItem\u003e orderItems = order.getOrderItems(); orderItems.stream().forEach(o -\u003e o.getItem().getName()); //Lazy 강제 초기화 } return all; } } Lazy 강제 초기화하면 Hibernate5module 설정에 의해 엔티티를 JSON으로 생성하고 양방향 연관관계면 무한루프가 걸리지 않게 한쪽에 @JsonIgnore을 추가해야 한다.\n위 방법은 엔티티를 직접 노출하므로 좋은 방법이 아니다.\n주문 조회 V2: 엔티티를 DTO로 변환 @GetMapping(\"/api/v2/orders\") public List\u003cOrderDto\u003e ordersV2() { List\u003cOrder\u003e orders = orderRepository.findAllByString(new OrderSearch()); List\u003cOrderDto\u003e result = orders.stream() .map(o -\u003e new OrderDto(o)) .collect(Collectors.toList()); return result; } OrderApiController에 추가\n@Data static class OrderDto { private Long orderId; private String name; private LocalDateTime orderDate; private OrderStatus orderStatus; private Address address; private List\u003cOrderItemDto\u003e orderItems; //엔티티 외부 노출 하면 안됨, OrderItemDto로 수정 public OrderDto(Order order) { orderId = order.getId(); name = order.getMember().getName(); orderDate = order.getOrderDate(); orderStatus = order.getStatus(); address = order.getDelivery().getAddress(); orderItems = order.getOrderItems().stream() .map(orderItem -\u003e new OrderItemDto(orderItem)) .collect(Collectors.toList()); } } @Getter static class OrderItemDto { private String itemName; //상품 명 private int orderPrice; //주문 가격 private int count; //주문 수량 public OrderItemDto(OrderItem orderItem) { itemName = orderItem.getItem().getName(); orderPrice = orderItem.getOrderPrice(); count = orderItem.getCount(); } } 지연로딩으로 많은 SQL 실행 SQL 실행수 order 1번 member, address N번 orderItem N번 item N번 주문 조회 V3: 엔티티를 DTO로 변환 - 페치 조인 최적화 OrderApiController에 추가\n@GetMapping(\"/api/v3/orders\") public List\u003cOrderDto\u003e ordersV3() { List\u003cOrder\u003e orders = orderRepository.findAllWithItem(); List\u003cOrderDto\u003e result = orders.stream() .map(o -\u003e new OrderDto(o)) .collect(Collectors.toList()); return result; } OrderRepository에 추가\npublic List\u003cOrder\u003e findAllWithItem() { return em.createQuery( \"select distinct o from Order o\" + \" join fetch o.member m\" + \" join fetch o.delivery d\" + \" join fetch o.orderItems oi\" + \" join fetch oi.item i\", Order.class) .getResultList(); } 스프링 부트 3버전대, 정확히는 하이버네이트 6버전을 사용하시면서 자동으로 distinct가 적용\n페치 조인으로 SQL 1번 실행\norderItems로 인해 일대다 조인이 되서 데이터베이스 row가 증가해서 order 엔티티 수도 증가하낟. JPA의 distinct는 SQL에 distinct를 추가하고, 같은 엔티티가 조회되면 애플리케이션에서 중복을 걸러준다.\n단점\n페이징 불가능(메모리에서 페이징 실행) 컬렉션 페치 조인을 사용하면 페이징이 불가능하다. 하이버네이트는 경고 로그를 남기면서 모든 데이터를 DB에서 읽어오고, 메모리에서 페이징 해버린다(매우 위험하다)\n컬렉션 페치 조인은 1개만 사용할 수 있다. 컬렉션 둘 이상에 페치 조인을 사용하면 안된다. 데이터가 부정합하게 조회될 수 있다.\n주문 조회 V3.1: 엔티티를 DTO로 변환 - 페이징과 한계 돌파 한계 돌파 페이징과 컬렉션 엔티티를 함께 조회하려면 어떻게 해야하나?\n먼저 ToOne 관계를 모두 페치조인 한다. ToOne 관계는 row수를 증가시키지않아 페이징 쿼리에 영향X 컬렉션은 지연로딩으로 조회 지연 로딩 성능 최적화를 위해 hibernate.default_batch_fetch_size(글로벌 설정), @BatchSize(개별 최적화)를 적용한다. 이 옵션을 사용하면 컬렉션이나, 프록시 객체를 한꺼번에 설정한 size 만큼 IN 쿼리로 조회 OrderRepository에 추가\npublic List\u003cOrder\u003e findAllWithMemberDelivery(int offset, int limit) { return em.createQuery( \"select o from Order o\" + \" join fetch o.member m\" + \" join fetch o.delivery d\", Order.class ).setFirstResult(offset) .setMaxResults(limit) .getResultList(); } OrderApiController에 추가\n@GetMapping(\"/api/v3.1/orders\") public List\u003cOrderDto\u003e ordersV3_page( @RequestParam(value = \"offset\", defaultValue = \"0\") int offset, @RequestParam(value = \"limit\", defaultValue = \"100\") int limit) { List\u003cOrder\u003e orders = orderRepository.findAllWithMemberDelivery(offset, limit); List\u003cOrderDto\u003e result = orders.stream() .map(o -\u003e new OrderDto(o)) .collect(Collectors.toList()); return result; } 최적화 옵션\nspring: jpa: properties: hibernate: default_batch_fetch_size: 1000 개별로 설정하려면 컬렉션은 컬렉션 필드에, 엔티티는 엔티티 클래스에 @BatchSize를 적용하면 된다.\n@GetMapping(\"/api/v3.1/orders\")가 실행되면 아래처럼 쿼리가 나간다.\n?가 배치사이즈 만큼 채워지는건 배치 사이즈 만큼 ?토큰이 다 채워진 쿼리를 재사용는거 같기 때문이다.\nselect oi1_0.order_id, oi1_0.order_item_id, oi1_0.count, oi1_0.item_id, oi1_0.order_price from order_item oi1_0 where oi1_0.order_id in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ....) 장점 쿼리 호출 수가 1 + N → 1 + 1로 최적화 조인보다 DB 데이터 전송량이 최적화(Order와 OrderItem을 조인하면 Order가 OrderItem 만큼 중복해서 조회된다. 이 방법은 각각 조회하므로 전송해야할 중복 데이터가 없다.) 페치 조인 방식과 비교해서 쿼리 호출 수가 약간 증가하지만, DB 데이터 전송량이 감소 컬렉션 페치 조인은 페이징이 불가능 하지만 이 방법은 페이징이 가능 결론 ToOne 관계는 페치 조인해도 페이징에 영향X, 따라서 ToOne 관계는 페치조인으로 쿼리수 감소하고, 나머지는 hibernate.default_batch_fetch_size 로 최적화 참고:default_batch_fetch_size의 크기는 적당한 사이즈를 골라야 하는데, 100~1000 사이를 선택하는 것을 권장한다. 이 전략을 SQL IN 절을 사용하는데, 데이터베이스에 따라 IN 절 파라미터를 1000으로 제한하기도 한다. 1000으로 잡으면 한번에 1000개를 DB에서 애플리케이션에 불러오므로 DB에 순간 부하가 증가할 수 있다. 하지만 애플리케이션은 100이든 1000이든 결국 전체 데이터를 로딩해야 하므로 메모리 사용량이 같다. 1000으로 설정하는 것이 성능상 가장 좋지만, 결국 DB든 애플리케이션이든 순간 부하를 어디까지 견딜 수 있는지로 결정하면 된다.\n주문 조회 V4: JPA에서 DTO 직접 조회 OrderApiController에 추가\n@GetMapping(\"/api/v4/orders\") public List\u003cOrderQueryDto\u003e ordersV4(){ return orderQueryRepository.findOrderQueryDtos(); } OrderQueryRepository\n@Repository @RequiredArgsConstructor public class OrderQueryRepository { private final EntityManager em; public List\u003cOrderQueryDto\u003e findOrderQueryDtos() { //루트 조회(toOne 코드를 모두 한번에 조회) List\u003cOrderQueryDto\u003e result = findOrders(); //루프를 돌면서 컬렉션 추가(추가 쿼리 실행) result.forEach(o -\u003e{ List\u003cOrderItemQueryDto\u003e orderItems = findOrderItems(o.getOrderId()); o.setOrderItems(orderItems); }); return result; } //1:N 관계인 orderItems 조회 private List\u003cOrderItemQueryDto\u003e findOrderItems(Long orderId) { return em.createQuery( \"select new jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name, oi.orderPrice, oi.count)\" + \" from OrderItem oi\" + \" join oi.item i\" + \" where oi.order.id =: orderId\", OrderItemQueryDto.class) .setParameter(\"orderId\", orderId) .getResultList(); } //1:N 관계(컬렉션)을 제외한 나머지 조회 private List\u003cOrderQueryDto\u003e findOrders() { return em.createQuery( \"select new jpabook.jpashop.repository.order.query.OrderQueryDto(o.id, m.name, o.orderDate, o.status, d.address)\" + \" from Order o\" + \" join o.member m\" + \" join o.delivery d\", OrderQueryDto.class ).getResultList(); } } OrderQueryDto\n@Data public class OrderQueryDto { private Long orderId; private String name; private LocalDateTime orderDate; private OrderStatus orderStatus; private Address address; private List\u003cOrderItemQueryDto\u003e orderItems; public OrderQueryDto(Long orderId, String name, LocalDateTime orderDate, OrderStatus orderStatus, Address address) { this.orderId = orderId; this.name = name; this.orderDate = orderDate; this.orderStatus = orderStatus; this.address = address; } } OrderItemQueryDto\n@Data public class OrderItemQueryDto { @JsonIgnore private Long orderId; private String itemName; private int orderPrice; private int count; public OrderItemQueryDto(Long orderId, String itemName, int orderPrice, int count) { this.orderId = orderId; this.itemName = itemName; this.orderPrice = orderPrice; this.count = count; } } 쿼리: 루트 1번, 컬렉션 N번 xToOne 관계들을 먼저 조회, xToMany 관계는 각각 별도로 처리 위 방식을 선택한이유 xToOne 관계는 조인해도 데이터 row수 증가X xToMany 관계는 조인하면 row수 증가 row수가 증가하지 않는 ToONe 관계는 조인으로 최적화 하기 쉽기때문에 한번에 조회하고, ToMany 관계는 최적화가 어렵기때문에 findOrderItems()같은 별도의 메서드로 조회 주문 조회 V5: JPA에서 DTO 직접 조회 - 컬렉션 조회 최적화 OrderApiController에 추가\n@GetMapping(\"/api/v5/orders\") public List\u003cOrderQueryDto\u003e ordersV5(){ return orderQueryRepository.findAllByDto_optimization(); } OrderQueryRepositoy에 추가\npublic List\u003cOrderQueryDto\u003e findAllByDto_optimization() { //루트 조회(toOne 코드를 모두 한번에 조회) List\u003cOrderQueryDto\u003e result = findOrders(); //orderItem 컬렉션을 MAP 한방에 조회 Map\u003cLong, List\u003cOrderItemQueryDto\u003e\u003e orderItemMap = findOrderItemMap(toOrderIds(result)); //루프를 돌면서 컬렉션 추가(추가 쿼리 실행X) result.forEach(o -\u003e o.setOrderItems(orderItemMap.get(o.getOrderId()))); return result; } private List\u003cLong\u003e toOrderIds(List\u003cOrderQueryDto\u003e result) { List\u003cLong\u003e orderIds = result.stream() .map(o -\u003e o.getOrderId()) .collect(Collectors.toList()); return orderIds; } private Map\u003cLong, List\u003cOrderItemQueryDto\u003e\u003e findOrderItemMap(List\u003cLong\u003e orderIds) { List\u003cOrderItemQueryDto\u003e orderItems = em.createQuery( \"select new jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name, oi.orderPrice, oi.count)\" + \" from OrderItem oi\" + \" join oi.item i\" + \" where oi.order.id in : orderIds\", OrderItemQueryDto.class) .setParameter(\"orderIds\", orderIds) .getResultList(); Map\u003cLong, List\u003cOrderItemQueryDto\u003e\u003e orderItemMap = orderItems.stream() .collect(Collectors.groupingBy(orderItemQueryDto -\u003e orderItemQueryDto.getOrderId())); return orderItemMap; } where … in 을 이용해서 쿼리를 한번 보내게 한다. 그 반환 값인 orderItems를 Map 형식으로 바꾸어 orderItemMap을 반환한다. 반환 받은 orderItemMap을 루프를 돌면서 컬렉션을 추가한다.\nQuery: 루트 1번, 컬렉션 1번 ToOne 관계들을 먼저 조회 후, 얻은 식별자 orderId로 ToMany 관계인 OrderItem을 한꺼뻔에 조회 MAP을 사용해서 매칭 성능 향상(O(1)) 주문 조회 V6: JPA에서 DTO로 직접 조회, 플랫 데이터 최적화 OrderApiController에 추가\n@GetMapping(\"/api/v6/orders\") public List\u003cOrderQueryDto\u003e ordersV6(){ List\u003cOrderFlatDto\u003e flats = orderQueryRepository.findAllByDto_flat(); //flats를 OrderQueryDto 관련된것과 OrderItemQueryDto와 관련된것을 각각 알맞게 생성해서 map으로 OrderQueryDto를 만든다. //groupBy할때 뭐를 기준으로 묶을지 알려줘야하기때문에 OrderQueryDto에 @EqualAndHashCode 추가 return flats.stream() .collect(groupingBy(o -\u003e new OrderQueryDto(o.getOrderId(), o.getName(), o.getOrderDate(), o.getOrderStatus(), o.getAddress()), mapping(o -\u003e new OrderItemQueryDto(o.getOrderId(), o.getItemName(), o.getOrderPrice(), o.getCount()), toList()) )).entrySet().stream() .map(e -\u003e new OrderQueryDto(e.getKey().getOrderId(), e.getKey().getName(), e.getKey().getOrderDate(), e.getKey().getOrderStatus(), e.getKey().getAddress(), e.getValue())) .collect(toList()); } OrderQueryDto에 생성자 추가\npublic OrderQueryDto(Long orderId, String name, LocalDateTime orderDate, OrderStatus orderStatus, Address address, List\u003cOrderItemQueryDto\u003e orderItems) { this.orderId = orderId; this.name = name; this.orderDate = orderDate; this.orderStatus = orderStatus; this.address = address; this.orderItems = orderItems; } 컬렉션(orderItems)을 생성자로 주입받는다.\nOrderQueryRepository에 추가\npublic List\u003cOrderFlatDto\u003e findAllByDto_flat() { return em.createQuery( \"select new jpabook.jpashop.repository.order.query.OrderFlatDto(o.id, m.name, o.orderDate, o.status, d.address, i.name, oi.orderPrice, oi.count)\" + \" from Order o\" + \" join o.member m\" + \" join o.delivery d\" + \" join o.orderItems oi\" + \" join oi.item i\", OrderFlatDto.class) .getResultList(); } OrderFlatDto\n@Data public class OrderFlatDto { private Long orderId; private String name; private LocalDateTime orderDate; private OrderStatus orderStatus; private Address address; private String itemName; private int orderPrice; private int count; public OrderFlatDto(Long orderId, String name, LocalDateTime orderDate, OrderStatus orderStatus, Address address, String itemName, int orderPrice, int count) { this.orderId = orderId; this.name = name; this.orderDate = orderDate; this.orderStatus = orderStatus; this.address = address; this.itemName = itemName; this.orderPrice = orderPrice; this.count = count; } } 장점 쿼리 1번 단점 쿼리는 한번이지만 조인으로 인해 DB에서 애플리케이션에 전달하는 데이터에 중복 데이터가 추가되므로 상황에 따라 V5 보다 더 느릴 수 도 있다. DTO에 맞게 애플리케이션에서 추가 작업이 많다. 페이징 불가능 정리 엔티티 조회 V1: 엔티티를 조회해서 그대로 반환 V2: 엔티티 조회 후 DTO로 반환 V3: 페치 조인으로 쿼리 수 최적화 V3.1: 컬렉션 페이징과 한계 돌파 컬렉션은 페치 조인시 페이징 불가능 ToOne 관계는 페치 조인으로 쿼리수 최적화 컬렉션은 페치 조인 대신 지연 로딩으로 유지, hibernate.default_batch_fetch_size , @BatchSize 로 최적화 DTO 직접 조회 V4: JPA에서 DTO를 직접조회 V5: 컬렉션 조회 최적화 - 일대다 관계인 컬렉션은 IN절을 활용해서 메모리에 미리 조회해서 최적화 V6: 플랫 데이터 최적화 - JOIN 결과를 그대로 조회 후 애플리케이션에서 원하는 모양으로 직접 변환 권장 순서\n엔티티 조회 방식으로 우선 접근 페치 조인으로 쿼리 수 최적화 컬렉션 최적화 페이징 필요 → hibernate.default_batch_fetch_size , @BatchSize 로 최적화 페이징 필요X → 페치 조인 사용 엔티티 조회 방식으로 해결안되면 DTO 조회 방식 사용 DTO 조회 방식도 안되면 NativeSQL or 스프링 JdbcTemplate 사용 엔티티 조회 방식은 페치 조인이나, hibernate.default_batch_fetch_size, @BatchSize 같이 코드를 거의 수정하지 않고, 옵션만 약간 변경해서, 다양한 성능 최적화를 시도할 수 있다. 반면에 DTO를 직접 조회하는 방식은 성능을 최적화 하거나 성능 최적화 방식을 변경할 때 많은 코드를 변경해야 한다.\nDTO 조회 방식의 선택지\nDTO로 조회 하는 방법도 각각 장단점이 있다. V4, V5, V6에서 단순하게 쿼리 1번 실행된다고 V6가 항상 좋은 방법은 아니다.\nV4는 코드가 단순하고 단건조회에서 성능이 잘나온다. V5는 코드가 복잡하지만 여러 주문을 한꺼번에 조회할때는 V4대신 V5 방식을 사용해야 한다. 쿼리의 수를 많이 줄여줄수있고 상황에 따라 다르겠지만 운영 환경에서 100배 이상의 성능 차이가 날수 있다. V6는 쿼리 한번으로 최적화 되서 좋을수 있지만, Order를 기준으로 페이징이 불가능하다. 실무에서는 많은 양의 데이터가 페이징 처리가 필요하기때문에 이 경우는 선택하기 어렵다. 그리고 데이터가 많으면 중복 저송이 증가해 V5와 성능차이도 미비하다. ","wordCount":"1735","inLanguage":"en","image":"https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-09-25T20:34:54+09:00","dateModified":"2024-09-25T20:34:54+09:00","author":{"@type":"Person","name":"yosong6729"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yosong6729.github.io/post/%EC%BB%AC%EB%A0%89%EC%85%98-%EC%A1%B0%ED%9A%8C-%EC%B5%9C%EC%A0%81%ED%99%94/"},"publisher":{"@type":"Organization","name":"Yosong6729 Blog","logo":{"@type":"ImageObject","url":"https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yosong6729.github.io/ accesskey=h title="Yosong6729 블로그 (Alt + H)"><img src=https://yosong6729.github.io/apple-touch-icon.png alt aria-label=logo height=35>Yosong6729 블로그</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yosong6729.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://yosong6729.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yosong6729.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yosong6729.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">컬렉션 조회 최적화</h1><div class=post-meta><span title='2024-09-25 20:34:54 +0900 KST'>September 25, 2024</span>&nbsp;·&nbsp;yosong6729&nbsp;|&nbsp;<a href=https://github.com/yosong6729/blog/tree/main/content/post/%ec%bb%ac%eb%a0%89%ec%85%98%20%ec%a1%b0%ed%9a%8c%20%ec%b5%9c%ec%a0%81%ed%99%94/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v1-%ec%97%94%ed%8b%b0%ed%8b%b0-%ec%a7%81%ec%a0%91%eb%85%b8%ec%b6%9c aria-label="주문 조회 V1: 엔티티 직접노출">주문 조회 V1: 엔티티 직접노출</a></li><li><a href=#%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v2-%ec%97%94%ed%8b%b0%ed%8b%b0%eb%a5%bc-dto%eb%a1%9c-%eb%b3%80%ed%99%98 aria-label="주문 조회 V2: 엔티티를 DTO로 변환">주문 조회 V2: 엔티티를 DTO로 변환</a></li><li><a href=#%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v3-%ec%97%94%ed%8b%b0%ed%8b%b0%eb%a5%bc-dto%eb%a1%9c-%eb%b3%80%ed%99%98---%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8-%ec%b5%9c%ec%a0%81%ed%99%94 aria-label="주문 조회 V3: 엔티티를 DTO로 변환 - 페치 조인 최적화">주문 조회 V3: 엔티티를 DTO로 변환 - 페치 조인 최적화</a></li><li><a href=#%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v31-%ec%97%94%ed%8b%b0%ed%8b%b0%eb%a5%bc-dto%eb%a1%9c-%eb%b3%80%ed%99%98---%ed%8e%98%ec%9d%b4%ec%a7%95%ea%b3%bc-%ed%95%9c%ea%b3%84-%eb%8f%8c%ed%8c%8c aria-label="주문 조회 V3.1: 엔티티를 DTO로 변환 - 페이징과 한계 돌파">주문 조회 V3.1: 엔티티를 DTO로 변환 - 페이징과 한계 돌파</a><ul><li><a href=#%ed%95%9c%ea%b3%84-%eb%8f%8c%ed%8c%8c aria-label="한계 돌파">한계 돌파</a></li></ul></li><li><a href=#%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v4-jpa%ec%97%90%ec%84%9c-dto-%ec%a7%81%ec%a0%91-%ec%a1%b0%ed%9a%8c aria-label="주문 조회 V4: JPA에서 DTO 직접 조회">주문 조회 V4: JPA에서 DTO 직접 조회</a></li><li><a href=#%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v5-jpa%ec%97%90%ec%84%9c-dto-%ec%a7%81%ec%a0%91-%ec%a1%b0%ed%9a%8c---%ec%bb%ac%eb%a0%89%ec%85%98-%ec%a1%b0%ed%9a%8c-%ec%b5%9c%ec%a0%81%ed%99%94 aria-label="주문 조회 V5: JPA에서 DTO 직접 조회 - 컬렉션 조회 최적화">주문 조회 V5: JPA에서 DTO 직접 조회 - 컬렉션 조회 최적화</a></li><li><a href=#%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v6-jpa%ec%97%90%ec%84%9c-dto%eb%a1%9c-%ec%a7%81%ec%a0%91-%ec%a1%b0%ed%9a%8c-%ed%94%8c%eb%9e%ab-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ec%b5%9c%ec%a0%81%ed%99%94 aria-label="주문 조회 V6: JPA에서 DTO로 직접 조회, 플랫 데이터 최적화">주문 조회 V6: JPA에서 DTO로 직접 조회, 플랫 데이터 최적화</a></li><li><a href=#%ec%a0%95%eb%a6%ac aria-label=정리>정리</a></li></ul></div></details></div><div class=post-content><blockquote><p>해당 글은 김영한님의 인프런 강의 <a href=https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-JPA-API%EA%B0%9C%EB%B0%9C-%EC%84%B1%EB%8A%A5%EC%B5%9C%EC%A0%81%ED%99%94>스프링부트와 JPA활용2 - API 개발과 성능 최적화</a>을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.</p></blockquote><hr><p>주문내역에서 추가로 주문한 상품 정보를 추가로 조회를 한다.</p><p>Order 기준으로 컬렉션인 OrderItem와 Item이 필요하다.</p><p>컬렉션인 일대다 관계(OneToMany)를 조회하고 최적화 하는 방법을 알아본다.</p><h2 id=주문-조회-v1-엔티티-직접노출>주문 조회 V1: 엔티티 직접노출<a hidden class=anchor aria-hidden=true href=#주문-조회-v1-엔티티-직접노출>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderApiController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>OrderRepository</span><span class=w> </span><span class=n>orderRepository</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * V1. 엔티티 직접 노출
</span></span></span><span class=line><span class=cl><span class=cm>     * - Hibernate5Module 모듈 등록, LAZY=null 처리
</span></span></span><span class=line><span class=cl><span class=cm>     * - 양방향 관계 문제 발생 -&gt; @JsonIgnore
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v1/orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=n>all</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderRepository</span><span class=p>.</span><span class=na>findAllByString</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>OrderSearch</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>all</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>order</span><span class=p>.</span><span class=na>getMember</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w> </span><span class=c1>//Lazy 강제 초기화</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>order</span><span class=p>.</span><span class=na>getDelivery</span><span class=p>().</span><span class=na>getAddress</span><span class=p>();</span><span class=w> </span><span class=c1>//Lazy 강제 초기화</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderItem</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderItems</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getOrderItems</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orderItems</span><span class=p>.</span><span class=na>stream</span><span class=p>().</span><span class=na>forEach</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=na>getItem</span><span class=p>().</span><span class=na>getName</span><span class=p>());</span><span class=w> </span><span class=c1>//Lazy 강제 초기화</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>all</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Lazy 강제 초기화하면 Hibernate5module 설정에 의해 엔티티를 JSON으로 생성하고 양방향 연관관계면 무한루프가 걸리지 않게 한쪽에 @JsonIgnore을 추가해야 한다.</p><p>위 방법은 엔티티를 직접 노출하므로 좋은 방법이 아니다.</p><hr><h2 id=주문-조회-v2-엔티티를-dto로-변환>주문 조회 V2: 엔티티를 DTO로 변환<a hidden class=anchor aria-hidden=true href=#주문-조회-v2-엔티티를-dto로-변환>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v2/orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderRepository</span><span class=p>.</span><span class=na>findAllByString</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>OrderSearch</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orders</span><span class=p>.</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderDto</span><span class=p>(</span><span class=n>o</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>toList</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>OrderApiController에 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>orderDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderStatus</span><span class=w> </span><span class=n>orderStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Address</span><span class=w> </span><span class=n>address</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderItemDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderItems</span><span class=p>;</span><span class=w> </span><span class=c1>//엔티티 외부 노출 하면 안됨, OrderItemDto로 수정</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>OrderDto</span><span class=p>(</span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getMember</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderDate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getOrderDate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getStatus</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getDelivery</span><span class=p>().</span><span class=na>getAddress</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderItems</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getOrderItems</span><span class=p>().</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>orderItem</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderItemDto</span><span class=p>(</span><span class=n>orderItem</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>toList</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Getter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderItemDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>itemName</span><span class=p>;</span><span class=w> </span><span class=c1>//상품 명</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>orderPrice</span><span class=p>;</span><span class=w> </span><span class=c1>//주문 가격</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w> </span><span class=c1>//주문 수량</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>OrderItemDto</span><span class=p>(</span><span class=n>OrderItem</span><span class=w> </span><span class=n>orderItem</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>itemName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderItem</span><span class=p>.</span><span class=na>getItem</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderItem</span><span class=p>.</span><span class=na>getOrderPrice</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderItem</span><span class=p>.</span><span class=na>getCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>지연로딩으로 많은 SQL 실행</li><li>SQL 실행수<ul><li>order 1번</li><li>member, address N번</li><li>orderItem N번</li><li>item N번</li></ul></li></ul><hr><h2 id=주문-조회-v3-엔티티를-dto로-변환---페치-조인-최적화>주문 조회 V3: 엔티티를 DTO로 변환 - 페치 조인 최적화<a hidden class=anchor aria-hidden=true href=#주문-조회-v3-엔티티를-dto로-변환---페치-조인-최적화>#</a></h2><p>OrderApiController에 추가</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v3/orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV3</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderRepository</span><span class=p>.</span><span class=na>findAllWithItem</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orders</span><span class=p>.</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderDto</span><span class=p>(</span><span class=n>o</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>toList</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>OrderRepository에 추가</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findAllWithItem</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;select distinct o from Order o&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34; join fetch o.member m&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34; join fetch o.delivery d&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34; join fetch o.orderItems oi&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34; join fetch oi.item i&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Order</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>스프링 부트 3버전대, 정확히는 하이버네이트 6버전을 사용하시면서 자동으로 distinct가 적용</p></blockquote><ul><li><p>페치 조인으로 SQL 1번 실행</p></li><li><p>orderItems로 인해 일대다 조인이 되서 데이터베이스 row가 증가해서 order 엔티티 수도 증가하낟. JPA의 distinct는 SQL에 distinct를 추가하고, 같은 엔티티가 조회되면 애플리케이션에서 중복을 걸러준다.</p></li><li><p>단점</p><ul><li><strong>페이징 불가능</strong>(메모리에서 페이징 실행)</li></ul><blockquote><p>컬렉션 페치 조인을 사용하면 페이징이 불가능하다. 하이버네이트는 경고 로그를 남기면서 모든 데이터를 DB에서 읽어오고, 메모리에서 페이징 해버린다(매우 위험하다)</p></blockquote></li></ul><blockquote><p>컬렉션 페치 조인은 1개만 사용할 수 있다. 컬렉션 둘 이상에 페치 조인을 사용하면 안된다. 데이터가 부정합하게 조회될 수 있다.</p></blockquote><hr><h2 id=주문-조회-v31-엔티티를-dto로-변환---페이징과-한계-돌파>주문 조회 V3.1: 엔티티를 DTO로 변환 - 페이징과 한계 돌파<a hidden class=anchor aria-hidden=true href=#주문-조회-v31-엔티티를-dto로-변환---페이징과-한계-돌파>#</a></h2><h3 id=한계-돌파>한계 돌파<a hidden class=anchor aria-hidden=true href=#한계-돌파>#</a></h3><p>페이징과 컬렉션 엔티티를 함께 조회하려면 어떻게 해야하나?</p><ul><li>먼저 ToOne 관계를 모두 페치조인 한다. ToOne 관계는 row수를 증가시키지않아 페이징 쿼리에 영향X</li><li>컬렉션은 지연로딩으로 조회</li><li>지연 로딩 성능 최적화를 위해 <code>hibernate.default_batch_fetch_size(글로벌 설정)</code>, <code>@BatchSize(개별 최적화)</code>를 적용한다.<ul><li>이 옵션을 사용하면 컬렉션이나, 프록시 객체를 한꺼번에 설정한 size 만큼 IN 쿼리로 조회</li></ul></li></ul><p><strong>OrderRepository에 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findAllWithMemberDelivery</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>limit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;select o from Order o&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34; join fetch o.member m&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34; join fetch o.delivery d&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Order</span><span class=p>.</span><span class=na>class</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>).</span><span class=na>setFirstResult</span><span class=p>(</span><span class=n>offset</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>setMaxResults</span><span class=p>(</span><span class=n>limit</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>OrderApiController에 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v3.1/orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV3_page</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@RequestParam</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;offset&#34;</span><span class=p>,</span><span class=w> </span><span class=n>defaultValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;0&#34;</span><span class=p>)</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@RequestParam</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;limit&#34;</span><span class=p>,</span><span class=w> </span><span class=n>defaultValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;100&#34;</span><span class=p>)</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>limit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderRepository</span><span class=p>.</span><span class=na>findAllWithMemberDelivery</span><span class=p>(</span><span class=n>offset</span><span class=p>,</span><span class=w> </span><span class=n>limit</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orders</span><span class=p>.</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderDto</span><span class=p>(</span><span class=n>o</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>toList</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>최적화 옵션</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nt>jpa</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nt>properties</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nt>hibernate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nt>default_batch_fetch_size</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span></span></span></code></pre></div><p>개별로 설정하려면 컬렉션은 컬렉션 필드에, 엔티티는 엔티티 클래스에 <code>@BatchSize</code>를 적용하면 된다.</p><p>@GetMapping("/api/v3.1/orders")가 실행되면 아래처럼 쿼리가 나간다.</p><p>?가 배치사이즈 만큼 채워지는건 배치 사이즈 만큼 ?토큰이 다 채워진 쿼리를 재사용는거 같기 때문이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>oi1_0</span><span class=p>.</span><span class=n>order_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>oi1_0</span><span class=p>.</span><span class=n>order_item_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>oi1_0</span><span class=p>.</span><span class=k>count</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>oi1_0</span><span class=p>.</span><span class=n>item_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>oi1_0</span><span class=p>.</span><span class=n>order_price</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>order_item</span><span class=w> </span><span class=n>oi1_0</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>oi1_0</span><span class=p>.</span><span class=n>order_id</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=p>(</span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=p>....)</span><span class=w>
</span></span></span></code></pre></div><ul><li>장점<ul><li>쿼리 호출 수가 1 + N → 1 + 1로 최적화</li><li>조인보다 DB 데이터 전송량이 최적화(Order와 OrderItem을 조인하면 Order가 OrderItem 만큼 중복해서 조회된다. 이 방법은 각각 조회하므로 전송해야할 중복 데이터가 없다.)</li><li>페치 조인 방식과 비교해서 쿼리 호출 수가 약간 증가하지만, DB 데이터 전송량이 감소</li><li><strong>컬렉션 페치 조인은 페이징이 불가능 하지만 이 방법은 페이징이 가능</strong></li></ul></li><li>결론<ul><li>ToOne 관계는 페치 조인해도 페이징에 영향X, 따라서 ToOne 관계는 페치조인으로 쿼리수 감소하고, 나머지는 <code>hibernate.default_batch_fetch_size</code> 로 최적화</li></ul></li></ul><blockquote><p>참고:<code>default_batch_fetch_size</code>의 크기는 적당한 사이즈를 골라야 하는데, 100~1000 사이를 선택하는 것을 권장한다. 이 전략을 SQL IN 절을 사용하는데, 데이터베이스에 따라 IN 절 파라미터를 1000으로 제한하기도 한다. 1000으로 잡으면 한번에 1000개를 DB에서 애플리케이션에 불러오므로 DB에 순간 부하가 증가할 수 있다. 하지만 애플리케이션은 100이든 1000이든 결국 전체 데이터를 로딩해야 하므로 메모리 사용량이 같다. 1000으로 설정하는 것이 성능상 가장 좋지만, 결국 DB든 애플리케이션이든 순간 부하를 어디까지 견딜 수 있는지로 결정하면 된다.</p></blockquote><hr><h2 id=주문-조회-v4-jpa에서-dto-직접-조회>주문 조회 V4: JPA에서 DTO 직접 조회<a hidden class=anchor aria-hidden=true href=#주문-조회-v4-jpa에서-dto-직접-조회>#</a></h2><p><strong>OrderApiController에 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v4/orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV4</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>orderQueryRepository</span><span class=p>.</span><span class=na>findOrderQueryDtos</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>OrderQueryRepository</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Repository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderQueryRepository</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>EntityManager</span><span class=w> </span><span class=n>em</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findOrderQueryDtos</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		    </span><span class=c1>//루트 조회(toOne 코드를 모두 한번에 조회)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findOrders</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>//루프를 돌면서 컬렉션 추가(추가 쿼리 실행)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>result</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderItemQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderItems</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findOrderItems</span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>o</span><span class=p>.</span><span class=na>setOrderItems</span><span class=p>(</span><span class=n>orderItems</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//1:N 관계인 orderItems 조회</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderItemQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findOrderItems</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;select new jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name, oi.orderPrice, oi.count)&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34; from OrderItem oi&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34; join oi.item i&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34; where oi.order.id =: orderId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>OrderItemQueryDto</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setParameter</span><span class=p>(</span><span class=s>&#34;orderId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>orderId</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//1:N 관계(컬렉션)을 제외한 나머지 조회</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findOrders</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=s>&#34;select new jpabook.jpashop.repository.order.query.OrderQueryDto(o.id, m.name, o.orderDate, o.status, d.address)&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34; from Order o&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34; join o.member m&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34; join o.delivery d&#34;</span><span class=p>,</span><span class=w> </span><span class=n>OrderQueryDto</span><span class=p>.</span><span class=na>class</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>).</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>OrderQueryDto</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderQueryDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>orderDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderStatus</span><span class=w> </span><span class=n>orderStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Address</span><span class=w> </span><span class=n>address</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderItemQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderItems</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>OrderQueryDto</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>orderDate</span><span class=p>,</span><span class=w> </span><span class=n>OrderStatus</span><span class=w> </span><span class=n>orderStatus</span><span class=p>,</span><span class=w> </span><span class=n>Address</span><span class=w> </span><span class=n>address</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderDate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>address</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>OrderItemQueryDto</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderItemQueryDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@JsonIgnore</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>itemName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>orderPrice</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>OrderItemQueryDto</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>itemName</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>orderPrice</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>itemName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>itemName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderPrice</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>쿼리: 루트 1번, 컬렉션 N번</li><li>xToOne 관계들을 먼저 조회, xToMany 관계는 각각 별도로 처리</li><li>위 방식을 선택한이유<ul><li>xToOne 관계는 조인해도 데이터 row수 증가X</li><li>xToMany 관계는 조인하면 row수 증가</li></ul></li><li>row수가 증가하지 않는 ToONe 관계는 조인으로 최적화 하기 쉽기때문에 한번에 조회하고, ToMany 관계는 최적화가 어렵기때문에 findOrderItems()같은 별도의 메서드로 조회</li></ul><hr><h2 id=주문-조회-v5-jpa에서-dto-직접-조회---컬렉션-조회-최적화>주문 조회 V5: JPA에서 DTO 직접 조회 - 컬렉션 조회 최적화<a hidden class=anchor aria-hidden=true href=#주문-조회-v5-jpa에서-dto-직접-조회---컬렉션-조회-최적화>#</a></h2><p><strong>OrderApiController에 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v5/orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV5</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>orderQueryRepository</span><span class=p>.</span><span class=na>findAllByDto_optimization</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>OrderQueryRepositoy에 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findAllByDto_optimization</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//루트 조회(toOne 코드를 모두 한번에 조회)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findOrders</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//orderItem 컬렉션을 MAP 한방에 조회</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderItemQueryDto</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>orderItemMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findOrderItemMap</span><span class=p>(</span><span class=n>toOrderIds</span><span class=p>(</span><span class=n>result</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=c1>//루프를 돌면서 컬렉션 추가(추가 쿼리 실행X)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>result</span><span class=p>.</span><span class=na>forEach</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=na>setOrderItems</span><span class=p>(</span><span class=n>orderItemMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>())));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=nf>toOrderIds</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderIds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>toList</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>orderIds</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderItemQueryDto</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>findOrderItemMap</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderIds</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderItemQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderItems</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34;select new jpabook.jpashop.repository.order.query.OrderItemQueryDto(oi.order.id, i.name, oi.orderPrice, oi.count)&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34; from OrderItem oi&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34; join oi.item i&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34; where oi.order.id in : orderIds&#34;</span><span class=p>,</span><span class=w> </span><span class=n>OrderItemQueryDto</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>setParameter</span><span class=p>(</span><span class=s>&#34;orderIds&#34;</span><span class=p>,</span><span class=w> </span><span class=n>orderIds</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderItemQueryDto</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>orderItemMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderItems</span><span class=p>.</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>groupingBy</span><span class=p>(</span><span class=n>orderItemQueryDto</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>orderItemQueryDto</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>orderItemMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>where … in 을 이용해서 쿼리를 한번 보내게 한다. 그 반환 값인 orderItems를 Map 형식으로 바꾸어 orderItemMap을 반환한다. 반환 받은 orderItemMap을 루프를 돌면서 컬렉션을 추가한다.</p><ul><li>Query: 루트 1번, 컬렉션 1번</li><li>ToOne 관계들을 먼저 조회 후, 얻은 식별자 orderId로 ToMany 관계인 OrderItem을 한꺼뻔에 조회</li><li>MAP을 사용해서 매칭 성능 향상(O(1))</li></ul><hr><h2 id=주문-조회-v6-jpa에서-dto로-직접-조회-플랫-데이터-최적화>주문 조회 V6: JPA에서 DTO로 직접 조회, 플랫 데이터 최적화<a hidden class=anchor aria-hidden=true href=#주문-조회-v6-jpa에서-dto로-직접-조회-플랫-데이터-최적화>#</a></h2><p>OrderApiController에 추가</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v6/orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV6</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderFlatDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>flats</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderQueryRepository</span><span class=p>.</span><span class=na>findAllByDto_flat</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//flats를 OrderQueryDto 관련된것과 OrderItemQueryDto와 관련된것을 각각 알맞게 생성해서 map으로 OrderQueryDto를 만든다.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//groupBy할때 뭐를 기준으로 묶을지 알려줘야하기때문에 OrderQueryDto에 @EqualAndHashCode 추가</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>flats</span><span class=p>.</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>groupingBy</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderQueryDto</span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>o</span><span class=p>.</span><span class=na>getName</span><span class=p>(),</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=na>getOrderDate</span><span class=p>(),</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=na>getOrderStatus</span><span class=p>(),</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=na>getAddress</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mapping</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderItemQueryDto</span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=na>getOrderId</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>o</span><span class=p>.</span><span class=na>getItemName</span><span class=p>(),</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=na>getOrderPrice</span><span class=p>(),</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=na>getCount</span><span class=p>()),</span><span class=w> </span><span class=n>toList</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)).</span><span class=na>entrySet</span><span class=p>().</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderQueryDto</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>getKey</span><span class=p>().</span><span class=na>getOrderId</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>getKey</span><span class=p>().</span><span class=na>getName</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getKey</span><span class=p>().</span><span class=na>getOrderDate</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getKey</span><span class=p>().</span><span class=na>getOrderStatus</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>getKey</span><span class=p>().</span><span class=na>getAddress</span><span class=p>(),</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>getValue</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>toList</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>OrderQueryDto에 생성자 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=nf>OrderQueryDto</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>orderDate</span><span class=p>,</span><span class=w> </span><span class=n>OrderStatus</span><span class=w> </span><span class=n>orderStatus</span><span class=p>,</span><span class=w> </span><span class=n>Address</span><span class=w> </span><span class=n>address</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderItemQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderItems</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>orderId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>orderDate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>orderStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>address</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>orderItems</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderItems</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>컬렉션(orderItems)을 생성자로 주입받는다.</p><p><strong>OrderQueryRepository에 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderFlatDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findAllByDto_flat</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;select new jpabook.jpashop.repository.order.query.OrderFlatDto(o.id, m.name, o.orderDate, o.status, d.address, i.name, oi.orderPrice, oi.count)&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34; from Order o&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34; join o.member m&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34; join o.delivery d&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34; join o.orderItems oi&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34; join oi.item i&#34;</span><span class=p>,</span><span class=w> </span><span class=n>OrderFlatDto</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>OrderFlatDto</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderFlatDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>orderDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderStatus</span><span class=w> </span><span class=n>orderStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Address</span><span class=w> </span><span class=n>address</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>itemName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>orderPrice</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>OrderFlatDto</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>orderDate</span><span class=p>,</span><span class=w> </span><span class=n>OrderStatus</span><span class=w> </span><span class=n>orderStatus</span><span class=p>,</span><span class=w> </span><span class=n>Address</span><span class=w> </span><span class=n>address</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>itemName</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>orderPrice</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderDate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>address</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>itemName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>itemName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderPrice</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>장점<ul><li>쿼리 1번</li></ul></li><li>단점<ul><li>쿼리는 한번이지만 조인으로 인해 DB에서 애플리케이션에 전달하는 데이터에 중복 데이터가 추가되므로 상황에 따라 V5 보다 더 느릴 수 도 있다.</li><li>DTO에 맞게 애플리케이션에서 추가 작업이 많다.</li><li>페이징 불가능</li></ul></li></ul><hr><h2 id=정리>정리<a hidden class=anchor aria-hidden=true href=#정리>#</a></h2><ul><li>엔티티 조회<ul><li>V1: 엔티티를 조회해서 그대로 반환</li><li>V2: 엔티티 조회 후 DTO로 반환</li><li>V3: 페치 조인으로 쿼리 수 최적화</li><li>V3.1: 컬렉션 페이징과 한계 돌파<ul><li>컬렉션은 페치 조인시 페이징 불가능</li><li>ToOne 관계는 페치 조인으로 쿼리수 최적화</li><li>컬렉션은 페치 조인 대신 지연 로딩으로 유지, <code>hibernate.default_batch_fetch_size</code> , <code>@BatchSize</code> 로 최적화</li></ul></li></ul></li><li>DTO 직접 조회<ul><li>V4: JPA에서 DTO를 직접조회</li><li>V5: 컬렉션 조회 최적화 - 일대다 관계인 컬렉션은 IN절을 활용해서 메모리에 미리 조회해서 최적화</li><li>V6: 플랫 데이터 최적화 - JOIN 결과를 그대로 조회 후 애플리케이션에서 원하는 모양으로 직접 변환</li></ul></li></ul><p><strong>권장 순서</strong></p><ol><li>엔티티 조회 방식으로 우선 접근<ol><li>페치 조인으로 쿼리 수 최적화</li><li>컬렉션 최적화<ol><li>페이징 필요 → <code>hibernate.default_batch_fetch_size</code> , <code>@BatchSize</code> 로 최적화</li><li>페이징 필요X → 페치 조인 사용</li></ol></li></ol></li><li>엔티티 조회 방식으로 해결안되면 DTO 조회 방식 사용</li><li>DTO 조회 방식도 안되면 NativeSQL or 스프링 JdbcTemplate 사용</li></ol><blockquote><p>엔티티 조회 방식은 페치 조인이나, hibernate.default_batch_fetch_size, @BatchSize 같이 코드를 거의 수정하지 않고, 옵션만 약간 변경해서, 다양한 성능 최적화를 시도할 수 있다. 반면에 DTO를 직접 조회하는 방식은 성능을 최적화 하거나 성능 최적화 방식을 변경할 때 많은 코드를 변경해야 한다.</p></blockquote><p><strong>DTO 조회 방식의 선택지</strong></p><p>DTO로 조회 하는 방법도 각각 장단점이 있다. V4, V5, V6에서 단순하게 쿼리 1번 실행된다고 V6가 항상 좋은 방법은 아니다.</p><ul><li>V4는 코드가 단순하고 단건조회에서 성능이 잘나온다.</li><li>V5는 코드가 복잡하지만 여러 주문을 한꺼번에 조회할때는 V4대신 V5 방식을 사용해야 한다. 쿼리의 수를 많이 줄여줄수있고 상황에 따라 다르겠지만 운영 환경에서 100배 이상의 성능 차이가 날수 있다.</li><li>V6는 쿼리 한번으로 최적화 되서 좋을수 있지만, Order를 기준으로 페이징이 불가능하다. 실무에서는 많은 양의 데이터가 페이징 처리가 필요하기때문에 이 경우는 선택하기 어렵다. 그리고 데이터가 많으면 중복 저송이 증가해 V5와 성능차이도 미비하다.</li></ul><hr></div><footer class=post-footer><ul class=post-tags><li><a href=https://yosong6729.github.io/tags/spring-boot/>Spring Boot</a></li><li><a href=https://yosong6729.github.io/tags/jpa/>JPA</a></li></ul><nav class=paginav><a class=prev href=https://yosong6729.github.io/post/osiv-%EC%84%B1%EB%8A%A5%EA%B3%BC-%EC%B5%9C%EC%A0%81%ED%99%94/><span class=title>« Prev</span><br><span>OSIV 성능과 최적화</span>
</a><a class=next href=https://yosong6729.github.io/post/%EC%A7%80%EC%97%B0-%EB%A1%9C%EB%94%A9%EA%B3%BC-%EC%A1%B0%ED%9A%8C-%EC%84%B1%EB%8A%A5-%EC%B5%9C%EC%A0%81%ED%99%94/><span class=title>Next »</span><br><span>지연 로딩과 조회 성능 최적화</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://yosong6729.github.io/>Yosong6729 Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>