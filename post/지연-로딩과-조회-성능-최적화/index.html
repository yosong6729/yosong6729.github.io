<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>지연 로딩과 조회 성능 최적화 | Yosong6729 Blog</title>
<meta name=keywords content="spring boot,JPA"><meta name=description content='해당 글은 김영한님의 인프런 강의 스프링부트와 JPA활용2 - API 개발과 성능 최적화을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
간단한 주문 조회 V1: 엔티티를 직접 노출 @xToOne(ManyToOne, OneToOne) 관계를 최적화 하는데에 집중한다.
V1은 좋은 방법이 아니기 때문에 간단히 보고 넘어가도 된다.
@RestController @RequiredArgsConstructor public class OrderSimpleApiController { private final OrderRepository orderRepository; @GetMapping("/api/v1/simple-orders") public List<Order> ordersV1() { List<Order> all = orderRepository.findAllByString(new OrderSearch()); for (Order order : all) { //getMember까지는 프록시 객체를 가져오고.'><meta name=author content="yosong6729"><link rel=canonical href=https://yosong6729.github.io/post/%EC%A7%80%EC%97%B0-%EB%A1%9C%EB%94%A9%EA%B3%BC-%EC%A1%B0%ED%9A%8C-%EC%84%B1%EB%8A%A5-%EC%B5%9C%EC%A0%81%ED%99%94/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://yosong6729.github.io/post/%EC%A7%80%EC%97%B0-%EB%A1%9C%EB%94%A9%EA%B3%BC-%EC%A1%B0%ED%9A%8C-%EC%84%B1%EB%8A%A5-%EC%B5%9C%EC%A0%81%ED%99%94/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="지연 로딩과 조회 성능 최적화"><meta property="og:description" content='해당 글은 김영한님의 인프런 강의 스프링부트와 JPA활용2 - API 개발과 성능 최적화을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
간단한 주문 조회 V1: 엔티티를 직접 노출 @xToOne(ManyToOne, OneToOne) 관계를 최적화 하는데에 집중한다.
V1은 좋은 방법이 아니기 때문에 간단히 보고 넘어가도 된다.
@RestController @RequiredArgsConstructor public class OrderSimpleApiController { private final OrderRepository orderRepository; @GetMapping("/api/v1/simple-orders") public List<Order> ordersV1() { List<Order> all = orderRepository.findAllByString(new OrderSearch()); for (Order order : all) { //getMember까지는 프록시 객체를 가져오고.'><meta property="og:type" content="article"><meta property="og:url" content="https://yosong6729.github.io/post/%EC%A7%80%EC%97%B0-%EB%A1%9C%EB%94%A9%EA%B3%BC-%EC%A1%B0%ED%9A%8C-%EC%84%B1%EB%8A%A5-%EC%B5%9C%EC%A0%81%ED%99%94/"><meta property="og:image" content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-09-24T16:03:53+09:00"><meta property="article:modified_time" content="2024-09-24T16:03:53+09:00"><meta property="og:site_name" content="Yosong6729 Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="지연 로딩과 조회 성능 최적화"><meta name=twitter:description content='해당 글은 김영한님의 인프런 강의 스프링부트와 JPA활용2 - API 개발과 성능 최적화을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
간단한 주문 조회 V1: 엔티티를 직접 노출 @xToOne(ManyToOne, OneToOne) 관계를 최적화 하는데에 집중한다.
V1은 좋은 방법이 아니기 때문에 간단히 보고 넘어가도 된다.
@RestController @RequiredArgsConstructor public class OrderSimpleApiController { private final OrderRepository orderRepository; @GetMapping("/api/v1/simple-orders") public List<Order> ordersV1() { List<Order> all = orderRepository.findAllByString(new OrderSearch()); for (Order order : all) { //getMember까지는 프록시 객체를 가져오고.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yosong6729.github.io/post/"},{"@type":"ListItem","position":2,"name":"지연 로딩과 조회 성능 최적화","item":"https://yosong6729.github.io/post/%EC%A7%80%EC%97%B0-%EB%A1%9C%EB%94%A9%EA%B3%BC-%EC%A1%B0%ED%9A%8C-%EC%84%B1%EB%8A%A5-%EC%B5%9C%EC%A0%81%ED%99%94/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"지연 로딩과 조회 성능 최적화","name":"지연 로딩과 조회 성능 최적화","description":"해당 글은 김영한님의 인프런 강의 스프링부트와 JPA활용2 - API 개발과 성능 최적화을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\n간단한 주문 조회 V1: 엔티티를 직접 노출 @xToOne(ManyToOne, OneToOne) 관계를 최적화 하는데에 집중한다.\nV1은 좋은 방법이 아니기 때문에 간단히 보고 넘어가도 된다.\n@RestController @RequiredArgsConstructor public class OrderSimpleApiController { private final OrderRepository orderRepository; @GetMapping(\u0026#34;/api/v1/simple-orders\u0026#34;) public List\u0026lt;Order\u0026gt; ordersV1() { List\u0026lt;Order\u0026gt; all = orderRepository.findAllByString(new OrderSearch()); for (Order order : all) { //getMember까지는 프록시 객체를 가져오고.","keywords":["spring boot","JPA"],"articleBody":" 해당 글은 김영한님의 인프런 강의 스프링부트와 JPA활용2 - API 개발과 성능 최적화을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\n간단한 주문 조회 V1: 엔티티를 직접 노출 @xToOne(ManyToOne, OneToOne) 관계를 최적화 하는데에 집중한다.\nV1은 좋은 방법이 아니기 때문에 간단히 보고 넘어가도 된다.\n@RestController @RequiredArgsConstructor public class OrderSimpleApiController { private final OrderRepository orderRepository; @GetMapping(\"/api/v1/simple-orders\") public List\u003cOrder\u003e ordersV1() { List\u003cOrder\u003e all = orderRepository.findAllByString(new OrderSearch()); for (Order order : all) { //getMember까지는 프록시 객체를 가져오고.getName은 실제 값을 가져와야 하기때문에 //실제 값을 가져와야해서 Lazy 강제 초기화 된다. order.getMember().getName(); //Lazy 강제 초기화 order.getDelivery().getAddress(); //Lazy 강제 초기화 } return all; } } order → member와 order → delivery는 지연 로딩이기 때문에 실제 엔티티 대신 프록시가 존재한다. jackson 라이브러리는 기본적으로 ByteBuddyIntercepter객체를 json으로 생성이 안되서 예외가 발생한다. hibernate5Module을 스프링 빈으로 등록하면 해결된다. 스프링 부트 3.0 이상: Hibernate5JakartaModule 등록\nbuild.gradle에 추가\nimplementation 'com.fasterxml.jackson.datatype:jackson-datatype-hibernate5-jakarta’ JpashopApplication에 다음 코드 추가\n@Bean Hibernate5JakartaModule hibernate5Module() { Hibernate5Module hibernate5Module = new Hibernate5Module(); //강제 지연 로딩 설정 hibernate5Module.configure(Hibernate5Module.Feature.FORCE_LAZY_LOADING, true); return hibernate5Module; } 위 코드처럼 설정하면 강제로 지연 로딩이 가능하다.\norder → member, member → orders 양방향 연관관계를 계속 로딩하기 떄문에 @JsonIgnore 옵션을 한곳에 주어야한다.\n간단한 주문 조회 V2: 엔티티를 DTO로 변환 orderSimpleApiController - 추가\n@GetMapping(\"/api/v2/simple-orders\") public List\u003cSimpleOrderDto\u003e ordersV2() { //Order 2개 //N + 1문제 발생, 1 + 회원 N + 배송 N List\u003cOrder\u003e orders = orderRepository.findAllByString(new OrderSearch()); List\u003cSimpleOrderDto\u003e result = orders.stream() .map(o -\u003e new SimpleOrderDto(o)) .collect(Collectors.toList()); return result; } @Data static class SimpleOrderDto { private Long orderId; private String name; private LocalDateTime orderDate; private OrderStatus orderStatus; private Address address; public SimpleOrderDto(Order order) { orderId = order.getId(); name = order.getMember().getName(); //LAZY 초기화, 영속성 컨텍스트가 memberid를 가지고 영속성 컨텍스트에서 찾아온다. 업으면 DB에 쿼리를 날림 orderDate = order.getOrderDate(); orderStatus = order.getStatus(); address = order.getDelivery().getAddress(); //LAZY 초기화 } } 엔티티를 DTO로 변환하는 일반적인 방법이다.\n쿼리가 총 1 + N + N 번 실행 되는데 order 조회 1번(order 조회 결과 수가 N이 된다.), order → member 지연 로딩 N번, order → delivery 지연 로딩 조회 N번으로 order의 결과가 4개면 최악의 경우 1+4+4번 실행 된다.\n간단한 주문 조회 V3: 엔티티를 DTO로 변환 - 페치 조인 최적화 OrderSimpleApiController - 추가\n@GetMapping(\"/api/v3/simple-orders\") public List\u003cSimpleOrderDto\u003e ordersV3() { List\u003cOrder\u003e orders = orderRepository.findAllWithMemberDelivery(); List\u003cSimpleOrderDto\u003e result = orders.stream() .map(o -\u003e new SimpleOrderDto(o)) .collect(Collectors.toList()); return result; } OrderRepository - 추가\npublic List\u003cOrder\u003e findAllWithMemberDelivery() { return em.createQuery( \"select o from Order o\" + \" join fetch o.member m\" + \" join fetch o.delivery d\", Order.class ).getResultList(); } 페치 조인으로 쿼리 1번에 조회 페치 조인으로 order → member, order → delibvery는 이미 조회 된 상태 이므로 지연로딩X 단점은 select절에 모든 정보를 다 가지고 있다. 이것을 해결하기 위한 방법으로는 V4를 확인하면 된다.\n간단한 주문 조회 V4: JPA에서 DTO로 바로 조회 OrderSimpleAipController - 추가\nprivate final OrderSimpleQueryRepository orderSimpleQueryRepository; //의존관계 주입 @GetMapping(\"/api/v4/simple-orders\") public List\u003cOrderSimpleQueryDto\u003e ordersV4() { return orderSimpleQueryRepository.findOrderDtos(); } OrderSimpleQueryRepository 조회 전용 리포지토리\n@Repository @RequiredArgsConstructor public class OrderSimpleQueryRepository { private final EntityManager em; public List\u003cOrderSimpleQueryDto\u003e findOrderDtos() { return em.createQuery( \"select new jpabook.jpashop.repository.order.simplequery.OrderSimpleQueryDto(o.id, m.name, o.orderDate, o.status, d.address) \" + \"from Order o\" + \" join o.member m\" + \" join o.delivery d\", OrderSimpleQueryDto.class) .getResultList(); } } V3에서는 fetch join을 사용하고 V4에서는 join을 사용한 이유는 fetch join은 JPA에서 지원하는 문법이고, 엔티티를 조회할 떄만 사용할수 있다. V4처럼 DTO를 조회할때는 사용할수 없기 때문이다.\nnew 오퍼레이션을 사용하면 OrderSimpleQueryDto(o) 이렇게 넘기면 o의 식별자인 o.id만 넘어간다. 즉, OrderSimpleQueryDto(o.id)와 동일하다. 그래서 식별자를 넘기는게 아닌 값들을 지정해서 넘겨준다.\nOrderSimpleQueryDto 리포지토리에서 DTO 직접 조회\n@Data public class OrderSimpleQueryDto { private Long orderId; private String name; private LocalDateTime orderDate; private OrderStatus orderStatus; private Address address; public OrderSimpleQueryDto(Long orderId, String name, LocalDateTime orderDate, OrderStatus orderStatus, Address address) { this.orderId = orderId; this.name = name; //LAZY 초기화, 영속성 컨텍스트가 memberid를 가지고 영속성 컨텍스트에서 찾아온다. 없으면 DB에 쿼리를 날림 this.orderDate = orderDate; this.orderStatus = orderStatus; this.address = address; //LAZY 초기화 } } 쿼리 결과\nV3와 다르게 원하는 값을 선택해서 조회 new 명령어를 사용해서 JPQL의 결과를 DTO로 즉시 변환 SELECT 절에서 원하는 데이터를 직접 선택하므로 DB 애플리케이션 네트웍 용량 최적화(생각보다 미비) V3는 List의 값을 수정할수 있어서 재사용성이 있지만, V4는 API 스펙에 맞춘 코드가 리포지토리에 들어가기 때문에 재사용성이 떨어진다. 정리 V3, V4 두가지 방법은 각각 장단점이 있다. 둘중 상황에 따라서 더 나은 방법을 선택하면 되는데 권장하는 방법은 다음과 같다.\n쿼리 방식 선택 권장 순서\n우선 엔티티를 DTO로 변환하는 방법을 선택 필요하면 페치 조인으로 성능 최적화 → 대부분 성능 이슈 해결 그래도 안되면 DTO로 직접 조회 최후의 방법은 JPA가 제공하는 네이티브 SQL이나 스프링 JDBC Template을 사용해서 SQL을 직접 사용 ","wordCount":"713","inLanguage":"en","image":"https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-09-24T16:03:53+09:00","dateModified":"2024-09-24T16:03:53+09:00","author":{"@type":"Person","name":"yosong6729"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yosong6729.github.io/post/%EC%A7%80%EC%97%B0-%EB%A1%9C%EB%94%A9%EA%B3%BC-%EC%A1%B0%ED%9A%8C-%EC%84%B1%EB%8A%A5-%EC%B5%9C%EC%A0%81%ED%99%94/"},"publisher":{"@type":"Organization","name":"Yosong6729 Blog","logo":{"@type":"ImageObject","url":"https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yosong6729.github.io/ accesskey=h title="Yosong6729 블로그 (Alt + H)"><img src=https://yosong6729.github.io/apple-touch-icon.png alt aria-label=logo height=35>Yosong6729 블로그</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yosong6729.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://yosong6729.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yosong6729.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yosong6729.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">지연 로딩과 조회 성능 최적화</h1><div class=post-meta><span title='2024-09-24 16:03:53 +0900 KST'>September 24, 2024</span>&nbsp;·&nbsp;yosong6729&nbsp;|&nbsp;<a href=https://github.com/yosong6729/blog/tree/main/content/post/%ec%a7%80%ec%97%b0%20%eb%a1%9c%eb%94%a9%ea%b3%bc%20%ec%a1%b0%ed%9a%8c%20%ec%84%b1%eb%8a%a5%20%ec%b5%9c%ec%a0%81%ed%99%94/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%ea%b0%84%eb%8b%a8%ed%95%9c-%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v1-%ec%97%94%ed%8b%b0%ed%8b%b0%eb%a5%bc-%ec%a7%81%ec%a0%91-%eb%85%b8%ec%b6%9c aria-label="간단한 주문 조회 V1: 엔티티를 직접 노출">간단한 주문 조회 V1: 엔티티를 직접 노출</a></li><li><a href=#%ea%b0%84%eb%8b%a8%ed%95%9c-%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v2-%ec%97%94%ed%8b%b0%ed%8b%b0%eb%a5%bc-dto%eb%a1%9c-%eb%b3%80%ed%99%98 aria-label="간단한 주문 조회 V2: 엔티티를 DTO로 변환">간단한 주문 조회 V2: 엔티티를 DTO로 변환</a></li><li><a href=#%ea%b0%84%eb%8b%a8%ed%95%9c-%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v3-%ec%97%94%ed%8b%b0%ed%8b%b0%eb%a5%bc-dto%eb%a1%9c-%eb%b3%80%ed%99%98---%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8-%ec%b5%9c%ec%a0%81%ed%99%94 aria-label="간단한 주문 조회 V3: 엔티티를 DTO로 변환 - 페치 조인 최적화">간단한 주문 조회 V3: 엔티티를 DTO로 변환 - 페치 조인 최적화</a></li><li><a href=#%ea%b0%84%eb%8b%a8%ed%95%9c-%ec%a3%bc%eb%ac%b8-%ec%a1%b0%ed%9a%8c-v4-jpa%ec%97%90%ec%84%9c-dto%eb%a1%9c-%eb%b0%94%eb%a1%9c-%ec%a1%b0%ed%9a%8c aria-label="간단한 주문 조회 V4: JPA에서 DTO로 바로 조회">간단한 주문 조회 V4: JPA에서 DTO로 바로 조회</a><ul><li><a href=#%ec%a0%95%eb%a6%ac aria-label=정리>정리</a></li></ul></li></ul></div></details></div><div class=post-content><blockquote><p>해당 글은 김영한님의 인프런 강의 <a href=https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81%EB%B6%80%ED%8A%B8-JPA-API%EA%B0%9C%EB%B0%9C-%EC%84%B1%EB%8A%A5%EC%B5%9C%EC%A0%81%ED%99%94>스프링부트와 JPA활용2 - API 개발과 성능 최적화</a>을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.</p></blockquote><hr><h2 id=간단한-주문-조회-v1-엔티티를-직접-노출>간단한 주문 조회 V1: 엔티티를 직접 노출<a hidden class=anchor aria-hidden=true href=#간단한-주문-조회-v1-엔티티를-직접-노출>#</a></h2><p>@xToOne(ManyToOne, OneToOne) 관계를 최적화 하는데에 집중한다.</p><p>V1은 좋은 방법이 아니기 때문에 간단히 보고 넘어가도 된다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderSimpleApiController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>OrderRepository</span><span class=w> </span><span class=n>orderRepository</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v1/simple-orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=n>all</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderRepository</span><span class=p>.</span><span class=na>findAllByString</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>OrderSearch</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>all</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=c1>//getMember까지는 프록시 객체를 가져오고.getName은 실제 값을 가져와야 하기때문에</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=c1>//실제 값을 가져와야해서 Lazy 강제 초기화 된다.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>order</span><span class=p>.</span><span class=na>getMember</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w> </span><span class=c1>//Lazy 강제 초기화</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>order</span><span class=p>.</span><span class=na>getDelivery</span><span class=p>().</span><span class=na>getAddress</span><span class=p>();</span><span class=w> </span><span class=c1>//Lazy 강제 초기화</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>all</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>order → member와 order → delivery는 지연 로딩이기 때문에 실제 엔티티 대신 프록시가 존재한다.</li><li>jackson 라이브러리는 기본적으로 ByteBuddyIntercepter객체를 json으로 생성이 안되서 예외가 발생한다.</li><li>hibernate5Module을 스프링 빈으로 등록하면 해결된다.</li></ul><p><strong>스프링 부트 3.0 이상: Hibernate5JakartaModule 등록</strong></p><p>build.gradle에 추가</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>implementation</span><span class=w> </span><span class=err>&#39;</span><span class=n>com</span><span class=p>.</span><span class=na>fasterxml</span><span class=p>.</span><span class=na>jackson</span><span class=p>.</span><span class=na>datatype</span><span class=p>:</span><span class=n>jackson</span><span class=o>-</span><span class=n>datatype</span><span class=o>-</span><span class=n>hibernate5</span><span class=o>-</span><span class=n>jakarta</span><span class=err>’</span><span class=w>
</span></span></span></code></pre></div><p>JpashopApplication에 다음 코드 추가</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Hibernate5JakartaModule</span><span class=w> </span><span class=nf>hibernate5Module</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Hibernate5Module</span><span class=w> </span><span class=n>hibernate5Module</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Hibernate5Module</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//강제 지연 로딩 설정</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>hibernate5Module</span><span class=p>.</span><span class=na>configure</span><span class=p>(</span><span class=n>Hibernate5Module</span><span class=p>.</span><span class=na>Feature</span><span class=p>.</span><span class=na>FORCE_LAZY_LOADING</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>hibernate5Module</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>위 코드처럼 설정하면 강제로 지연 로딩이 가능하다.</p><p>order → member, member → orders 양방향 연관관계를 계속 로딩하기 떄문에 @JsonIgnore 옵션을 한곳에 주어야한다.</p><hr><h2 id=간단한-주문-조회-v2-엔티티를-dto로-변환>간단한 주문 조회 <strong>V2: 엔티티를 DTO로 변환</strong><a hidden class=anchor aria-hidden=true href=#간단한-주문-조회-v2-엔티티를-dto로-변환>#</a></h2><p><strong>orderSimpleApiController - 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v2/simple-orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>SimpleOrderDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//Order 2개</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//N + 1문제 발생, 1 + 회원 N + 배송 N</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderRepository</span><span class=p>.</span><span class=na>findAllByString</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>OrderSearch</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>SimpleOrderDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orders</span><span class=p>.</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleOrderDto</span><span class=p>(</span><span class=n>o</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>toList</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>SimpleOrderDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>orderDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderStatus</span><span class=w> </span><span class=n>orderStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Address</span><span class=w> </span><span class=n>address</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>SimpleOrderDto</span><span class=p>(</span><span class=n>Order</span><span class=w> </span><span class=n>order</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getMember</span><span class=p>().</span><span class=na>getName</span><span class=p>();</span><span class=w> </span><span class=c1>//LAZY 초기화, 영속성 컨텍스트가 memberid를 가지고 영속성 컨텍스트에서 찾아온다. 업으면 DB에 쿼리를 날림</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderDate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getOrderDate</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getStatus</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>order</span><span class=p>.</span><span class=na>getDelivery</span><span class=p>().</span><span class=na>getAddress</span><span class=p>();</span><span class=w> </span><span class=c1>//LAZY 초기화</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>엔티티를 DTO로 변환하는 일반적인 방법이다.</p><p>쿼리가 총 1 + N + N 번 실행 되는데 order 조회 1번(order 조회 결과 수가 N이 된다.), order → member 지연 로딩 N번, order → delivery 지연 로딩 조회 N번으로 order의 결과가 4개면 최악의 경우 1+4+4번 실행 된다.</p><hr><h2 id=간단한-주문-조회-v3-엔티티를-dto로-변환---페치-조인-최적화>간단한 주문 조회 V3: 엔티티를 DTO로 변환 - 페치 조인 최적화<a hidden class=anchor aria-hidden=true href=#간단한-주문-조회-v3-엔티티를-dto로-변환---페치-조인-최적화>#</a></h2><p><strong>OrderSimpleApiController - 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v3/simple-orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>SimpleOrderDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV3</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderRepository</span><span class=p>.</span><span class=na>findAllWithMemberDelivery</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>SimpleOrderDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orders</span><span class=p>.</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>map</span><span class=p>(</span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleOrderDto</span><span class=p>(</span><span class=n>o</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=n>Collectors</span><span class=p>.</span><span class=na>toList</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>OrderRepository - 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findAllWithMemberDelivery</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;select o from Order o&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34; join fetch o.member m&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=s>&#34; join fetch o.delivery d&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Order</span><span class=p>.</span><span class=na>class</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>).</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>페치 조인으로 쿼리 1번에 조회</li></ul><p><img loading=lazy src=images/image.png alt=image.png></p><ul><li>페치 조인으로 order → member, order → delibvery는 이미 조회 된 상태 이므로 지연로딩X</li></ul><p>단점은 select절에 모든 정보를 다 가지고 있다. 이것을 해결하기 위한 방법으로는 V4를 확인하면 된다.</p><hr><h2 id=간단한-주문-조회-v4-jpa에서-dto로-바로-조회>간단한 주문 조회 V4: JPA에서 DTO로 바로 조회<a hidden class=anchor aria-hidden=true href=#간단한-주문-조회-v4-jpa에서-dto로-바로-조회>#</a></h2><p><strong>OrderSimpleAipController - 추가</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>OrderSimpleQueryRepository</span><span class=w> </span><span class=n>orderSimpleQueryRepository</span><span class=p>;</span><span class=w> </span><span class=c1>//의존관계 주입</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/api/v4/simple-orders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderSimpleQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>ordersV4</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>orderSimpleQueryRepository</span><span class=p>.</span><span class=na>findOrderDtos</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>OrderSimpleQueryRepository 조회 전용 리포지토리</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Repository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequiredArgsConstructor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderSimpleQueryRepository</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>EntityManager</span><span class=w> </span><span class=n>em</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderSimpleQueryDto</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findOrderDtos</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;select new jpabook.jpashop.repository.order.simplequery.OrderSimpleQueryDto(o.id, m.name, o.orderDate, o.status, d.address) &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34;from Order o&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34; join o.member m&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34; join o.delivery d&#34;</span><span class=p>,</span><span class=w> </span><span class=n>OrderSimpleQueryDto</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>V3에서는 fetch join을 사용하고 V4에서는 join을 사용한 이유는 fetch join은 JPA에서 지원하는 문법이고, 엔티티를 조회할 떄만 사용할수 있다. V4처럼 DTO를 조회할때는 사용할수 없기 때문이다.</p><p>new 오퍼레이션을 사용하면 OrderSimpleQueryDto(o) 이렇게 넘기면 o의 식별자인 o.id만 넘어간다. 즉, OrderSimpleQueryDto(o.id)와 동일하다. 그래서 식별자를 넘기는게 아닌 값들을 지정해서 넘겨준다.</p><p><strong>OrderSimpleQueryDto 리포지토리에서 DTO 직접 조회</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderSimpleQueryDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>orderDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderStatus</span><span class=w> </span><span class=n>orderStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>Address</span><span class=w> </span><span class=n>address</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>OrderSimpleQueryDto</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>orderDate</span><span class=p>,</span><span class=w> </span><span class=n>OrderStatus</span><span class=w> </span><span class=n>orderStatus</span><span class=p>,</span><span class=w> </span><span class=n>Address</span><span class=w> </span><span class=n>address</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w> </span><span class=c1>//LAZY 초기화, 영속성 컨텍스트가 memberid를 가지고 영속성 컨텍스트에서 찾아온다. 없으면 DB에 쿼리를 날림</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderDate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>orderStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderStatus</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>address</span><span class=p>;</span><span class=w> </span><span class=c1>//LAZY 초기화</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과</p><p><img loading=lazy src=images/image%201.png alt=image.png></p><ul><li>V3와 다르게 원하는 값을 선택해서 조회</li><li>new 명령어를 사용해서 JPQL의 결과를 DTO로 즉시 변환</li><li>SELECT 절에서 원하는 데이터를 직접 선택하므로 DB 애플리케이션 네트웍 용량 최적화(생각보다 미비)</li><li>V3는 List의 값을 수정할수 있어서 재사용성이 있지만, V4는 API 스펙에 맞춘 코드가 리포지토리에 들어가기 때문에 재사용성이 떨어진다.</li></ul><h3 id=정리>정리<a hidden class=anchor aria-hidden=true href=#정리>#</a></h3><p>V3, V4 두가지 방법은 각각 장단점이 있다. 둘중 상황에 따라서 더 나은 방법을 선택하면 되는데 권장하는 방법은 다음과 같다.</p><p><strong>쿼리 방식 선택 권장 순서</strong></p><ol><li>우선 엔티티를 DTO로 변환하는 방법을 선택</li><li>필요하면 페치 조인으로 성능 최적화 → 대부분 성능 이슈 해결</li><li>그래도 안되면 DTO로 직접 조회</li><li>최후의 방법은 JPA가 제공하는 네이티브 SQL이나 스프링 JDBC Template을 사용해서 SQL을 직접 사용</li></ol><hr></div><footer class=post-footer><ul class=post-tags><li><a href=https://yosong6729.github.io/tags/spring-boot/>Spring Boot</a></li><li><a href=https://yosong6729.github.io/tags/jpa/>JPA</a></li></ul><nav class=paginav><a class=next href=https://yosong6729.github.io/post/api-%EA%B0%9C%EB%B0%9C-%EA%B8%B0%EB%B3%B8/><span class=title>Next »</span><br><span>API 개발 기본</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://yosong6729.github.io/>Yosong6729 Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>