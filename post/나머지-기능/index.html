<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>나머지 기능 | Yosong6729 Blog</title>
<meta name=keywords content="spring data JPA"><meta name=description content="해당 글은 김영한님의 인프런 강의 스프링 데이터 JPA을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다
Specifications(명세) 책 도메인 주도 설계(DDD)는 SPECIFICATION(명세)라는 개념을 소개한다. 스프링 데이터 JPA는 JPA Criteria를 활용해서 이 개념을 사용할 수 있도록 지원한다.
술어(predicate)
참 또는 거짓으로 평가 AND OR 같은 연산자로 조합해서 다양한 검색조건을 쉽게 생성(컴포지트 패턴) 예) 검색 조건 하나하나 스프링 데이터 JPA는 org.springframework.data.jpa.domain.Specification클래스로 정의 명세 기능 사용 방법"><meta name=author content="yosong6729"><link rel=canonical href=https://yosong6729.github.io/post/%EB%82%98%EB%A8%B8%EC%A7%80-%EA%B8%B0%EB%8A%A5/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://yosong6729.github.io/post/%EB%82%98%EB%A8%B8%EC%A7%80-%EA%B8%B0%EB%8A%A5/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="나머지 기능"><meta property="og:description" content="해당 글은 김영한님의 인프런 강의 스프링 데이터 JPA을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다
Specifications(명세) 책 도메인 주도 설계(DDD)는 SPECIFICATION(명세)라는 개념을 소개한다. 스프링 데이터 JPA는 JPA Criteria를 활용해서 이 개념을 사용할 수 있도록 지원한다.
술어(predicate)
참 또는 거짓으로 평가 AND OR 같은 연산자로 조합해서 다양한 검색조건을 쉽게 생성(컴포지트 패턴) 예) 검색 조건 하나하나 스프링 데이터 JPA는 org.springframework.data.jpa.domain.Specification클래스로 정의 명세 기능 사용 방법"><meta property="og:type" content="article"><meta property="og:url" content="https://yosong6729.github.io/post/%EB%82%98%EB%A8%B8%EC%A7%80-%EA%B8%B0%EB%8A%A5/"><meta property="og:image" content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-10-04T19:39:56+09:00"><meta property="article:modified_time" content="2024-10-04T19:39:56+09:00"><meta property="og:site_name" content="Yosong6729 Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="나머지 기능"><meta name=twitter:description content="해당 글은 김영한님의 인프런 강의 스프링 데이터 JPA을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다
Specifications(명세) 책 도메인 주도 설계(DDD)는 SPECIFICATION(명세)라는 개념을 소개한다. 스프링 데이터 JPA는 JPA Criteria를 활용해서 이 개념을 사용할 수 있도록 지원한다.
술어(predicate)
참 또는 거짓으로 평가 AND OR 같은 연산자로 조합해서 다양한 검색조건을 쉽게 생성(컴포지트 패턴) 예) 검색 조건 하나하나 스프링 데이터 JPA는 org.springframework.data.jpa.domain.Specification클래스로 정의 명세 기능 사용 방법"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yosong6729.github.io/post/"},{"@type":"ListItem","position":2,"name":"나머지 기능","item":"https://yosong6729.github.io/post/%EB%82%98%EB%A8%B8%EC%A7%80-%EA%B8%B0%EB%8A%A5/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"나머지 기능","name":"나머지 기능","description":"해당 글은 김영한님의 인프런 강의 스프링 데이터 JPA을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다\nSpecifications(명세) 책 도메인 주도 설계(DDD)는 SPECIFICATION(명세)라는 개념을 소개한다. 스프링 데이터 JPA는 JPA Criteria를 활용해서 이 개념을 사용할 수 있도록 지원한다.\n술어(predicate)\n참 또는 거짓으로 평가 AND OR 같은 연산자로 조합해서 다양한 검색조건을 쉽게 생성(컴포지트 패턴) 예) 검색 조건 하나하나 스프링 데이터 JPA는 org.springframework.data.jpa.domain.Specification클래스로 정의 명세 기능 사용 방법","keywords":["spring data JPA"],"articleBody":" 해당 글은 김영한님의 인프런 강의 스프링 데이터 JPA을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다\nSpecifications(명세) 책 도메인 주도 설계(DDD)는 SPECIFICATION(명세)라는 개념을 소개한다. 스프링 데이터 JPA는 JPA Criteria를 활용해서 이 개념을 사용할 수 있도록 지원한다.\n술어(predicate)\n참 또는 거짓으로 평가 AND OR 같은 연산자로 조합해서 다양한 검색조건을 쉽게 생성(컴포지트 패턴) 예) 검색 조건 하나하나 스프링 데이터 JPA는 org.springframework.data.jpa.domain.Specification클래스로 정의 명세 기능 사용 방법\nJpaSpecificationExecutor 인터페이스 상속\npublic interface MemberRepository extends JpaRepository\u003cMember, Long\u003e, JpaSpecificationExecutor\u003cMember\u003e{ } JpaSpecificationExecutor 인터페이스\npublic interface JpaSpecificationExecutor\u003cT\u003e { Optional\u003cT\u003e findOne(@Nullable Specification\u003cT\u003e spec); List\u003cT\u003e findAll(Specification\u003cT\u003e spec); Page\u003cT\u003e findAll(Specification\u003cT\u003e spec, Pageable pageable); List\u003cT\u003e findAll(Specification\u003cT\u003e spec, Sort sort); long count(Specification\u003cT\u003e spec); } 위 인터페이스에서 각 메서드 들이 Specification을 파라미터로 받아서 검색 조건으로 사용한다.\n명세 사용 코드\n@Test public void specBasic() { //given Team teamA = new Team(\"teamA\"); em.persist(teamA); Member m1 = new Member(\"m1\", 0, teamA); Member m2 = new Member(\"m2\", 0, teamA); em.persist(m1); em.persist(m2); em.flush(); em.clear(); //when Specification\u003cMember\u003e spec = MemberSpec.username(\"m1\").and(MemberSpec.teamName(\"teamA\")); List\u003cMember\u003e result = memberRepository.findAll(spec); Assertions.assertThat(result.size()).isEqualTo(1); } Specification을 구현하면 명세들을 조립할수 있다. where(), and(), or(), not()을 제공한다.\nfindAll에서 회원 이름 명세(username)과 팀 이름 명세(teamAName)을 and로 조합해서 검색조건으로 사용한다.\nMemberSpec 명세 정의 코드\npublic class MemberSpec { public static Specification\u003cMember\u003e teamName(final String teamName) { return (Specification\u003cMember\u003e) (root, query, builder) -\u003e { if (StringUtils.isEmpty(teamName)) { return null; } Join\u003cMember, Team\u003e t = root.join(\"team\", JoinType.INNER);//회우너과 조인 return builder.equal(t.get(\"name\"), teamName); }; } public static Specification\u003cMember\u003e username(final String username) { return (Specification\u003cMember\u003e) (root, query, builder) -\u003e builder.equal(root.get(\"username\"), username); } } 명세를 정의하려면 Specification 인터페이스를 구현해야한다. 명세를 정의할때는 toPredicate(…)메서드만 구현하면 되는데 JPA Criteria의 Root, CriteriaQuery, CriteriaBuilder 클래스를 제공한다.\n실무에서는 JPA Criteria를 거의 안쓴다. 대신에 QueryDSL을 사용하자.\nQuery By Example @Test public void queryByExample() { //given Team teamA = new Team(\"teamA\"); em.persist(teamA); Member m1 = new Member(\"m1\", 0, teamA); Member m2 = new Member(\"m2\", 0, teamA); em.persist(m1); em.persist(m2); em.flush(); em.clear(); //when //Probe 생성 Member member = new Member(\"m1\"); Team team = new Team(\"teamA\"); //내부조인 가능 member.setTeam(team); //ExampleMatcher 생성, age 프로퍼티는 무시 ExampleMatcher matcher = ExampleMatcher.matching().withIgnorePaths(\"age\"); Example\u003cMember\u003e example = Example.of(member, matcher); List\u003cMember\u003e result = memberRepository.findAll(example); assertThat(result.get(0).getUsername()).isEqualTo(\"m1\"); } 장점\n동적 쿼리를 편리하게 처리 도메인 객체를 그대로 사용 데이터 저장소를 RDB에서 NOSQL로 변경해도 코드 변경이 없게 추상화 되어 있음 스프링 데이터 JPA JpaRepository 인터페이스에 이미 포함 단점\n조인은 가능하지만 내부 조인(INNER JOIN)만 가능함 외부 조인(LEFT JOIN) 안됨 중첩 제약조건 안됨 매칭 조건이 매우 단순함 정리\n실무에서 사용하기에는 매칭 조건이 너무 단순하고, LEFT 조인이 안됨, 실무에서는 QueryDSL을 사용하자 Projections 공식 문서 참고\n엔티티 대신에 DTO를 편리하게 조회할때 사용한다.\n전체 엔티티가 아니라 만약 회원 이름만 조회하고 싶으면 어떻게 해야할까?\npublic interface UsernameOnly { String getUsername(); } 조회할 엔티티의 필드를 getter혀익으로 지정하면 해달 필드만선택해서 조회(Projection)한다.\npublic interface MemberRepository ... { List\u003cUsernameOnly\u003e findProjectionsByUsername(String username); } 반환 타입을 UsernameOnly 인터페이스 명으로 해준다.\n테스트 코드\n@Test public void projections() throws Exception { //given Team teamA = new Team(\"teamA\"); em.persist(teamA); Member m1 = new Member(\"m1\", 0, teamA); Member m2 = new Member(\"m2\", 0, teamA); em.persist(m1); em.persist(m2); em.flush(); em.clear(); //when List\u003cUsernameOnly\u003e result = memberRepository.findProjectionsByUsername(\"m1\"); //then Assertions.assertThat(result.size()).isEqualTo(1); } SQL에서도 select절에서 username만 조회(Projection)하는 것을 확인 할수 있다.\n인터페이스 기반 Closed Projections\npublic interface UsernameOnly { String getUsername(); } 프로퍼티 형식(getter)의 인터페이스를 제공하면 구현체는 스프링 데이토 JPA가 제공해준다.\n인터페이스 기반 Open Projections\npublic interface UsernameOnly { @Value(\"#{target.username + ' ' + target.age + ' ' + target.team.name}\") String getUsername(); } 위 처럼 스프링의 SpEL 문법도 지원한다.\n하지만 SpEL문법을 사용하면 DB에서 엔티티 필드를 다 조회해온다음에 계산한다. 따라서 JPQL SELET 절 최적화가 안된다. 다음은 SQL 결과에서 확인 할수 있다.\n클래스 기반 Projection\n다음과 같이 인터페이스가 아닌 구체적인 DTO 형식도 가능하다. 생성자의 파라미터 이름으로 매칭된다.\npublic class UsernameOnlyDto { private final String username; public UsernameOnlyDto(String username) { this.username = username; } public String getUsername() { return username; } } 동적 Projections\n다음과 같이 Generic Type을 주면, 동적으로 프로젝션 데이터 변경이 가능하다.\n\u003cT\u003e List\u003cT\u003e findProjectionsByUsername(String username, Class\u003cT\u003e type); //사용 코드 List\u003cUsernameOnly\u003e result = memberRepository.findProjectionsByUsername(\"m1\", UsernameOnly.class); 중첩 구조 처리\npublic interface NestedClosedProjection { String getUsername(); TeamInfo getTeam(); interface TeamInfo { String getName(); } } 쿼리 결과\n주의\n프로젝션 대상이 root 엔티티면 JPQL SELECT 절 최적화가 가능하다. 프로젝션 대상이 root가 아니면 Left outer join 처리 위 쿼리 결과 처럼 모든 필드를 SELECT해서 엔티티로 조회한 다음에 계산 정리\n프로젝션 대상이 root엔티티면 유용하지만 프로젝션 대상이 root엔티티를 넘어가면 JPQL SELECT 최적화가 되지 않는다. 실무의 복잡한 쿼리를 해결하기에는 한계가 있어서 단순할때만 사용하고 조금 복잡해지면 QueryDSL을 사용하자 네이티브 쿼리 가급적 네이티브 쿼리는 사용하지 않는 게 좋고 정말 어쩔수 없는 경우에만 사용한다.\n스프링 데이터 Projections를 활용하는 방법은 좋은 방법이다.\n스프링 데이터 JPA 기반 네이티브 쿼리\n페이징 지원\n반환 타입\nObject[] Tuple DTO(스프링 데이터 인터페이스 Projections 지원) DTO 반환 방식을 권장한다.\n제약\nSort 파라미터를 통한 정렬이 정상 동작하지 않을 수 있음(믿지 말고 직접 처리) JPQL처럼 애플리케이션 로딩 시점에 문법 확인 불가 동적 쿼리 불가 JPA 네이티브 SQL 지원\npublic interface MemberRepository extends JpaRepository\u003cMember, Long\u003e { @Query(value = \"select * from member where username = ?\", nativeQuery = true) Member findByNativeQuery(String username); } 쿼리 결과\n네이티브 SQL의 위치 기반 파라미터는 0부터 시작(JPQL은 1부터 시작)한다.\n네이티브 SQL을 엔티티가 아닌 DTO로 변환하려면 DTO 대신 JPA TUPLE 조회 DTO 대신 MAP 조회 @SqlResultSetMapping 복잡 Hibernate ResultTransformer를 사용해야함 복잡 네이티브 SQL을 DTO로 조회할 때는 JdbcTemplate or myBatis 권장 Projections 활용\nDTO로 반환하려는데 편리하고, nativeQuery면서 동적쿼리가 아닌 경우에 사용해도 좋다. 그리고 페이징이 가능하다.\nex)스프링 데이터 JPA 네이티브 쿼리 + 인터페이스 기반 Projections 활용\n@Query(value = \"SELECT m.member_id as id, m.username, t.name as teamName \" + \"FROM member m left join team t ON m.team_id = t.team_id\", countQuery = \"SELECT count(*) from member\", nativeQuery = true) Page\u003cMemberProjection\u003e findByNativeProjection(Pageable pageable); 쿼리 결과\n동적 네이티브 쿼리 하이버네이트 직접 사용 스프링 JdbcTemplate, myBatis, jooq같은 외부 라이브러리 사용 ex) 하이버네이트 기능 사용\nString sql = \"select m.username as username from member m\"; List\u003cMemberDto\u003e result = em.createNativeQuery(sql) .setFirstResult(0) .setMaxResults(10) .unwrap(NativeQuery.class) .addScalar(\"username\") .setResultTransformer(Transformers.aliasToBean(MemberDto.class)) .getResultList(); } ","wordCount":"933","inLanguage":"en","image":"https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-10-04T19:39:56+09:00","dateModified":"2024-10-04T19:39:56+09:00","author":{"@type":"Person","name":"yosong6729"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yosong6729.github.io/post/%EB%82%98%EB%A8%B8%EC%A7%80-%EA%B8%B0%EB%8A%A5/"},"publisher":{"@type":"Organization","name":"Yosong6729 Blog","logo":{"@type":"ImageObject","url":"https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yosong6729.github.io/ accesskey=h title="Yosong6729 블로그 (Alt + H)"><img src=https://yosong6729.github.io/apple-touch-icon.png alt aria-label=logo height=35>Yosong6729 블로그</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yosong6729.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://yosong6729.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yosong6729.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yosong6729.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">나머지 기능</h1><div class=post-meta><span title='2024-10-04 19:39:56 +0900 KST'>October 4, 2024</span>&nbsp;·&nbsp;yosong6729&nbsp;|&nbsp;<a href=https://github.com/yosong6729/blog/tree/main/content/post/%eb%82%98%eb%a8%b8%ec%a7%80%20%ea%b8%b0%eb%8a%a5/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#specifications%eb%aa%85%ec%84%b8 aria-label=Specifications(명세)>Specifications(명세)</a></li><li><a href=#query-by-example aria-label="Query By Example">Query By Example</a></li><li><a href=#projections aria-label=Projections>Projections</a></li><li><a href=#%eb%84%a4%ec%9d%b4%ed%8b%b0%eb%b8%8c-%ec%bf%bc%eb%a6%ac aria-label="네이티브 쿼리">네이티브 쿼리</a><ul><li><a href=#%eb%8f%99%ec%a0%81-%eb%84%a4%ec%9d%b4%ed%8b%b0%eb%b8%8c-%ec%bf%bc%eb%a6%ac aria-label="동적 네이티브 쿼리">동적 네이티브 쿼리</a></li></ul></li></ul></div></details></div><div class=post-content><blockquote><p>해당 글은 김영한님의 인프런 강의 <a href=https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%8D%B0%EC%9D%B4%ED%84%B0-JPA-%EC%8B%A4%EC%A0%84>스프링 데이터 JPA</a>을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다</p></blockquote><hr><h2 id=specifications명세>Specifications(명세)<a hidden class=anchor aria-hidden=true href=#specifications명세>#</a></h2><p>책 도메인 주도 설계(DDD)는 SPECIFICATION(명세)라는 개념을 소개한다. 스프링 데이터 JPA는 JPA Criteria를 활용해서 이 개념을 사용할 수 있도록 지원한다.</p><p><strong>술어(predicate)</strong></p><ul><li>참 또는 거짓으로 평가</li><li>AND OR 같은 연산자로 조합해서 다양한 검색조건을 쉽게 생성(컴포지트 패턴)</li><li>예) 검색 조건 하나하나</li><li>스프링 데이터 JPA는 org.springframework.data.jpa.domain.Specification클래스로 정의</li></ul><p><strong>명세 기능 사용 방법</strong></p><p><code>JpaSpecificationExecutor</code> 인터페이스 상속</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>MemberRepository</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>JpaRepository</span><span class=o>&lt;</span><span class=n>Member</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                                                    </span><span class=n>JpaSpecificationExecutor</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                                                    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>JpaSpecificationExecutor</code> 인터페이스</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>JpaSpecificationExecutor</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>Optional</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findOne</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>spec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findAll</span><span class=p>(</span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>spec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>Page</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findAll</span><span class=p>(</span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>spec</span><span class=p>,</span><span class=w> </span><span class=n>Pageable</span><span class=w> </span><span class=n>pageable</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findAll</span><span class=p>(</span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>spec</span><span class=p>,</span><span class=w> </span><span class=n>Sort</span><span class=w> </span><span class=n>sort</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=kt>long</span><span class=w> </span><span class=nf>count</span><span class=p>(</span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>spec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>위 인터페이스에서 각 메서드 들이 Specification을 파라미터로 받아서 검색 조건으로 사용한다.</p><p><strong>명세 사용 코드</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>specBasic</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//given</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Team</span><span class=w> </span><span class=n>teamA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Team</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>m1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;m1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>m2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;m2&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>m1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>m2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//when</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>spec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MemberSpec</span><span class=p>.</span><span class=na>username</span><span class=p>(</span><span class=s>&#34;m1&#34;</span><span class=p>).</span><span class=na>and</span><span class=p>(</span><span class=n>MemberSpec</span><span class=p>.</span><span class=na>teamName</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>memberRepository</span><span class=p>.</span><span class=na>findAll</span><span class=p>(</span><span class=n>spec</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Assertions</span><span class=p>.</span><span class=na>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>size</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Specification을 구현하면 명세들을 조립할수 있다. where(), and(), or(), not()을 제공한다.</p><p>findAll에서 회원 이름 명세(username)과 팀 이름 명세(teamAName)을 and로 조합해서 검색조건으로 사용한다.</p><p><code>MemberSpec</code> 명세 정의 코드</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>MemberSpec</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=nf>teamName</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>teamName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>root</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=p>,</span><span class=w> </span><span class=n>builder</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>teamName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Join</span><span class=o>&lt;</span><span class=n>Member</span><span class=p>,</span><span class=w> </span><span class=n>Team</span><span class=o>&gt;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>root</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=s>&#34;team&#34;</span><span class=p>,</span><span class=w> </span><span class=n>JoinType</span><span class=p>.</span><span class=na>INNER</span><span class=p>);</span><span class=c1>//회우너과 조인</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>equal</span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>),</span><span class=w> </span><span class=n>teamName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=nf>username</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>Specification</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>root</span><span class=p>,</span><span class=w> </span><span class=n>query</span><span class=p>,</span><span class=w> </span><span class=n>builder</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>builder</span><span class=p>.</span><span class=na>equal</span><span class=p>(</span><span class=n>root</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>),</span><span class=w> </span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>명세를 정의하려면 Specification 인터페이스를 구현해야한다. 명세를 정의할때는 toPredicate(…)메서드만 구현하면 되는데 JPA Criteria의 Root, CriteriaQuery, CriteriaBuilder 클래스를 제공한다.</p><blockquote><p>실무에서는 JPA Criteria를 거의 안쓴다. 대신에 QueryDSL을 사용하자.</p></blockquote><hr><h2 id=query-by-example>Query By Example<a hidden class=anchor aria-hidden=true href=#query-by-example>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>queryByExample</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//given</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Team</span><span class=w> </span><span class=n>teamA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Team</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>m1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;m1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>m2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;m2&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>m1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>m2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//when</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//Probe 생성</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;m1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Team</span><span class=w> </span><span class=n>team</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Team</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>//내부조인 가능</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>member</span><span class=p>.</span><span class=na>setTeam</span><span class=p>(</span><span class=n>team</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//ExampleMatcher 생성, age 프로퍼티는 무시</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ExampleMatcher</span><span class=w> </span><span class=n>matcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ExampleMatcher</span><span class=p>.</span><span class=na>matching</span><span class=p>().</span><span class=na>withIgnorePaths</span><span class=p>(</span><span class=s>&#34;age&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Example</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>example</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Example</span><span class=p>.</span><span class=na>of</span><span class=p>(</span><span class=n>member</span><span class=p>,</span><span class=w> </span><span class=n>matcher</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>memberRepository</span><span class=p>.</span><span class=na>findAll</span><span class=p>(</span><span class=n>example</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>).</span><span class=na>getUsername</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;m1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>장점</strong></p><ul><li>동적 쿼리를 편리하게 처리</li><li>도메인 객체를 그대로 사용</li><li>데이터 저장소를 RDB에서 NOSQL로 변경해도 코드 변경이 없게 추상화 되어 있음</li><li>스프링 데이터 JPA JpaRepository 인터페이스에 이미 포함</li></ul><p><strong>단점</strong></p><ul><li>조인은 가능하지만 내부 조인(INNER JOIN)만 가능함 외부 조인(LEFT JOIN) 안됨</li><li>중첩 제약조건 안됨</li><li>매칭 조건이 매우 단순함</li></ul><p><strong>정리</strong></p><ul><li>실무에서 사용하기에는 매칭 조건이 너무 단순하고, LEFT 조인이 안됨, 실무에서는 QueryDSL을 사용하자</li></ul><hr><h2 id=projections>Projections<a hidden class=anchor aria-hidden=true href=#projections>#</a></h2><p><a href=https://docs.spring.io/spring-data/jpa/reference/repositories/projections.html>공식 문서 참고</a></p><p>엔티티 대신에 DTO를 편리하게 조회할때 사용한다.</p><p>전체 엔티티가 아니라 만약 회원 이름만 조회하고 싶으면 어떻게 해야할까?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UsernameOnly</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=nf>getUsername</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>조회할 엔티티의 필드를 getter혀익으로 지정하면 해달 필드만선택해서 조회(Projection)한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>MemberRepository</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>UsernameOnly</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findProjectionsByUsername</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>반환 타입을 UsernameOnly 인터페이스 명으로 해준다.</p><p><strong>테스트 코드</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>projections</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//given</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Team</span><span class=w> </span><span class=n>teamA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Team</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Member</span><span class=w> </span><span class=n>m1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;m1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Member</span><span class=w> </span><span class=n>m2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;m2&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>m1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>m2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//when</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>UsernameOnly</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>memberRepository</span><span class=p>.</span><span class=na>findProjectionsByUsername</span><span class=p>(</span><span class=s>&#34;m1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//then</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Assertions</span><span class=p>.</span><span class=na>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>size</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><img loading=lazy src=images/image.png alt=image.png></p><p>SQL에서도 select절에서 username만 조회(Projection)하는 것을 확인 할수 있다.</p><p><strong>인터페이스 기반 Closed Projections</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UsernameOnly</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=nf>getUsername</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>프로퍼티 형식(getter)의 인터페이스를 제공하면 구현체는 스프링 데이토 JPA가 제공해준다.</p><p><strong>인터페이스 기반 Open Projections</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UsernameOnly</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Value</span><span class=p>(</span><span class=s>&#34;#{target.username + &#39; &#39; + target.age + &#39; &#39; + target.team.name}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=nf>getUsername</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>위 처럼 스프링의 SpEL 문법도 지원한다.</p><p>하지만 SpEL문법을 사용하면 DB에서 엔티티 필드를 다 조회해온다음에 계산한다. 따라서 JPQL SELET 절 최적화가 안된다. 다음은 SQL 결과에서 확인 할수 있다.</p><p><img loading=lazy src=images/image%201.png alt=image.png></p><p><strong>클래스 기반 Projection</strong></p><p>다음과 같이 인터페이스가 아닌 구체적인 DTO 형식도 가능하다. 생성자의 파라미터 이름으로 매칭된다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>UsernameOnlyDto</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>UsernameOnlyDto</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getUsername</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>username</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>동적 Projections</strong></p><p>다음과 같이 Generic Type을 주면, 동적으로 프로젝션 데이터 변경이 가능하다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findProjectionsByUsername</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>type</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//사용 코드</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>UsernameOnly</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>memberRepository</span><span class=p>.</span><span class=na>findProjectionsByUsername</span><span class=p>(</span><span class=s>&#34;m1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>UsernameOnly</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p><strong>중첩 구조 처리</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>NestedClosedProjection</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=nf>getUsername</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TeamInfo</span><span class=w> </span><span class=nf>getTeam</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>interface</span> <span class=nc>TeamInfo</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=nf>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과</p><p><img loading=lazy src=images/image%202.png alt=image.png></p><p><strong>주의</strong></p><ul><li>프로젝션 대상이 root 엔티티면 JPQL SELECT 절 최적화가 가능하다.</li><li>프로젝션 대상이 root가 아니면<ul><li>Left outer join 처리</li><li>위 쿼리 결과 처럼 모든 필드를 SELECT해서 엔티티로 조회한 다음에 계산</li></ul></li></ul><p><strong>정리</strong></p><ul><li>프로젝션 대상이 root엔티티면 유용하지만 프로젝션 대상이 root엔티티를 넘어가면 JPQL SELECT 최적화가 되지 않는다.</li><li>실무의 복잡한 쿼리를 해결하기에는 한계가 있어서 단순할때만 사용하고 조금 복잡해지면 QueryDSL을 사용하자</li></ul><hr><h2 id=네이티브-쿼리>네이티브 쿼리<a hidden class=anchor aria-hidden=true href=#네이티브-쿼리>#</a></h2><p>가급적 네이티브 쿼리는 사용하지 않는 게 좋고 정말 어쩔수 없는 경우에만 사용한다.</p><p>스프링 데이터 Projections를 활용하는 방법은 좋은 방법이다.</p><p><strong>스프링 데이터 JPA 기반 네이티브 쿼리</strong></p><ul><li><p>페이징 지원</p></li><li><p>반환 타입</p><ul><li>Object[]</li><li>Tuple</li><li>DTO(스프링 데이터 인터페이스 Projections 지원)</li></ul><p>DTO 반환 방식을 권장한다.</p></li><li><p>제약</p><ul><li>Sort 파라미터를 통한 정렬이 정상 동작하지 않을 수 있음(믿지 말고 직접 처리)</li><li>JPQL처럼 애플리케이션 로딩 시점에 문법 확인 불가</li><li>동적 쿼리 불가</li></ul></li></ul><p><strong>JPA 네이티브 SQL 지원</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>MemberRepository</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>JpaRepository</span><span class=o>&lt;</span><span class=n>Member</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Query</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;select * from member where username = ?&#34;</span><span class=p>,</span><span class=w> </span><span class=n>nativeQuery</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Member</span><span class=w> </span><span class=nf>findByNativeQuery</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과</p><p><img loading=lazy src=images/image%203.png alt=image.png></p><p>네이티브 SQL의 위치 기반 파라미터는 0부터 시작(JPQL은 1부터 시작)한다.</p><ul><li>네이티브 SQL을 엔티티가 아닌 DTO로 변환하려면<ul><li>DTO 대신 JPA TUPLE 조회</li><li>DTO 대신 MAP 조회</li><li>@SqlResultSetMapping 복잡</li><li>Hibernate ResultTransformer를 사용해야함 복잡</li><li>네이티브 SQL을 DTO로 조회할 때는 <strong>JdbcTemplate</strong> or myBatis 권장</li></ul></li></ul><p><strong>Projections 활용</strong></p><p>DTO로 반환하려는데 편리하고, nativeQuery면서 동적쿼리가 아닌 경우에 사용해도 좋다. 그리고 페이징이 가능하다.</p><p>ex)스프링 데이터 JPA 네이티브 쿼리 + 인터페이스 기반 Projections 활용</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Query</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;SELECT m.member_id as id, m.username, t.name as teamName &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;FROM member m left join team t ON m.team_id = t.team_id&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>countQuery</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;SELECT count(*) from member&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>nativeQuery</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Page</span><span class=o>&lt;</span><span class=n>MemberProjection</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findByNativeProjection</span><span class=p>(</span><span class=n>Pageable</span><span class=w> </span><span class=n>pageable</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과</p><p><img loading=lazy src=images/image%204.png alt=image.png></p><p><img loading=lazy src=images/image%205.png alt=image.png></p><h3 id=동적-네이티브-쿼리>동적 네이티브 쿼리<a hidden class=anchor aria-hidden=true href=#동적-네이티브-쿼리>#</a></h3><ul><li>하이버네이트 직접 사용</li><li>스프링 JdbcTemplate, myBatis, jooq같은 외부 라이브러리 사용</li></ul><p>ex) 하이버네이트 기능 사용</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>sql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;select m.username as username from member m&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>MemberDto</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createNativeQuery</span><span class=p>(</span><span class=n>sql</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>setFirstResult</span><span class=p>(</span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>setMaxResults</span><span class=p>(</span><span class=n>10</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>unwrap</span><span class=p>(</span><span class=n>NativeQuery</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>addScalar</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>setResultTransformer</span><span class=p>(</span><span class=n>Transformers</span><span class=p>.</span><span class=na>aliasToBean</span><span class=p>(</span><span class=n>MemberDto</span><span class=p>.</span><span class=na>class</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://yosong6729.github.io/tags/spring-data-jpa/>Spring Data JPA</a></li></ul><nav class=paginav><a class=prev href=https://yosong6729.github.io/post/querydsl---%EA%B8%B0%EB%B3%B8-%EB%AC%B8%EB%B2%95/><span class=title>« Prev</span><br><span>[Querydsl]기본 문법</span>
</a><a class=next href=https://yosong6729.github.io/post/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%8D%B0%EC%9D%B4%ED%84%B0-jpa-%EA%B5%AC%ED%98%84%EC%B2%B4-%EB%B6%84%EC%84%9D/><span class=title>Next »</span><br><span>스프링 데이터 JPA 구현체 분석</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://yosong6729.github.io/>Yosong6729 Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>