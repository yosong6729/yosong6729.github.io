<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[자바 ORM 표준 JPA 프로그래밍 - 기본편] 객체지향 쿼리 언어2 - 중급문법 | Yosong6729 Blog</title>
<meta name=keywords content="JPA"><meta name=description content="해당 글은 김영한님의 인프런 강의 자바 ORM 표준 JPA 프로그래밍 - 기본편을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
JPQL - 경로 표현식 경로 표현식은 .(점)을 찍어 객체 그래프를 탐색하는 것이다.
select m.username -> 상태 필드 from Member m join m.team t -> 단일 값 연관 필드 join m.orders o -> 컬렉션 값 연관 필드 where t.name = '팀A' 경로 표현식 용어 정리 상태 필드(state field): 단순히 값을 저장하기 위한 필드(ex: m."><meta name=author content="yosong6729"><link rel=canonical href=https://yosong6729.github.io/post/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5-%EC%BF%BC%EB%A6%AC-%EC%96%B8%EC%96%B42---%EC%A4%91%EA%B8%89%EB%AC%B8%EB%B2%95/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://yosong6729.github.io/post/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5-%EC%BF%BC%EB%A6%AC-%EC%96%B8%EC%96%B42---%EC%A4%91%EA%B8%89%EB%AC%B8%EB%B2%95/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="[자바 ORM 표준 JPA 프로그래밍 - 기본편] 객체지향 쿼리 언어2 - 중급문법"><meta property="og:description" content="해당 글은 김영한님의 인프런 강의 자바 ORM 표준 JPA 프로그래밍 - 기본편을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
JPQL - 경로 표현식 경로 표현식은 .(점)을 찍어 객체 그래프를 탐색하는 것이다.
select m.username -> 상태 필드 from Member m join m.team t -> 단일 값 연관 필드 join m.orders o -> 컬렉션 값 연관 필드 where t.name = '팀A' 경로 표현식 용어 정리 상태 필드(state field): 단순히 값을 저장하기 위한 필드(ex: m."><meta property="og:type" content="article"><meta property="og:url" content="https://yosong6729.github.io/post/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5-%EC%BF%BC%EB%A6%AC-%EC%96%B8%EC%96%B42---%EC%A4%91%EA%B8%89%EB%AC%B8%EB%B2%95/"><meta property="og:image" content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-09-19T16:32:07+09:00"><meta property="article:modified_time" content="2024-09-19T16:32:07+09:00"><meta property="og:site_name" content="Yosong6729 Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="[자바 ORM 표준 JPA 프로그래밍 - 기본편] 객체지향 쿼리 언어2 - 중급문법"><meta name=twitter:description content="해당 글은 김영한님의 인프런 강의 자바 ORM 표준 JPA 프로그래밍 - 기본편을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
JPQL - 경로 표현식 경로 표현식은 .(점)을 찍어 객체 그래프를 탐색하는 것이다.
select m.username -> 상태 필드 from Member m join m.team t -> 단일 값 연관 필드 join m.orders o -> 컬렉션 값 연관 필드 where t.name = '팀A' 경로 표현식 용어 정리 상태 필드(state field): 단순히 값을 저장하기 위한 필드(ex: m."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yosong6729.github.io/post/"},{"@type":"ListItem","position":2,"name":"[자바 ORM 표준 JPA 프로그래밍 - 기본편] 객체지향 쿼리 언어2 - 중급문법","item":"https://yosong6729.github.io/post/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5-%EC%BF%BC%EB%A6%AC-%EC%96%B8%EC%96%B42---%EC%A4%91%EA%B8%89%EB%AC%B8%EB%B2%95/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[자바 ORM 표준 JPA 프로그래밍 - 기본편] 객체지향 쿼리 언어2 - 중급문법","name":"[자바 ORM 표준 JPA 프로그래밍 - 기본편] 객체지향 쿼리 언어2 - 중급문법","description":"해당 글은 김영한님의 인프런 강의 자바 ORM 표준 JPA 프로그래밍 - 기본편을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\nJPQL - 경로 표현식 경로 표현식은 .(점)을 찍어 객체 그래프를 탐색하는 것이다.\nselect m.username -\u0026gt; 상태 필드 from Member m join m.team t -\u0026gt; 단일 값 연관 필드 join m.orders o -\u0026gt; 컬렉션 값 연관 필드 where t.name = \u0026#39;팀A\u0026#39; 경로 표현식 용어 정리 상태 필드(state field): 단순히 값을 저장하기 위한 필드(ex: m.","keywords":["JPA"],"articleBody":" 해당 글은 김영한님의 인프런 강의 자바 ORM 표준 JPA 프로그래밍 - 기본편을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\nJPQL - 경로 표현식 경로 표현식은 .(점)을 찍어 객체 그래프를 탐색하는 것이다.\nselect m.username -\u003e 상태 필드 from Member m join m.team t -\u003e 단일 값 연관 필드 join m.orders o -\u003e 컬렉션 값 연관 필드 where t.name = '팀A' 경로 표현식 용어 정리 상태 필드(state field): 단순히 값을 저장하기 위한 필드(ex: m.username) 연관 필드(association field): 연관관계를 위한 필드 단일 값 연관 필드: @ManyToOne, @OneToOne, 대상이 엔티티(ex: m.team) 컬렉션 값 연관 필드: @OneToMany, @ManyToMany, 대상이 컬렉션(ex: m.orders) 경로 표현식 특징 상태 필드(state field): 경로 탐색의 끝, 탐색X\n더이상 m.username.~~로 이어질수 없다. 단일 값 연관 경로: 묵시적 내부 조인(inner join) 발생, 탐색O\n컬렉션 값 연관 경로: 묵시적 내부 조인 발생, 탐색X\nFROM 절에서 명시적 조인을 통해 별칭을 얻으면 별칭을 통해 탐색 가능 String query = \"select m From Team t join t.members m\"; 실무에서는 묵시적 조인보다 명시적 조인을 쓰는게 좋다.명시적 조인을 써야 실제 쿼리 튜닝도 쉬복 JPQL을 튜닝하면 쿼리가 튜닝되기 때문이다.\n상태 필드 경로 탐색 JPQL: select m.username, m.age from Member m SQL: select m.username, m.age from Member m 단일 값 연관 경로 탐색 JPQL: select o.member from Order o SQL: select m.*\nfrom Orders o\ninner join Member m on o.member_id = m.id 묵시적 조인이 발생한다.\n명시적 조인, 묵시적 조인 명시적 조인: join 키워드 직접 사용 select m from Member m join m.team t 묵시적 조인: 경로 표현식에 의해 묵시적으로 SQL 조인 발생 (내부 조인만 가능) select m.team from Member m 경로 표현식 - 예제 select o.member.team from Order o -\u003e 성공\n묵시적 조인이 2번 발생한다.\nselect t.members from Team -\u003e 성공\nmembers가 컬렉션이지만 t.member에서 끝났기때문에 성공\nselect t.members.username from Team t -\u003e 실패\nmembers 컬렉션에서 한번더 값을 조회하는건 불가능\nselect m.username from Team t join t.members m -\u003e 성공\njoin t.member로 명시적 조인으로 가져오고 별칭 m을 을 사용해서 m.username으로 했기때문에 성공\n경로 탐색을 사용한 묵시적 조인 시 주의사항 항상 내부 조인 컬렉션은 경로 탐색의 끝, 명시적 조인을 통해 별칭을 얻어야함 경로 탐색은 주로 SELECT, WHERE 절에서 사용하지만 묵시적 조인으로 인해 SQL의 FROM (JOIN) 절에 영향을 줌 실무 조언 가급적 묵시적 조인 대신에 명시적 조인 사용 조인은 SQL 튜닝에 중요 포인트 묵시적 조인은 조인이 일어나는 상황을 한눈에 파악하기 어려움 JPQL - 페치 조인(fetch join) 페치 조인은 실무에서 정말 중요하다.\n페치 조인(fetch join) SQL 조인 종류X JPQL에서 성능 최적화를 위해 제공하는 기능 연관된 엔티티나 컬렉션을 SQL 한 번에 함께 조회하는 기능 join fetch 명령어 사용 페치 조인 ::= [ LEFT [OUTER] | INNER ] JOIN FETCH 조인경로 엔티티 페치 조인 회원을 조회하면서 연관된 팀도 함께 조회(SQL 한 번에) SQL을 보면 회원 뿐만 아니라 팀(T)\r도 함께 SELECT [JPQL] select m from Member m join fetch m.team [SQL] SELECT M.*, T.* FROM MEMBER M INNER JOIN TEAM T ON M.TEAM_ID=T.ID 페치 조인 사용 코드 String jpql = \"select m from Member m join fetch m.team\"; List\u003cMember\u003e members = em.createQuery(jpql, Member.class) .getResultList(); for (Member member : members) { //페치 조인으로 회원과 팀을 함께 조회해서 지연 로딩X System.out.println(\"username = \" + member.getUsername() + \", \" + \"teamName = \" + member.getTeam().name()); } username = 회원1, teamname = 팀A\nusername = 회원2, teamname = 팀A\nusername = 회원3, teamname = 팀B\n컬렉션 페치 조인 일대다 관계, 컬렉션 페치 조인 [JPQL] select t from Team t join fetch t.members where t.name = ‘팀A' [SQL] SELECT T.*, M.* FROM TEAM T INNER JOIN MEMBER M ON T.ID=M.TEAM_ID WHERE T.NAME = '팀A' 컬렉션 페치 조인 사용 코드 String jpql = \"select t from Team t join fetch t.members where t.name = '팀A'\" List\u003cTeam\u003e teams = em.createQuery(jpql, Team.class).getResultList(); for(Team team : teams) { System.out.println(\"teamname = \" + team.getName() + \", team = \" + team); for (Member member : team.getMembers()) { //페치 조인으로 팀과 회원을 함께 조회해서 지연 로딩 발생 안함 System.out.println(\"-\u003e username = \" + member.getUsername()+ \", member = \" + member); } } teamname = 팀A, team = Team@0x100\n-\u003e username = 회원1, member = Member@0x200\n-\u003e username = 회원2, member = Member@0x300\nteamname = 팀A, team = Team@0x100\n-\u003e username = 회원1, member = Member@0x200\n-\u003e username = 회원2, member = Member@0x300\n페치 조인과 DISTINCT SQL의 DISTINCT는 중복된 결과를 제거하는 명령 JPQL의 DISTINCT 2가지 기능 제공 SQL에 DISTINCT를 추가 애플리케이션에서 엔티티 중복 제거 페치 조인과 DISTINCT select distinct t\nfrom Team t join fetch t.members\nwhere t.name = ‘팀A’ SQL에 DISTINCT를 추가하지만 데이터가 다르므로 SQL 결과에서 중복제거 실패 DISTINCT가 추가로 애플리케이션에서 중복 제거시도 같은 식별자를 가진 Team 엔티티 제거 [DISTINCT 추가시 결과]\nteamname = 팀A, team = Team@0x100\n-\u003e username = 회원1, member = Member@0x200\n-\u003e username = 회원2, member = Member@0x300\n하이버네이트6 변경 사항 DISTINCT가 추가로 애플리케이션에서 중복 제거시도 -\u003e 하이버네이트6 부터는 DISTINCT 명령어를 사용하지 않아도 애플리케이션에서 중복 제거가 자동으로 적용됩니다. 페치 조인과 일반 조인의 차이 일반 조인 실행시 연관된 엔티티를 함께 조회하지 않음 [JPQL] select t from Team t join t.members m where t.name = ‘팀A' [SQL] SELECT T.* FROM TEAM T INNER JOIN MEMBER M ON T.ID=M.TEAM_ID WHERE T.NAME = '팀A' 페치 조인과 일반 조인의 차이 JPQL은 결과를 반환할 때 연관관계 고려X 단지 SELECT 절에 지정한 엔티티만 조회할 뿐 여기서는 팀 엔티티만 조회하고, 회원 엔티티는 조회X 페치 조인을 사용할 때만 연관된 엔티티도 함께 조회(즉시 로딩) 페치 조인은 객체 그래프를 SQL 한번에 조회하는 개념 페치 조인 실행 예시 페치 조인은 연관된 엔티티를 함께 조회함 [JPQL] select t from Team t join fetch t.members where t.name = ‘팀A' [SQL] SELECT T.*, M.* FROM TEAM T INNER JOIN MEMBER M ON T.ID=M.TEAM_ID WHERE T.NAME = '팀A 페치 조인의 특징과 한계 페치 조인 대상에는 별칭을 줄 수 없다.\n하이버네이트는 가능, 가급적 사용X String query = \"select t From Team t join fetch t.member m\" // join fetch t.members m 불가능 패치 조인은 기본적으로 연관된 것들을 다 가져오는 거다. 하지만 별칭을 사용해서 성능상 중간에 몇개를 걸러서 가지고 오고싶어서 where절에 별칭을 통한 조건을 넣고 조회하면 잘못 조작하면 나중에 이상하게 동작할수 있다.\n둘 이상의 컬렉션은 페치 조인 할 수 없다.\n일대다대다 이기때문에 데이터가 예상치 못하게 늘어날수 있다. 컬렉션을 페치 조인하면 페이징 API(setFirstResult, setMaxResults)를 사용할 수 없다.\n일대일, 다대일 같은 단일 값 연관 필드들은 페치 조인해도 페이징 가능 하이버네이트는 경고 로그를 남기고 메모리에서 페이징(매우 위험) 페치 조인의 특징과 한계 연관된 엔티티들을 SQL 한 번으로 조회 - 성능 최적화 엔티티에 직접 적용하는 글로벌 로딩 전략보다 우선함 @OneToMany(fetch = FetchType.LAZY) //글로벌 로딩 전략 실무에서 글로벌 로딩 전략은 모두 지연 로딩 최적화가 필요한 곳은 페치 조인 적용 페치 조인 - 정리 모든 것을 페치 조인으로 해결할 수 는 없음 페치 조인은 객체 그래프를 유지할 때 사용하면 효과적 여러 테이블을 조인해서 엔티티가 가진 모양이 아닌 전혀 다른결과를 내야 하면, 페치 조인 보다는 일반 조인을 사용하고 필요한 데이터들만 조회해서 DTO로 반환하는 것이 효과적 페치 조인 3가지 방법 엔티티를 패치 조인을 사용해서 조회 패치 조인을 하고 애플리케이션에서 DTO로 바꿔서 화면에 반환 JPA 작성할때부터 DTO로 스위칭 JPQL - 다형성 쿼리 TYPE 조회 대상을 특정 자식으로 한정 예) Item 중에 Book, Movie를 조회해라 [JPQL] select i from Item i where type(i) IN (Book, Movie) [SQL] select i from i where i.DTYPE in (‘B’, ‘M’) TREAT(JPA 2.1) 자바의 타입 캐스팅과 유사 상속 구조에서 부모 타입을 특정 자식 타입으로 다룰 때 사용 FROM, WHERE, SELECT(하이버네이트 지원) 사용 예) 부모인 Item과 자식 Book이 있다. [JPQL] select i from Item i where treat(i as Book).author = ‘kim’ [SQL] select i.* from Item i where i.DTYPE = ‘B’ and i.author = ‘kim’ JPQL - 엔티티 직접 사용 엔티티 직접 사용 - 기본 키 값 JPQL에서 엔티티를 직접 사용하면 SQL에서 해당 엔티티의 기본 키 값을 사용 [JPQL] select count(m.id) from Member m //엔티티의 아이디를 사용 select count(m) from Member m //엔티티를 직접 사용 [SQL](JPQL 둘다 같은 다음 SQL 실행) select count(m.id) as cnt from Member m 엔티티를 파라미터로 전달\nString jpql = \"select m from Member m where m = :member\"; List resultList = em.createQuery(jpql) .setParameter(\"member\", member) .getResultList(); 식별자를 직접 전달\nString jpql = \"select m from Member m where m.id = :memberId\"; List resultList = em.createQuery(jpql) .setParameter(\"memberId\", memberId) .getResultList(); 실행된 SQL\nselect m.* from Member m where m.id=? 엔티티를 파라미터로 전달한것과 식별자를 직접 전달한것의 실행된 SQL은 동일하다. 엔티티가 DB에 넘어가면 DB의 PK값이기 때문이다.\n엔티티 직접 사용- 외래 키 값 Team team = em.find(Team.class, 1L); String qlString = \"select m from Member m where m.team = :team\"; List resultList = em.createQuery(qlString) .setParameter(\"team\", team) .getResultList(); String qlString = \"select m from Member m where m.team.id = :teamId\"; List resultList = em.createQuery(qlString) .setParameter(\"teamId\", teamId) .getResultList(); 파라미터로 넘긴 Team은 PK이고, m.team은 DB 입장에서는 FK와 맵핑 된다.\n실행된 SQL\nselect m.* from Member m where m.team_id=? JPQL - Named 쿼리 Named 쿼리 - 정적 쿼리 미리 정의해서 이름을 부여해두고 사용하는 JPQL\n정적 쿼리\n어노테이션, XML에 정의\n애플리케이션 로딩 시점에 초기화 후 재사용\n애플리케이션 로딩 시점에 쿼리를 검증\n만약 “select m from MemberQQQ … ”처럼 문법 오류가나면 로딩 시점에 오류가 발생한다.\nNamed 쿼리 - 어노테이션 @Entity @NamedQuery( name = \"Member.findByUsername\", query=\"select m from Member m where m.username = :username\") public class Member { ... } List\u003cMember\u003e resultList = em.createNamedQuery(\"Member.findByUsername\", Member.class) .setParameter(\"username\", \"회원1\") .getResultList(); Named 쿼리 어노테이션을 사용하면 멤버 엔티티가 너무 지저분해지고 실무에서는 아래 코드처럼 Spring Data JPA를 섞어쓰기때문에 비추천한다. 아래도 어플리케이션 로딩 시점에 검증이 된다.\n//Spring Dat JPA 공식 문서에 있는 예시 중 하나이다. public interface UserReposior extends JpaRepository\u003cUser, Long\u003e { @Query(\"select u from User u where u.emailAddress = ?1\") User findByEmailAddress(String emailAddress); } JPQL - 벌크 연산 벌크 연산 재고가 10개 미만인 모든 상품의 가격을 10% 상승하려면? JPA 변경 감지 기능으로 실행하려면 너무 많은 SQL 실행 재고가 10개 미만인 상품을 리스트로 조회한다. 상품 엔티티의 가격을 10% 증가한다. 트랜잭션 커밋 시점에 변경감지가 동작한다. 변경된 데이터가 100건이라면 100번의 UPDATE SQL 실행 벌크 연산 예제 쿼리 한 번으로 여러 테이블 로우 변경(엔티티) executeUpdate()의 결과는 영향받은 엔티티 수 반환 UPDATE, DELETE 지원 INSERT(insert into .. select, 하이버네이트 지원) String qlString = \"update Product p \" + \"set p.price = p.price * 1.1 \" + \"where p.stockAmount \u003c :stockAmount\"; int resultCount = em.createQuery(qlString) .setParameter(\"stockAmount\", 10) .executeUpdate(); 벌크 연산 주의 벌크 연산은 영속성 컨텍스트를 무시하고 데이터베이스에 직접 쿼리\n벌크 연산을 먼저 실행하고 벌크 연산 수행후 영속성 컨텍스트 초기화를 하면된다.\n","wordCount":"1639","inLanguage":"en","image":"https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-09-19T16:32:07+09:00","dateModified":"2024-09-19T16:32:07+09:00","author":{"@type":"Person","name":"yosong6729"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yosong6729.github.io/post/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5-%EC%BF%BC%EB%A6%AC-%EC%96%B8%EC%96%B42---%EC%A4%91%EA%B8%89%EB%AC%B8%EB%B2%95/"},"publisher":{"@type":"Organization","name":"Yosong6729 Blog","logo":{"@type":"ImageObject","url":"https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yosong6729.github.io/ accesskey=h title="Yosong6729 블로그 (Alt + H)"><img src=https://yosong6729.github.io/apple-touch-icon.png alt aria-label=logo height=35>Yosong6729 블로그</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yosong6729.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://yosong6729.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yosong6729.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yosong6729.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">[자바 ORM 표준 JPA 프로그래밍 - 기본편] 객체지향 쿼리 언어2 - 중급문법</h1><div class=post-meta><span title='2024-09-19 16:32:07 +0900 KST'>September 19, 2024</span>&nbsp;·&nbsp;yosong6729&nbsp;|&nbsp;<a href=https://github.com/yosong6729/blog/tree/main/content/post/%ea%b0%9d%ec%b2%b4%ec%a7%80%ed%96%a5%20%ec%bf%bc%eb%a6%ac%20%ec%96%b8%ec%96%b42%20-%20%ec%a4%91%ea%b8%89%eb%ac%b8%eb%b2%95/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#jpql---%ea%b2%bd%eb%a1%9c-%ed%91%9c%ed%98%84%ec%8b%9d aria-label="JPQL - 경로 표현식">JPQL - 경로 표현식</a><ul><li><a href=#%ea%b2%bd%eb%a1%9c-%ed%91%9c%ed%98%84%ec%8b%9d-%ec%9a%a9%ec%96%b4-%ec%a0%95%eb%a6%ac aria-label="경로 표현식 용어 정리">경로 표현식 용어 정리</a></li><li><a href=#%ea%b2%bd%eb%a1%9c-%ed%91%9c%ed%98%84%ec%8b%9d-%ed%8a%b9%ec%a7%95 aria-label="경로 표현식 특징">경로 표현식 특징</a></li><li><a href=#%ec%83%81%ed%83%9c-%ed%95%84%eb%93%9c-%ea%b2%bd%eb%a1%9c-%ed%83%90%ec%83%89 aria-label="상태 필드 경로 탐색">상태 필드 경로 탐색</a></li><li><a href=#%eb%8b%a8%ec%9d%bc-%ea%b0%92-%ec%97%b0%ea%b4%80-%ea%b2%bd%eb%a1%9c-%ed%83%90%ec%83%89 aria-label="단일 값 연관 경로 탐색">단일 값 연관 경로 탐색</a></li><li><a href=#%eb%aa%85%ec%8b%9c%ec%a0%81-%ec%a1%b0%ec%9d%b8-%eb%ac%b5%ec%8b%9c%ec%a0%81-%ec%a1%b0%ec%9d%b8 aria-label="명시적 조인, 묵시적 조인">명시적 조인, 묵시적 조인</a></li><li><a href=#%ea%b2%bd%eb%a1%9c-%ed%91%9c%ed%98%84%ec%8b%9d---%ec%98%88%ec%a0%9c aria-label="경로 표현식 - 예제">경로 표현식 - 예제</a></li><li><a href=#%ea%b2%bd%eb%a1%9c-%ed%83%90%ec%83%89%ec%9d%84-%ec%82%ac%ec%9a%a9%ed%95%9c-%eb%ac%b5%ec%8b%9c%ec%a0%81-%ec%a1%b0%ec%9d%b8-%ec%8b%9c-%ec%a3%bc%ec%9d%98%ec%82%ac%ed%95%ad aria-label="경로 탐색을 사용한 묵시적 조인 시 주의사항">경로 탐색을 사용한 묵시적 조인 시 주의사항</a></li><li><a href=#%ec%8b%a4%eb%ac%b4-%ec%a1%b0%ec%96%b8 aria-label="실무 조언">실무 조언</a></li></ul></li><li><a href=#jpql---%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8fetch-join aria-label="JPQL - 페치 조인(fetch join)">JPQL - 페치 조인(fetch join)</a><ul><li><a href=#%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8fetch-join aria-label="페치 조인(fetch join)">페치 조인(fetch join)</a></li><li><a href=#%ec%97%94%ed%8b%b0%ed%8b%b0-%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8 aria-label="엔티티 페치 조인">엔티티 페치 조인</a></li><li><a href=#%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8-%ec%82%ac%ec%9a%a9-%ec%bd%94%eb%93%9c aria-label="페치 조인 사용 코드">페치 조인 사용 코드</a></li><li><a href=#%ec%bb%ac%eb%a0%89%ec%85%98-%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8 aria-label="컬렉션 페치 조인">컬렉션 페치 조인</a></li><li><a href=#%ec%bb%ac%eb%a0%89%ec%85%98-%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8-%ec%82%ac%ec%9a%a9-%ec%bd%94%eb%93%9c aria-label="컬렉션 페치 조인 사용 코드">컬렉션 페치 조인 사용 코드</a></li><li><a href=#%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8%ea%b3%bc-distinct aria-label="페치 조인과 DISTINCT">페치 조인과 DISTINCT</a></li><li><a href=#%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8%ea%b3%bc-distinct-1 aria-label="페치 조인과 DISTINCT">페치 조인과 DISTINCT</a></li><li><a href=#%ed%95%98%ec%9d%b4%eb%b2%84%eb%84%a4%ec%9d%b4%ed%8a%b86-%eb%b3%80%ea%b2%bd-%ec%82%ac%ed%95%ad aria-label="하이버네이트6 변경 사항">하이버네이트6 변경 사항</a></li><li><a href=#%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8%ea%b3%bc-%ec%9d%bc%eb%b0%98-%ec%a1%b0%ec%9d%b8%ec%9d%98-%ec%b0%a8%ec%9d%b4 aria-label="페치 조인과 일반 조인의 차이">페치 조인과 일반 조인의 차이</a></li><li><a href=#%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8%ea%b3%bc-%ec%9d%bc%eb%b0%98-%ec%a1%b0%ec%9d%b8%ec%9d%98-%ec%b0%a8%ec%9d%b4-1 aria-label="페치 조인과 일반 조인의 차이">페치 조인과 일반 조인의 차이</a></li><li><a href=#%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8-%ec%8b%a4%ed%96%89-%ec%98%88%ec%8b%9c aria-label="페치 조인 실행 예시">페치 조인 실행 예시</a></li><li><a href=#%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8%ec%9d%98-%ed%8a%b9%ec%a7%95%ea%b3%bc-%ed%95%9c%ea%b3%84 aria-label="페치 조인의 특징과 한계">페치 조인의 특징과 한계</a></li><li><a href=#%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8%ec%9d%98-%ed%8a%b9%ec%a7%95%ea%b3%bc-%ed%95%9c%ea%b3%84-1 aria-label="페치 조인의 특징과 한계">페치 조인의 특징과 한계</a></li><li><a href=#%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8---%ec%a0%95%eb%a6%ac aria-label="페치 조인 - 정리">페치 조인 - 정리</a></li></ul></li><li><a href=#jpql---%eb%8b%a4%ed%98%95%ec%84%b1-%ec%bf%bc%eb%a6%ac aria-label="JPQL - 다형성 쿼리">JPQL - 다형성 쿼리</a><ul><li><a href=#type aria-label=TYPE>TYPE</a></li><li><a href=#treatjpa-21 aria-label="TREAT(JPA 2.1)">TREAT(JPA 2.1)</a></li><li><a href=#jpql---%ec%97%94%ed%8b%b0%ed%8b%b0-%ec%a7%81%ec%a0%91-%ec%82%ac%ec%9a%a9 aria-label="JPQL - 엔티티 직접 사용">JPQL - 엔티티 직접 사용</a></li></ul></li><li><a href=#%ec%97%94%ed%8b%b0%ed%8b%b0-%ec%a7%81%ec%a0%91-%ec%82%ac%ec%9a%a9---%ea%b8%b0%eb%b3%b8-%ed%82%a4-%ea%b0%92 aria-label="엔티티 직접 사용 - 기본 키 값">엔티티 직접 사용 - 기본 키 값</a><ul><li><a href=#%ec%97%94%ed%8b%b0%ed%8b%b0-%ec%a7%81%ec%a0%91-%ec%82%ac%ec%9a%a9--%ec%99%b8%eb%9e%98-%ed%82%a4-%ea%b0%92 aria-label="엔티티 직접 사용- 외래 키 값">엔티티 직접 사용- 외래 키 값</a></li></ul></li><li><a href=#jpql---named-%ec%bf%bc%eb%a6%ac aria-label="JPQL - Named 쿼리">JPQL - Named 쿼리</a><ul><li><a href=#named-%ec%bf%bc%eb%a6%ac---%ec%a0%95%ec%a0%81-%ec%bf%bc%eb%a6%ac aria-label="Named 쿼리 - 정적 쿼리">Named 쿼리 - 정적 쿼리</a></li><li><a href=#named-%ec%bf%bc%eb%a6%ac---%ec%96%b4%eb%85%b8%ed%85%8c%ec%9d%b4%ec%85%98 aria-label="Named 쿼리 - 어노테이션">Named 쿼리 - 어노테이션</a></li></ul></li><li><a href=#jpql---%eb%b2%8c%ed%81%ac-%ec%97%b0%ec%82%b0 aria-label="JPQL - 벌크 연산">JPQL - 벌크 연산</a><ul><li><a href=#%eb%b2%8c%ed%81%ac-%ec%97%b0%ec%82%b0 aria-label="벌크 연산">벌크 연산</a></li><li><a href=#%eb%b2%8c%ed%81%ac-%ec%97%b0%ec%82%b0-%ec%98%88%ec%a0%9c aria-label="벌크 연산 예제">벌크 연산 예제</a></li><li><a href=#%eb%b2%8c%ed%81%ac-%ec%97%b0%ec%82%b0-%ec%a3%bc%ec%9d%98 aria-label="벌크 연산 주의">벌크 연산 주의</a></li></ul></li></ul></div></details></div><div class=post-content><blockquote><p>해당 글은 김영한님의 인프런 강의 <a href=https://www.inflearn.com/course/ORM-JPA-Basic>자바 ORM 표준 JPA 프로그래밍 - 기본편</a>을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.</p></blockquote><h2 id=jpql---경로-표현식>JPQL - 경로 표현식<a hidden class=anchor aria-hidden=true href=#jpql---경로-표현식>#</a></h2><p>경로 표현식은 .(점)을 찍어 객체 그래프를 탐색하는 것이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>username</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=err>상태</span><span class=w> </span><span class=err>필드</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>from</span><span class=w> </span><span class=n>Member</span><span class=w> </span><span class=n>m</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>join</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>team</span><span class=w> </span><span class=n>t</span><span class=w>    </span><span class=o>-&gt;</span><span class=w> </span><span class=err>단일</span><span class=w> </span><span class=err>값</span><span class=w> </span><span class=err>연관</span><span class=w> </span><span class=err>필드</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>join</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>orders</span><span class=w> </span><span class=n>o</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=err>컬렉션</span><span class=w> </span><span class=err>값</span><span class=w> </span><span class=err>연관</span><span class=w> </span><span class=err>필드</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;팀A&#39;</span><span class=w>
</span></span></span></code></pre></div><h3 id=경로-표현식-용어-정리>경로 표현식 용어 정리<a hidden class=anchor aria-hidden=true href=#경로-표현식-용어-정리>#</a></h3><ul><li><strong>상태 필드</strong>(state field): 단순히 값을 저장하기 위한 필드(ex: m.username)</li><li><strong>연관 필드</strong>(association field): 연관관계를 위한 필드<ul><li><strong>단일 값 연관 필드</strong>:
@ManyToOne, @OneToOne, 대상이 엔티티(ex: m.team)</li><li><strong>컬렉션 값 연관 필드</strong>:
@OneToMany, @ManyToMany, 대상이 컬렉션(ex: m.orders)</li></ul></li></ul><h3 id=경로-표현식-특징>경로 표현식 특징<a hidden class=anchor aria-hidden=true href=#경로-표현식-특징>#</a></h3><ul><li><p><strong>상태 필드</strong>(state field): 경로 탐색의 끝, 탐색X</p><ul><li>더이상 m.username.~~로 이어질수 없다.</li></ul></li><li><p><strong>단일 값 연관 경로:</strong> 묵시적 내부 조인(inner join) 발생, 탐색O</p></li><li><p><strong>컬렉션 값 연관 경로</strong>: 묵시적 내부 조인 발생, 탐색X</p><ul><li>FROM 절에서 명시적 조인을 통해 별칭을 얻으면 별칭을 통해 탐색 가능</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;select m From Team t join t.members m&#34;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div></li></ul><p>실무에서는 묵시적 조인보다 명시적 조인을 쓰는게 좋다.명시적 조인을 써야 실제 쿼리 튜닝도 쉬복 JPQL을 튜닝하면 쿼리가 튜닝되기 때문이다.</p><h3 id=상태-필드-경로-탐색>상태 필드 경로 탐색<a hidden class=anchor aria-hidden=true href=#상태-필드-경로-탐색>#</a></h3><ul><li>JPQL: select m.username, m.age from Member m</li><li>SQL: select m.username, m.age from Member m</li></ul><h3 id=단일-값-연관-경로-탐색>단일 값 연관 경로 탐색<a hidden class=anchor aria-hidden=true href=#단일-값-연관-경로-탐색>#</a></h3><ul><li>JPQL: select <strong>o.member</strong> from Order o</li><li>SQL:
select m.*<br>from Orders o<br><strong>inner join Member m on o.member_id = m.id</strong></li></ul><p>묵시적 조인이 발생한다.</p><h3 id=명시적-조인-묵시적-조인>명시적 조인, 묵시적 조인<a hidden class=anchor aria-hidden=true href=#명시적-조인-묵시적-조인>#</a></h3><ul><li>명시적 조인: join 키워드 직접 사용<ul><li>select m from Member m <strong>join m.team t</strong></li></ul></li><li>묵시적 조인: 경로 표현식에 의해 묵시적으로 SQL 조인 발생
(내부 조인만 가능)<ul><li>select <strong>m.team</strong> from Member m</li></ul></li></ul><h3 id=경로-표현식---예제>경로 표현식 - 예제<a hidden class=anchor aria-hidden=true href=#경로-표현식---예제>#</a></h3><ul><li><p>select o.member.team from Order o -> 성공</p><p>묵시적 조인이 2번 발생한다.</p></li><li><p>select t.members from Team -> 성공</p><p>members가 컬렉션이지만 t.member에서 끝났기때문에 성공</p></li><li><p>select t.members.username from Team t -> 실패</p><p>members 컬렉션에서 한번더 값을 조회하는건 불가능</p></li><li><p>select m.username from Team t join t.members m -> 성공</p><p>join t.member로 명시적 조인으로 가져오고 별칭 m을 을 사용해서 m.username으로 했기때문에 성공</p></li></ul><h3 id=경로-탐색을-사용한-묵시적-조인-시-주의사항>경로 탐색을 사용한 묵시적 조인 시 주의사항<a hidden class=anchor aria-hidden=true href=#경로-탐색을-사용한-묵시적-조인-시-주의사항>#</a></h3><ul><li>항상 내부 조인</li><li>컬렉션은 경로 탐색의 끝, 명시적 조인을 통해 별칭을 얻어야함</li><li>경로 탐색은 주로 SELECT, WHERE 절에서 사용하지만 묵시적 조인으로 인해 SQL의 FROM (JOIN) 절에 영향을 줌</li></ul><h3 id=실무-조언>실무 조언<a hidden class=anchor aria-hidden=true href=#실무-조언>#</a></h3><ul><li><strong>가급적 묵시적 조인 대신에 명시적 조인 사용</strong></li><li>조인은 SQL 튜닝에 중요 포인트</li><li>묵시적 조인은 조인이 일어나는 상황을 한눈에 파악하기 어려움</li></ul><h2 id=jpql---페치-조인fetch-join>JPQL - 페치 조인(fetch join)<a hidden class=anchor aria-hidden=true href=#jpql---페치-조인fetch-join>#</a></h2><p><strong>페치 조인은 실무에서 정말 중요하다.</strong></p><h3 id=페치-조인fetch-join>페치 조인(fetch join)<a hidden class=anchor aria-hidden=true href=#페치-조인fetch-join>#</a></h3><ul><li>SQL 조인 종류X</li><li>JPQL에서 <strong>성능 최적화</strong>를 위해 제공하는 기능</li><li>연관된 엔티티나 컬렉션을 <strong>SQL 한 번에 함께 조회</strong>하는 기능</li><li>join fetch 명령어 사용</li><li>페치 조인 ::= [ LEFT [OUTER] | INNER ] JOIN FETCH 조인경로</li></ul><h3 id=엔티티-페치-조인>엔티티 페치 조인<a hidden class=anchor aria-hidden=true href=#엔티티-페치-조인>#</a></h3><ul><li>회원을 조회하면서 연관된 팀도 함께 조회(SQL 한 번에)</li><li>SQL을 보면 회원 뿐만 아니라 <strong>팀(T)</strong>
도 함께 <strong>SELECT</strong></li><li><strong>[JPQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Member</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=k>fetch</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>team</span><span class=w>
</span></span></span></code></pre></div><ul><li><strong>[SQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>M</span><span class=p>.</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>MEMBER</span><span class=w> </span><span class=n>M</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>TEAM</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>M</span><span class=p>.</span><span class=n>TEAM_ID</span><span class=o>=</span><span class=n>T</span><span class=p>.</span><span class=n>ID</span><span class=w>
</span></span></span></code></pre></div><p><img loading=lazy src=images/image.png alt=image.png></p><p><img loading=lazy src=images/image%201.png alt=image.png></p><h3 id=페치-조인-사용-코드>페치 조인 사용 코드<a hidden class=anchor aria-hidden=true href=#페치-조인-사용-코드>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>jpql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;select m from Member m join fetch m.team&#34;</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>members</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=n>jpql</span><span class=p>,</span><span class=w> </span><span class=n>Member</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                               </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Member</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>members</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//페치 조인으로 회원과 팀을 함께 조회해서 지연 로딩X </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;username = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, &#34;</span><span class=w> </span><span class=o>+</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=s>&#34;teamName = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>getTeam</span><span class=p>().</span><span class=na>name</span><span class=p>());</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>username = 회원1, teamname = 팀A<br>username = 회원2, teamname = 팀A<br>username = 회원3, teamname = 팀B</p><h3 id=컬렉션-페치-조인>컬렉션 페치 조인<a hidden class=anchor aria-hidden=true href=#컬렉션-페치-조인>#</a></h3><ul><li>일대다 관계, 컬렉션 페치 조인</li><li><strong>[JPQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>t</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>Team</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=k>fetch</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>members</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>‘팀</span><span class=n>A</span><span class=s1>&#39; 
</span></span></span></code></pre></div><ul><li><strong>[SQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=n>M</span><span class=p>.</span><span class=o>*</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>TEAM</span><span class=w> </span><span class=n>T</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>MEMBER</span><span class=w> </span><span class=n>M</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>ID</span><span class=o>=</span><span class=n>M</span><span class=p>.</span><span class=n>TEAM_ID</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;팀A&#39;</span><span class=w> 
</span></span></span></code></pre></div><p><img loading=lazy src=images/image%202.png alt=image.png></p><p><img loading=lazy src=images/image%203.png alt=image.png></p><p><img loading=lazy src=images/image%204.png alt=image.png></p><h3 id=컬렉션-페치-조인-사용-코드>컬렉션 페치 조인 사용 코드<a hidden class=anchor aria-hidden=true href=#컬렉션-페치-조인-사용-코드>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>jpql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;select t from Team t join fetch t.members where t.name = &#39;팀A&#39;&#34;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>Team</span><span class=o>&gt;</span><span class=w> </span><span class=n>teams</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=n>jpql</span><span class=p>,</span><span class=w> </span><span class=n>Team</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>getResultList</span><span class=p>();</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>for</span><span class=p>(</span><span class=n>Team</span><span class=w> </span><span class=n>team</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>teams</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;teamname = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>team</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, team = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>team</span><span class=p>);</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Member</span><span class=w> </span><span class=n>member</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>team</span><span class=p>.</span><span class=na>getMembers</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>//페치 조인으로 팀과 회원을 함께 조회해서 지연 로딩 발생 안함 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;-&gt; username = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()</span><span class=o>+</span><span class=w> </span><span class=s>&#34;, member = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>member</span><span class=p>);</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>teamname = 팀A, team = Team@0x100<br>-> username = 회원1, member = Member@0x200<br>-> username = 회원2, member = Member@0x300<br>teamname = 팀A, team = Team@0x100<br>-> username = 회원1, member = Member@0x200<br>-> username = 회원2, member = Member@0x300</p><h3 id=페치-조인과-distinct>페치 조인과 DISTINCT<a hidden class=anchor aria-hidden=true href=#페치-조인과-distinct>#</a></h3><ul><li>SQL의 DISTINCT는 중복된 결과를 제거하는 명령</li><li>JPQL의 DISTINCT 2가지 기능 제공<ul><li><ol><li>SQL에 DISTINCT를 추가</li></ol></li><li><ol start=2><li>애플리케이션에서 엔티티 중복 제거</li></ol></li></ul></li></ul><h3 id=페치-조인과-distinct-1>페치 조인과 DISTINCT<a hidden class=anchor aria-hidden=true href=#페치-조인과-distinct-1>#</a></h3><ul><li>select <strong>distinct</strong> t<br>from Team t join fetch t.members<br>where t.name = ‘팀A’</li><li>SQL에 DISTINCT를 추가하지만 데이터가 다르므로 SQL 결과에서 중복제거 실패</li></ul><p><img loading=lazy src=images/image%205.png alt=image.png></p><ul><li>DISTINCT가 추가로 애플리케이션에서 중복 제거시도</li><li>같은 식별자를 가진 Team 엔티티 제거</li></ul><p><img loading=lazy src=images/image%206.png alt=image.png></p><p>[DISTINCT 추가시 결과]<br>teamname = 팀A, team = Team@0x100<br>-> username = 회원1, member = Member@0x200<br>-> username = 회원2, member = Member@0x300</p><h3 id=하이버네이트6-변경-사항>하이버네이트6 변경 사항<a hidden class=anchor aria-hidden=true href=#하이버네이트6-변경-사항>#</a></h3><ul><li>DISTINCT가 추가로 애플리케이션에서 중복 제거시도</li><li><strong>-> 하이버네이트6 부터는 DISTINCT 명령어를 사용하지 않아도 애플리케이션에서 중복 제거가 자동으로 적용됩니다.</strong></li></ul><h3 id=페치-조인과-일반-조인의-차이>페치 조인과 일반 조인의 차이<a hidden class=anchor aria-hidden=true href=#페치-조인과-일반-조인의-차이>#</a></h3><ul><li>일반 조인 실행시 연관된 엔티티를 함께 조회하지 않음</li><li><strong>[JPQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>t</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>Team</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>members</span><span class=w> </span><span class=n>m</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>‘팀</span><span class=n>A</span><span class=s1>&#39; 
</span></span></span></code></pre></div><ul><li><strong>[SQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=o>*</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>TEAM</span><span class=w> </span><span class=n>T</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>MEMBER</span><span class=w> </span><span class=n>M</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>ID</span><span class=o>=</span><span class=n>M</span><span class=p>.</span><span class=n>TEAM_ID</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;팀A&#39;</span><span class=w>
</span></span></span></code></pre></div><h3 id=페치-조인과-일반-조인의-차이-1>페치 조인과 일반 조인의 차이<a hidden class=anchor aria-hidden=true href=#페치-조인과-일반-조인의-차이-1>#</a></h3><ul><li>JPQL은 결과를 반환할 때 연관관계 고려X</li><li>단지 SELECT 절에 지정한 엔티티만 조회할 뿐</li><li>여기서는 팀 엔티티만 조회하고, 회원 엔티티는 조회X</li><li>페치 조인을 사용할 때만 연관된 엔티티도 함께 <strong>조회(즉시 로딩)</strong></li><li><strong>페치 조인은 객체 그래프를 SQL 한번에 조회하는 개념</strong></li></ul><h3 id=페치-조인-실행-예시>페치 조인 실행 예시<a hidden class=anchor aria-hidden=true href=#페치-조인-실행-예시>#</a></h3><ul><li>페치 조인은 연관된 엔티티를 함께 조회함</li><li><strong>[JPQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>t</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>Team</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=k>fetch</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>members</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>‘팀</span><span class=n>A</span><span class=s1>&#39;
</span></span></span></code></pre></div><ul><li>[SQL]</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=n>M</span><span class=p>.</span><span class=o>*</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>TEAM</span><span class=w> </span><span class=n>T</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>MEMBER</span><span class=w> </span><span class=n>M</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>ID</span><span class=o>=</span><span class=n>M</span><span class=p>.</span><span class=n>TEAM_ID</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>T</span><span class=p>.</span><span class=n>NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;팀A
</span></span></span></code></pre></div><h3 id=페치-조인의-특징과-한계>페치 조인의 특징과 한계<a hidden class=anchor aria-hidden=true href=#페치-조인의-특징과-한계>#</a></h3><ul><li><p><strong>페치 조인 대상에는 별칭을 줄 수 없다.</strong></p><ul><li>하이버네이트는 가능, 가급적 사용X</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>query</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;select t From Team t join fetch t.member m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// join fetch t.members m 불가능</span><span class=w>
</span></span></span></code></pre></div><p>패치 조인은 기본적으로 연관된 것들을 다 가져오는 거다. 하지만 별칭을 사용해서 성능상 중간에 몇개를 걸러서 가지고 오고싶어서 where절에 별칭을 통한 조건을 넣고 조회하면 잘못 조작하면 나중에 이상하게 동작할수 있다.</p></li><li><p><strong>둘 이상의 컬렉션은 페치 조인 할 수 없다.</strong></p><ul><li>일대다대다 이기때문에 데이터가 예상치 못하게 늘어날수 있다.</li></ul></li><li><p><strong>컬렉션을 페치 조인하면 페이징 API(setFirstResult,
setMaxResults)를 사용할 수 없다.</strong></p><ul><li>일대일, 다대일 같은 단일 값 연관 필드들은 페치 조인해도 페이징 가능</li><li>하이버네이트는 경고 로그를 남기고 메모리에서 페이징(매우 위험)</li></ul></li></ul><h3 id=페치-조인의-특징과-한계-1>페치 조인의 특징과 한계<a hidden class=anchor aria-hidden=true href=#페치-조인의-특징과-한계-1>#</a></h3><ul><li>연관된 엔티티들을 SQL 한 번으로 조회 - 성능 최적화</li><li>엔티티에 직접 적용하는 글로벌 로딩 전략보다 우선함<ul><li>@OneToMany(fetch = FetchType.LAZY) //글로벌 로딩 전략</li></ul></li><li>실무에서 글로벌 로딩 전략은 모두 지연 로딩</li><li>최적화가 필요한 곳은 페치 조인 적용</li></ul><h3 id=페치-조인---정리>페치 조인 - 정리<a hidden class=anchor aria-hidden=true href=#페치-조인---정리>#</a></h3><ul><li>모든 것을 페치 조인으로 해결할 수 는 없음</li><li>페치 조인은 객체 그래프를 유지할 때 사용하면 효과적</li><li>여러 테이블을 조인해서 엔티티가 가진 모양이 아닌 전혀 다른결과를 내야 하면, 페치 조인 보다는 일반 조인을 사용하고 필요한 데이터들만 조회해서 DTO로 반환하는 것이 효과적</li><li>페치 조인 3가지 방법<ul><li>엔티티를 패치 조인을 사용해서 조회</li><li>패치 조인을 하고 애플리케이션에서 DTO로 바꿔서 화면에 반환</li><li>JPA 작성할때부터 DTO로 스위칭</li></ul></li></ul><h2 id=jpql---다형성-쿼리>JPQL - 다형성 쿼리<a hidden class=anchor aria-hidden=true href=#jpql---다형성-쿼리>#</a></h2><p><img loading=lazy src=images/image%207.png alt=image.png></p><h3 id=type>TYPE<a hidden class=anchor aria-hidden=true href=#type>#</a></h3><ul><li>조회 대상을 특정 자식으로 한정</li><li>예) Item 중에 Book, Movie를 조회해라</li><li><strong>[JPQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Item</span><span class=w> </span><span class=n>i</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=k>type</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=n>Book</span><span class=p>,</span><span class=w> </span><span class=n>Movie</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><ul><li><strong>[SQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>i</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>DTYPE</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=p>(</span><span class=err>‘</span><span class=n>B</span><span class=err>’</span><span class=p>,</span><span class=w> </span><span class=err>‘</span><span class=n>M</span><span class=err>’</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=treatjpa-21>TREAT(JPA 2.1)<a hidden class=anchor aria-hidden=true href=#treatjpa-21>#</a></h3><ul><li>자바의 타입 캐스팅과 유사</li><li>상속 구조에서 부모 타입을 특정 자식 타입으로 다룰 때 사용</li><li>FROM, WHERE, SELECT(하이버네이트 지원) 사용</li><li>예) 부모인 Item과 자식 Book이 있다.</li><li><strong>[JPQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Item</span><span class=w> </span><span class=n>i</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=k>treat</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>Book</span><span class=p>).</span><span class=n>author</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>‘</span><span class=n>kim</span><span class=err>’</span><span class=w>
</span></span></span></code></pre></div><ul><li><strong>[SQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Item</span><span class=w> </span><span class=n>i</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>DTYPE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>‘</span><span class=n>B</span><span class=err>’</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>author</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>‘</span><span class=n>kim</span><span class=err>’</span><span class=w>
</span></span></span></code></pre></div><h3 id=jpql---엔티티-직접-사용>JPQL - 엔티티 직접 사용<a hidden class=anchor aria-hidden=true href=#jpql---엔티티-직접-사용>#</a></h3><h2 id=엔티티-직접-사용---기본-키-값>엔티티 직접 사용 - 기본 키 값<a hidden class=anchor aria-hidden=true href=#엔티티-직접-사용---기본-키-값>#</a></h2><ul><li>JPQL에서 엔티티를 직접 사용하면 SQL에서 해당 엔티티의 기본 키 값을 사용</li><li><strong>[JPQL]</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Member</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>//</span><span class=err>엔티티의</span><span class=w> </span><span class=err>아이디를</span><span class=w> </span><span class=err>사용</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Member</span><span class=w> </span><span class=n>m</span><span class=w>    </span><span class=o>//</span><span class=err>엔티티를</span><span class=w> </span><span class=err>직접</span><span class=w> </span><span class=err>사용</span><span class=w>
</span></span></span></code></pre></div><ul><li><strong>[SQL]</strong>(JPQL 둘다 같은 다음 SQL 실행)</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=k>count</span><span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>cnt</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Member</span><span class=w> </span><span class=n>m</span><span class=w>
</span></span></span></code></pre></div><p>엔티티를 파라미터로 전달</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>jpql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;select m from Member m where m = :member&#34;</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=w> </span><span class=n>resultList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=n>jpql</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>setParameter</span><span class=p>(</span><span class=s>&#34;member&#34;</span><span class=p>,</span><span class=w> </span><span class=n>member</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>식별자를 직접 전달</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>jpql</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;select m from Member m where m.id = :memberId&#34;</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=w> </span><span class=n>resultList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=n>jpql</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>setParameter</span><span class=p>(</span><span class=s>&#34;memberId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>memberId</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>실행된 SQL</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Member</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>id</span><span class=o>=?</span><span class=w>
</span></span></span></code></pre></div><p>엔티티를 파라미터로 전달한것과 식별자를 직접 전달한것의 실행된 SQL은 동일하다. 엔티티가 DB에 넘어가면 DB의 PK값이기 때문이다.</p><h3 id=엔티티-직접-사용--외래-키-값>엔티티 직접 사용- 외래 키 값<a hidden class=anchor aria-hidden=true href=#엔티티-직접-사용--외래-키-값>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Team</span><span class=w> </span><span class=n>team</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>find</span><span class=p>(</span><span class=n>Team</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>1L</span><span class=p>);</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>qlString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;select m from Member m where m.team = :team&#34;</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=w> </span><span class=n>resultList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=n>qlString</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>setParameter</span><span class=p>(</span><span class=s>&#34;team&#34;</span><span class=p>,</span><span class=w> </span><span class=n>team</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>String</span><span class=w> </span><span class=n>qlString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;select m from Member m where m.team.id = :teamId&#34;</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=w> </span><span class=n>resultList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=n>qlString</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>setParameter</span><span class=p>(</span><span class=s>&#34;teamId&#34;</span><span class=p>,</span><span class=w> </span><span class=n>teamId</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w> 
</span></span></span></code></pre></div><p>파라미터로 넘긴 Team은 PK이고, m.team은 DB 입장에서는 FK와 맵핑 된다.</p><p>실행된 SQL</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>select</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>Member</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>team_id</span><span class=o>=?</span><span class=w>
</span></span></span></code></pre></div><h2 id=jpql---named-쿼리>JPQL - Named 쿼리<a hidden class=anchor aria-hidden=true href=#jpql---named-쿼리>#</a></h2><h3 id=named-쿼리---정적-쿼리>Named 쿼리 - 정적 쿼리<a hidden class=anchor aria-hidden=true href=#named-쿼리---정적-쿼리>#</a></h3><ul><li><p>미리 정의해서 이름을 부여해두고 사용하는 JPQL</p></li><li><p>정적 쿼리</p></li><li><p>어노테이션, XML에 정의</p></li><li><p>애플리케이션 로딩 시점에 초기화 후 재사용</p></li><li><p><strong>애플리케이션 로딩 시점에 쿼리를 검증</strong></p><p>만약 “select m from MemberQQQ … ”처럼 문법 오류가나면 로딩 시점에 오류가 발생한다.</p></li></ul><h3 id=named-쿼리---어노테이션>Named 쿼리 - 어노테이션<a hidden class=anchor aria-hidden=true href=#named-쿼리---어노테이션>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Entity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NamedQuery</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Member.findByUsername&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>query</span><span class=o>=</span><span class=s>&#34;select m from Member m where m.username = :username&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Member</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>resultList</span><span class=w> </span><span class=o>=</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>em</span><span class=p>.</span><span class=na>createNamedQuery</span><span class=p>(</span><span class=s>&#34;Member.findByUsername&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Member</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>setParameter</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;회원1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>.</span><span class=na>getResultList</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>Named 쿼리 어노테이션을 사용하면 멤버 엔티티가 너무 지저분해지고 실무에서는 아래 코드처럼 Spring Data JPA를 섞어쓰기때문에 비추천한다. 아래도 어플리케이션 로딩 시점에 검증이 된다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//Spring Dat JPA 공식 문서에 있는 예시 중 하나이다.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>UserReposior</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>JpaRepository</span><span class=o>&lt;</span><span class=n>User</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Query</span><span class=p>(</span><span class=s>&#34;select u from User u where u.emailAddress = ?1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>User</span><span class=w> </span><span class=nf>findByEmailAddress</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>emailAddress</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=jpql---벌크-연산>JPQL - 벌크 연산<a hidden class=anchor aria-hidden=true href=#jpql---벌크-연산>#</a></h2><h3 id=벌크-연산>벌크 연산<a hidden class=anchor aria-hidden=true href=#벌크-연산>#</a></h3><ul><li>재고가 10개 미만인 모든 상품의 가격을 10% 상승하려면?</li><li>JPA 변경 감지 기능으로 실행하려면 너무 많은 SQL 실행<ul><li><ol><li>재고가 10개 미만인 상품을 리스트로 조회한다.</li></ol></li><li><ol start=2><li>상품 엔티티의 가격을 10% 증가한다.</li></ol></li><li><ol start=3><li>트랜잭션 커밋 시점에 변경감지가 동작한다.</li></ol></li></ul></li><li>변경된 데이터가 100건이라면 100번의 UPDATE SQL 실행</li></ul><h3 id=벌크-연산-예제>벌크 연산 예제<a hidden class=anchor aria-hidden=true href=#벌크-연산-예제>#</a></h3><ul><li>쿼리 한 번으로 여러 테이블 로우 변경(엔티티)</li><li><strong>executeUpdate()의 결과는 영향받은 엔티티 수 반환</strong></li><li><strong>UPDATE, DELETE 지원</strong></li><li><strong>INSERT(insert into .. select, 하이버네이트 지원)</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>qlString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;update Product p &#34;</span><span class=w> </span><span class=o>+</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=s>&#34;set p.price = p.price * 1.1 &#34;</span><span class=w> </span><span class=o>+</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=s>&#34;where p.stockAmount &lt; :stockAmount&#34;</span><span class=p>;</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>int</span><span class=w> </span><span class=n>resultCount</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=n>qlString</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>setParameter</span><span class=p>(</span><span class=s>&#34;stockAmount&#34;</span><span class=p>,</span><span class=w> </span><span class=n>10</span><span class=p>)</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>executeUpdate</span><span class=p>();</span><span class=w> 
</span></span></span></code></pre></div><h3 id=벌크-연산-주의>벌크 연산 주의<a hidden class=anchor aria-hidden=true href=#벌크-연산-주의>#</a></h3><ul><li><p>벌크 연산은 영속성 컨텍스트를 무시하고 데이터베이스에 직접 쿼리</p><p>벌크 연산을 먼저 실행하고 <strong>벌크 연산 수행후 영속성 컨텍스트 초기화를 하면된다.</strong></p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://yosong6729.github.io/tags/jpa/>JPA</a></li></ul><nav class=paginav><a class=prev href=https://yosong6729.github.io/post/%EB%8F%84%EB%A9%94%EC%9D%B8-%EB%B6%84%EC%84%9D-%EC%84%A4%EA%B3%84/><span class=title>« Prev</span><br><span>도메인 분석 설계</span>
</a><a class=next href=https://yosong6729.github.io/post/%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5-%EC%BF%BC%EB%A6%AC-%EC%96%B8%EC%96%B41---%EA%B8%B0%EB%B3%B8%EB%AC%B8%EB%B2%95/><span class=title>Next »</span><br><span>[자바 ORM 표준 JPA 프로그래밍 - 기본편] 객체지향 쿼리 언어1 - 기본문법</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://yosong6729.github.io/>Yosong6729 Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>