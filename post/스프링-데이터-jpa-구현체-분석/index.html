<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>스프링 데이터 JPA 구현체 분석 | Yosong6729 Blog</title>
<meta name=keywords content="spring data JPA"><meta name=description content='해당 글은 김영한님의 인프런 강의 스프링 데이터 JPA을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
스프링 데이터 JPA 구현체 분석 스프링 데이터 JPA가 제공하는 공통 인터페이스 구현체
org.springframework.data.jpa.repository.support.SimpleJpaRepository
SimpleJpaRepository
@Repository @Transactional(readOnly = true) public class SimpleJpaRepository<T, ID> ... { @Override @Transactional public <S extends T> S save(S entity) { Assert.notNull(entity, "Entity must not be null"); if (entityInformation.isNew(entity)) { entityManager.persist(entity); return entity; } else { return entityManager.'><meta name=author content="yosong6729"><link rel=canonical href=https://yosong6729.github.io/post/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%8D%B0%EC%9D%B4%ED%84%B0-jpa-%EA%B5%AC%ED%98%84%EC%B2%B4-%EB%B6%84%EC%84%9D/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://yosong6729.github.io/post/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%8D%B0%EC%9D%B4%ED%84%B0-jpa-%EA%B5%AC%ED%98%84%EC%B2%B4-%EB%B6%84%EC%84%9D/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="스프링 데이터 JPA 구현체 분석"><meta property="og:description" content='해당 글은 김영한님의 인프런 강의 스프링 데이터 JPA을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
스프링 데이터 JPA 구현체 분석 스프링 데이터 JPA가 제공하는 공통 인터페이스 구현체
org.springframework.data.jpa.repository.support.SimpleJpaRepository
SimpleJpaRepository
@Repository @Transactional(readOnly = true) public class SimpleJpaRepository<T, ID> ... { @Override @Transactional public <S extends T> S save(S entity) { Assert.notNull(entity, "Entity must not be null"); if (entityInformation.isNew(entity)) { entityManager.persist(entity); return entity; } else { return entityManager.'><meta property="og:type" content="article"><meta property="og:url" content="https://yosong6729.github.io/post/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%8D%B0%EC%9D%B4%ED%84%B0-jpa-%EA%B5%AC%ED%98%84%EC%B2%B4-%EB%B6%84%EC%84%9D/"><meta property="og:image" content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-10-03T16:16:50+09:00"><meta property="article:modified_time" content="2024-10-03T16:16:50+09:00"><meta property="og:site_name" content="Yosong6729 Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="스프링 데이터 JPA 구현체 분석"><meta name=twitter:description content='해당 글은 김영한님의 인프런 강의 스프링 데이터 JPA을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
스프링 데이터 JPA 구현체 분석 스프링 데이터 JPA가 제공하는 공통 인터페이스 구현체
org.springframework.data.jpa.repository.support.SimpleJpaRepository
SimpleJpaRepository
@Repository @Transactional(readOnly = true) public class SimpleJpaRepository<T, ID> ... { @Override @Transactional public <S extends T> S save(S entity) { Assert.notNull(entity, "Entity must not be null"); if (entityInformation.isNew(entity)) { entityManager.persist(entity); return entity; } else { return entityManager.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yosong6729.github.io/post/"},{"@type":"ListItem","position":2,"name":"스프링 데이터 JPA 구현체 분석","item":"https://yosong6729.github.io/post/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%8D%B0%EC%9D%B4%ED%84%B0-jpa-%EA%B5%AC%ED%98%84%EC%B2%B4-%EB%B6%84%EC%84%9D/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"스프링 데이터 JPA 구현체 분석","name":"스프링 데이터 JPA 구현체 분석","description":"해당 글은 김영한님의 인프런 강의 스프링 데이터 JPA을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\n스프링 데이터 JPA 구현체 분석 스프링 데이터 JPA가 제공하는 공통 인터페이스 구현체\norg.springframework.data.jpa.repository.support.SimpleJpaRepository\nSimpleJpaRepository\n@Repository @Transactional(readOnly = true) public class SimpleJpaRepository\u0026lt;T, ID\u0026gt; ... { @Override @Transactional public \u0026lt;S extends T\u0026gt; S save(S entity) { Assert.notNull(entity, \u0026#34;Entity must not be null\u0026#34;); if (entityInformation.isNew(entity)) { entityManager.persist(entity); return entity; } else { return entityManager.","keywords":["spring data JPA"],"articleBody":" 해당 글은 김영한님의 인프런 강의 스프링 데이터 JPA을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\n스프링 데이터 JPA 구현체 분석 스프링 데이터 JPA가 제공하는 공통 인터페이스 구현체\norg.springframework.data.jpa.repository.support.SimpleJpaRepository\nSimpleJpaRepository\n@Repository @Transactional(readOnly = true) public class SimpleJpaRepository\u003cT, ID\u003e ... { @Override @Transactional public \u003cS extends T\u003e S save(S entity) { Assert.notNull(entity, \"Entity must not be null\"); if (entityInformation.isNew(entity)) { entityManager.persist(entity); return entity; } else { return entityManager.merge(entity); } //... } @Repository 적용: JPA예외를 스프링이 추상화한 예외로 변환 @Transactional 트랜잭션 적용 JPA의 모든 변경은 트랝개션 안에서 동작한다. 스프링 데이터 JPA는 변경(등록, 수정, 삭제) 메서드를 위 코드에서 보는것과 같이 트랜잭션 처리한다. 서비스 계층에서 트랜잭션을 시작하지 않으면 리포지토리에서 트랜잭션 시작한다 서비스 계층에서 트랜잭션을 시작하면 리파지토리는 해당 트랜잭션을 전파 받아서 사용한다. 그래서 스프링 데이터 JPA를 사용할때 트랜잭션이 없어도 데이터 변경이 가능했다.(트랜잭션이 리포지토리 계층에 걸려있었기 때문) @Transactional(readOnly = true) SimpleJpaRepository는 @Transactional(readOnly = true)가 있어서 데이터를 단순히 조회만 하고 변경하지 않는 경우 위 어노테이션으로 인해 플러시를 생략해서 약간의 성능 향상을 얻는다. 자세한 내용은 JPA 책 15.4.2 읽기 전용 쿼리의 성능 최적화 참고 중요\nsave() 메서드 새로운 엔티티 저장(persist) 새로운 엔티티 아니면 병합(merge) 병합(merge)는 DB에 있던 엔티티를 가져오고 save()에 파라미터로 넘어온 엔티티로 모든 값을 교체하는데 단점은 DB에 쿼리를 한번 한다는 점이다. 되도록 merge를 쓰지말고 데이터 변경은 변경 감지로 해야한다.\n새로운 엔티티를 구별하는 방법 save() 메서드는 새로운 엔티티면 저장(persist) 아니면 병합(merge)를 한다.\n새로운 엔티티를 판단하는 기본 전략 식별자가 객체일때 null로 판단 식별자가 자바 기본타입일 때 0으로 판단 Persistable 인터페이스를 구현해서 판단 로직 변경 가능 JPA식별자 생성 전략이 @GenerateValue면 save() 호출 시점에 식별자가 없으므로 새로운 엔티티로 인식해서 정상 동작한다.\n아래는 Item 엔티티의 @GenerateValue 전략을 사용해서 save() 메서드 내부에서 id값이 변하는 과정이다.\n정상적으로 새로운 엔티티로 인식해서 return entity; 시점에 id값이 할당된다.\nJPA식별자 생성 전략이 @Id만 사용해서 직접 할당하면 이미 식별자 값이 있는 상태로 save()를 호출한다.\n다음은 String 타입으로 @Id만 사용한 결과이다.\n“A”식별자가 있어서 위 경우에는 merge()가 호출된다. merge()는 우선 DB를 호출해서 값을 확인하고, DB에 값이 없으면 새로운 엔티티를 인지하므로 매우 비 효율적이다. 다음과 같이 쿼리가 나간다.\n따라서 Persistable를 사용해서 새로운 엔티티 확인 여부를 직접 구현하는게 효과적이다.\n등록시간(@CreatedDate)를 조합해서 사용하면 이 필드로 새로운 엔티티 여부를 편리하게 확인할 수 있다.(@CreatedDate에 값이 없으면 새로운 엔티티로 판단한다.)\nPersistable\npackage org.springframework.data.domain; public interface Persistable\u003cID\u003e { ID getId(); boolean isNew(); } Persistable 구현\n@Entity @EntityListeners(AuditingEntityListener.class) @NoArgsConstructor(access = AccessLevel.PROTECTED) public class Item implements Persistable\u003cString\u003e { @Id private String id; @CreatedDate private LocalDateTime createdDate; public Item(String id) { this.id = id; } @Override public String getId() { return id; } @Override public boolean isNew() { return createdDate == null; } } ","wordCount":"408","inLanguage":"en","image":"https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-10-03T16:16:50+09:00","dateModified":"2024-10-03T16:16:50+09:00","author":{"@type":"Person","name":"yosong6729"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yosong6729.github.io/post/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%8D%B0%EC%9D%B4%ED%84%B0-jpa-%EA%B5%AC%ED%98%84%EC%B2%B4-%EB%B6%84%EC%84%9D/"},"publisher":{"@type":"Organization","name":"Yosong6729 Blog","logo":{"@type":"ImageObject","url":"https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yosong6729.github.io/ accesskey=h title="Yosong6729 블로그 (Alt + H)"><img src=https://yosong6729.github.io/apple-touch-icon.png alt aria-label=logo height=35>Yosong6729 블로그</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yosong6729.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://yosong6729.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yosong6729.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yosong6729.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">스프링 데이터 JPA 구현체 분석</h1><div class=post-meta><span title='2024-10-03 16:16:50 +0900 KST'>October 3, 2024</span>&nbsp;·&nbsp;yosong6729&nbsp;|&nbsp;<a href=https://github.com/yosong6729/blog/tree/main/content/post/%ec%8a%a4%ed%94%84%eb%a7%81%20%eb%8d%b0%ec%9d%b4%ed%84%b0%20JPA%20%ea%b5%ac%ed%98%84%ec%b2%b4%20%eb%b6%84%ec%84%9d/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%ec%8a%a4%ed%94%84%eb%a7%81-%eb%8d%b0%ec%9d%b4%ed%84%b0-jpa-%ea%b5%ac%ed%98%84%ec%b2%b4-%eb%b6%84%ec%84%9d aria-label="스프링 데이터 JPA 구현체 분석">스프링 데이터 JPA 구현체 분석</a></li><li><a href=#%ec%83%88%eb%a1%9c%ec%9a%b4-%ec%97%94%ed%8b%b0%ed%8b%b0%eb%a5%bc-%ea%b5%ac%eb%b3%84%ed%95%98%eb%8a%94-%eb%b0%a9%eb%b2%95 aria-label="새로운 엔티티를 구별하는 방법">새로운 엔티티를 구별하는 방법</a></li></ul></div></details></div><div class=post-content><blockquote><p>해당 글은 김영한님의 인프런 강의 <a href=https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-%EB%8D%B0%EC%9D%B4%ED%84%B0-JPA-%EC%8B%A4%EC%A0%84>스프링 데이터 JPA</a>을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.</p></blockquote><hr><h2 id=스프링-데이터-jpa-구현체-분석>스프링 데이터 JPA 구현체 분석<a hidden class=anchor aria-hidden=true href=#스프링-데이터-jpa-구현체-분석>#</a></h2><p>스프링 데이터 JPA가 제공하는 공통 인터페이스 구현체</p><p>org.springframework.data.jpa.repository.support.SimpleJpaRepository</p><p><img loading=lazy src=images/image.png alt=image.png></p><p>SimpleJpaRepository</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Repository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Transactional</span><span class=p>(</span><span class=n>readOnly</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SimpleJpaRepository</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>ID</span><span class=o>&gt;</span><span class=w> </span><span class=p>...</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>S</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>S</span><span class=w> </span><span class=nf>save</span><span class=p>(</span><span class=n>S</span><span class=w> </span><span class=n>entity</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Assert</span><span class=p>.</span><span class=na>notNull</span><span class=p>(</span><span class=n>entity</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Entity must not be null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entityInformation</span><span class=p>.</span><span class=na>isNew</span><span class=p>(</span><span class=n>entity</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>entityManager</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>entity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=n>entity</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=w> </span><span class=n>entityManager</span><span class=p>.</span><span class=na>merge</span><span class=p>(</span><span class=n>entity</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>@Repository 적용: JPA예외를 스프링이 추상화한 예외로 변환</li><li>@Transactional 트랜잭션 적용<ul><li>JPA의 모든 변경은 트랝개션 안에서 동작한다.</li><li>스프링 데이터 JPA는 변경(등록, 수정, 삭제) 메서드를 위 코드에서 보는것과 같이 트랜잭션 처리한다.</li><li>서비스 계층에서 트랜잭션을 시작하지 않으면 리포지토리에서 트랜잭션 시작한다</li><li>서비스 계층에서 트랜잭션을 시작하면 리파지토리는 해당 트랜잭션을 전파 받아서 사용한다.</li><li>그래서 스프링 데이터 JPA를 사용할때 트랜잭션이 없어도 데이터 변경이 가능했다.(트랜잭션이 리포지토리 계층에 걸려있었기 때문)</li></ul></li><li>@Transactional(readOnly = true)<ul><li>SimpleJpaRepository는 @Transactional(readOnly = true)가 있어서 데이터를 단순히 조회만 하고 변경하지 않는 경우 위 어노테이션으로 인해 <strong>플러시를 생략해서 약간의 성능 향상</strong>을 얻는다.</li><li>자세한 내용은 JPA 책 15.4.2 읽기 전용 쿼리의 성능 최적화 참고</li></ul></li></ul><p>중요</p><ul><li>save() 메서드<ul><li>새로운 엔티티 저장(persist)</li><li>새로운 엔티티 아니면 병합(merge)</li></ul></li></ul><p>병합(merge)는 DB에 있던 엔티티를 가져오고 save()에 파라미터로 넘어온 엔티티로 모든 값을 교체하는데 단점은 DB에 쿼리를 한번 한다는 점이다. 되도록 merge를 쓰지말고 데이터 변경은 변경 감지로 해야한다.</p><hr><h2 id=새로운-엔티티를-구별하는-방법>새로운 엔티티를 구별하는 방법<a hidden class=anchor aria-hidden=true href=#새로운-엔티티를-구별하는-방법>#</a></h2><p>save() 메서드는 새로운 엔티티면 저장(persist) 아니면 병합(merge)를 한다.</p><ul><li>새로운 엔티티를 판단하는 기본 전략<ul><li>식별자가 객체일때 null로 판단</li><li>식별자가 자바 기본타입일 때 0으로 판단</li><li><strong>Persistable</strong> 인터페이스를 구현해서 판단 로직 변경 가능</li></ul></li></ul><p>JPA식별자 생성 전략이 @GenerateValue면 save() 호출 시점에 식별자가 없으므로 새로운 엔티티로 인식해서 정상 동작한다.</p><p>아래는 Item 엔티티의 @GenerateValue 전략을 사용해서 save() 메서드 내부에서 id값이 변하는 과정이다.</p><p><img loading=lazy src=images/image%201.png alt=image.png></p><p><img loading=lazy src=images/image%202.png alt=image.png></p><p>정상적으로 새로운 엔티티로 인식해서 return entity; 시점에 id값이 할당된다.</p><p>JPA식별자 생성 전략이 @Id만 사용해서 직접 할당하면 이미 식별자 값이 있는 상태로 save()를 호출한다.</p><p>다음은 String 타입으로 @Id만 사용한 결과이다.</p><p><img loading=lazy src=images/image%203.png alt=image.png></p><p>“A”식별자가 있어서 위 경우에는 merge()가 호출된다. merge()는 우선 DB를 호출해서 값을 확인하고, DB에 값이 없으면 새로운 엔티티를 인지하므로 매우 비 효율적이다. 다음과 같이 쿼리가 나간다.</p><p><img loading=lazy src=images/image%204.png alt=image.png></p><p>따라서 <strong>Persistable</strong>를 사용해서 새로운 엔티티 확인 여부를 직접 구현하는게 효과적이다.</p><p>등록시간(@CreatedDate)를 조합해서 사용하면 이 필드로 새로운 엔티티 여부를 편리하게 확인할 수 있다.(@CreatedDate에 값이 없으면 새로운 엔티티로 판단한다.)</p><p><strong>Persistable</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>org.springframework.data.domain</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Persistable</span><span class=o>&lt;</span><span class=n>ID</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ID</span><span class=w> </span><span class=nf>getId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isNew</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><strong>Persistable 구현</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Entity</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@EntityListeners</span><span class=p>(</span><span class=n>AuditingEntityListener</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@NoArgsConstructor</span><span class=p>(</span><span class=n>access</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AccessLevel</span><span class=p>.</span><span class=na>PROTECTED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Item</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Persistable</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@CreatedDate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>createdDate</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Item</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getId</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isNew</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>createdDate</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://yosong6729.github.io/tags/spring-data-jpa/>Spring Data JPA</a></li></ul><nav class=paginav><a class=next href=https://yosong6729.github.io/post/%ED%99%95%EC%9E%A5-%EA%B8%B0%EB%8A%A5/><span class=title>Next »</span><br><span>확장 기능</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://yosong6729.github.io/>Yosong6729 Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>