<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Querydsl]기본 문법 | Yosong6729 Blog</title>
<meta name=keywords content="Querydsl"><meta name=description content='해당 글은 김영한님의 인프런 강의 실전! Querydsl을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
예제 도메인 모델을 엔티티 클래스와 ERD만 확인하고 넘어가겠다.
JPQL vs Querydsl 테스트 기본 코드
@SpringBootTest @Transactional public class QuerydslBasicTest { @PersistenceContext EntityManager em; @BeforeEach public void before() { queryFactory = new JPAQueryFactory(em); Team teamA = new Team("teamA"); Team teamB = new Team("teamB"); em.persist(teamA); em.persist(teamB); Member member1 = new Member("member1", 10, teamA); Member member2 = new Member("member2", 20, teamA); Member member3 = new Member("member3", 30, teamB); Member member4 = new Member("member4", 40, teamB); em.'><meta name=author content="yosong6729"><link rel=canonical href=https://yosong6729.github.io/post/querydsl---%EA%B8%B0%EB%B3%B8-%EB%AC%B8%EB%B2%95/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://yosong6729.github.io/post/querydsl---%EA%B8%B0%EB%B3%B8-%EB%AC%B8%EB%B2%95/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="[Querydsl]기본 문법"><meta property="og:description" content='해당 글은 김영한님의 인프런 강의 실전! Querydsl을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
예제 도메인 모델을 엔티티 클래스와 ERD만 확인하고 넘어가겠다.
JPQL vs Querydsl 테스트 기본 코드
@SpringBootTest @Transactional public class QuerydslBasicTest { @PersistenceContext EntityManager em; @BeforeEach public void before() { queryFactory = new JPAQueryFactory(em); Team teamA = new Team("teamA"); Team teamB = new Team("teamB"); em.persist(teamA); em.persist(teamB); Member member1 = new Member("member1", 10, teamA); Member member2 = new Member("member2", 20, teamA); Member member3 = new Member("member3", 30, teamB); Member member4 = new Member("member4", 40, teamB); em.'><meta property="og:type" content="article"><meta property="og:url" content="https://yosong6729.github.io/post/querydsl---%EA%B8%B0%EB%B3%B8-%EB%AC%B8%EB%B2%95/"><meta property="og:image" content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-10-07T22:17:33+09:00"><meta property="article:modified_time" content="2024-10-07T22:17:33+09:00"><meta property="og:site_name" content="Yosong6729 Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="[Querydsl]기본 문법"><meta name=twitter:description content='해당 글은 김영한님의 인프런 강의 실전! Querydsl을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.
예제 도메인 모델을 엔티티 클래스와 ERD만 확인하고 넘어가겠다.
JPQL vs Querydsl 테스트 기본 코드
@SpringBootTest @Transactional public class QuerydslBasicTest { @PersistenceContext EntityManager em; @BeforeEach public void before() { queryFactory = new JPAQueryFactory(em); Team teamA = new Team("teamA"); Team teamB = new Team("teamB"); em.persist(teamA); em.persist(teamB); Member member1 = new Member("member1", 10, teamA); Member member2 = new Member("member2", 20, teamA); Member member3 = new Member("member3", 30, teamB); Member member4 = new Member("member4", 40, teamB); em.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yosong6729.github.io/post/"},{"@type":"ListItem","position":2,"name":"[Querydsl]기본 문법","item":"https://yosong6729.github.io/post/querydsl---%EA%B8%B0%EB%B3%B8-%EB%AC%B8%EB%B2%95/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Querydsl]기본 문법","name":"[Querydsl]기본 문법","description":"해당 글은 김영한님의 인프런 강의 실전! Querydsl을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\n예제 도메인 모델을 엔티티 클래스와 ERD만 확인하고 넘어가겠다.\nJPQL vs Querydsl 테스트 기본 코드\n@SpringBootTest @Transactional public class QuerydslBasicTest { @PersistenceContext EntityManager em; @BeforeEach public void before() { queryFactory = new JPAQueryFactory(em); Team teamA = new Team(\u0026#34;teamA\u0026#34;); Team teamB = new Team(\u0026#34;teamB\u0026#34;); em.persist(teamA); em.persist(teamB); Member member1 = new Member(\u0026#34;member1\u0026#34;, 10, teamA); Member member2 = new Member(\u0026#34;member2\u0026#34;, 20, teamA); Member member3 = new Member(\u0026#34;member3\u0026#34;, 30, teamB); Member member4 = new Member(\u0026#34;member4\u0026#34;, 40, teamB); em.","keywords":["Querydsl"],"articleBody":" 해당 글은 김영한님의 인프런 강의 실전! Querydsl을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.\n예제 도메인 모델을 엔티티 클래스와 ERD만 확인하고 넘어가겠다.\nJPQL vs Querydsl 테스트 기본 코드\n@SpringBootTest @Transactional public class QuerydslBasicTest { @PersistenceContext EntityManager em; @BeforeEach public void before() { queryFactory = new JPAQueryFactory(em); Team teamA = new Team(\"teamA\"); Team teamB = new Team(\"teamB\"); em.persist(teamA); em.persist(teamB); Member member1 = new Member(\"member1\", 10, teamA); Member member2 = new Member(\"member2\", 20, teamA); Member member3 = new Member(\"member3\", 30, teamB); Member member4 = new Member(\"member4\", 40, teamB); em.persist(member1); em.persist(member2); em.persist(member3); em.persist(member4); } } @BeforeEach로 각 테스트 실행전에 데이터를 세팅한다.\nQuerydsl vs JPQL\n@Test public void startJPQL() { String qlString = \"select m from Member m\" + \" where m.username =: username\"; Member findMember = em.createQuery(qlString, Member.class) .setParameter(\"username\", \"member1\") .getSingleResult(); assertThat(findMember.getUsername()).isEqualTo(\"member1\"); } @Test public void startQuerydsl() { JPAQueryFactory queryFactory = new JPAQueryFactory(em); QMember m = new QMember(\"m\"); Member findMember = queryFactory .select(m) .from(m) .where(m.username.eq(\"member1\")) .fetchOne(); assertThat(findMember.getUsername()).isEqualTo(\"member1\"); } EntityManger로 JPAQueryFactory를 생성한다. QMember m = new QMember(”m”);의 “m”은 어떤 QMember인지 구분하기 위한 것이다. Querydsl은 JPQL 빌더이다. JPQL은 문자이기때문에 실행시점에 오류가 발생하지만, Querydsl은 자바 코드이기때문에 컴파일 시점에 오류가 발생한다. JPQL은 파라미터 바인딩을 직접 하지만, Querydsl은 파라미터 바인딩을 자동처리가 된다. JPAQueryFactory를 필드로 @SpringBootTest @Transactional public class QuerydslBasicTest { @PersistenceContext EntityManager em; JPAQueryFactory queryFactory; @BeforeEach public void before() { queryFactory = new JPAQueryFactory(em); //... } @Test public void startQuerydsl() { QMember m = new QMember(\"m\"); Member findMember = queryFactory .select(m) .from(m) .where(m.username.eq(\"member1\")) .fetchOne(); assertThat(findMember.getUsername()).isEqualTo(\"member1\"); } } JPAQueryFactory를 필드로 제공하면 동시성 문제는 JPAQueryFactory를 생성할때 제공하는 EntityManager(em)에 달려있다. 스프링 프레임워크는 여러 쓰레드에서 동시에 같은 EntityManager에 접근해도, 트랜잭션 마다 별도의 영속성 컨텍스트를 제공하기 때문에, 동시성 문제는 걱정하지 않아도 된다.\n기본 Q-Type 활용 Q클래스 인스턴스를 사용하는 2가지 방법\nQMember qMember = new QMember(\"m\"); //별칭 직접 지정 QMember qMember = QMember.member; //기본 인스턴스 사용 기본 인스턴스를 static import와 함께 사용하기\nimport static study.querydsl.entity.QMember.*; @Test public void startQuerydsl() { Member findMember = queryFactory .select(member) .from(member) .where(member.username.eq(\"member1\")) .fetchOne(); assertThat(findMember.getUsername()).isEqualTo(\"member1\"); } 기본 인스턴스와 static import를 함께사용하면 코드를 간략화 할수 있다.\n다음 설정을 추가하면 실행되는 JPQL을 볼수 있다.\nspring.jpa.properties.hibernate.use_sql_comments: true 테스트 코드를 실행하면 다음과 같이 /* ~~ */로 표시되는 JPQL을 확인할수 있고, 이후에 SQL문을 확인 할수 있다.\n위 JPQL코드에서 from Member member1의 “member1”은 Qmember 클래스안에 다음과 같이 정의된 것으로 나오게된다.\n같은 테이블을 조인해야 하는 경우가 아니면 기본 인스턴스를 사용하자\n검색 조건 쿼리 기본 검색 쿼리\n@Test public void search() { Member findMember = queryFactory .selectFrom(member) .where(member.username.eq(\"member1\") .and(member.age.eq(10))) .fetchOne(); assertThat(findMember.getUsername()).isEqualTo(\"member1\"); } 쿼리 결과로 and 조건이 붙은걸 확인 할수 있다.\n검색 조건은 .and(), or()를 메서드 체인으로 연결할수 있다. select, from을 selectFrom으로 합칠 수 있다.\nJPQL이 제공하는 모든 검색 조건 제공 member.username.eq(\"member1\") // username = 'member1' member.username.ne(\"member1\") //username != 'member1' member.username.eq(\"member1\").not() // username != 'member1' member.username.isNotNull() //이름이 is not null member.age.in(10, 20) // age in (10,20) member.age.notIn(10, 20) // age not in (10, 20) member.age.between(10,30) //between 10, 30 member.age.goe(30) // age \u003e= 30 member.age.gt(30) // age \u003e 30 member.age.loe(30) // age \u003c= 30 member.age.lt(30) // age \u003c 30 member.username.like(\"member%\") //like 검색 member.username.contains(\"member\") // like ‘%member%’ 검색 member.username.startsWith(\"member\") //like ‘member%’ 검색 AND 조건을 파라미터로 처리 @Test public void searchAndParam() { Member findMember = queryFactory .selectFrom(member) .where( member.username.eq(\"member1\"), member.age.eq(10)) .fetchOne(); assertThat(findMember.getUsername()).isEqualTo(\"member1\"); } where()에 파라미터로 검색 조건을 추가하면 AND 조건이 추가된다.\n파라미터 검색 조건으로 null이 오면 null 값을 무시하기떄문에 메서드 추출을 활용해서 동적 쿼리를 만들수 있다.\n쿼리 결과로 and 조건이 추가된것을 확인 할수 있다.\n결과 조회 fetch(): 리스트 조회, 데이터 없으면 빈 리스트 반환 fetchOne(): 단 건 조회 결과가 없으면: null 결과가 둘 이상이면: com.querydsl.core.NonUniqueResultException 예외 발생 fetchFirst(): limit(1).fetchOne() fetchResults(): 페이징 정보 포함, total count 쿼리 추가 실행 fetchCount(): count 쿼리로 변경해서 count 수 조회 @Test public void resultFetch() { //List List\u003cMember\u003e fetch = queryFactory .selectFrom(member) .fetch(); //단 건 조회 Member fetchOne = queryFactory .selectFrom(member) .fetchOne(); //처음 한 건 조회 Member fetchFirst = queryFactory .selectFrom(member) .fetchFirst(); //페이징에서 사용 QueryResults\u003cMember\u003e results = queryFactory .selectFrom(member) .fetchResults(); // results.getTotal(); // List content = results.getResults(); //count 쿼리로 변경 long count = queryFactory .selectFrom(member) .fetchCount(); } fetchResults()는 totalCout의 값을 가져와야해서 다음과 같이 쿼리가 총 2번 실행 된다.\n정렬 회원 정렬 순서\n회원 나이 내림차순(desc) 회원 이름 올림차순(asc) 단 2에서 회원 이름이 없으면 마지막에 출력(nulls last)\n@Test public void sort() { em.persist(new Member(null, 100)); em.persist(new Member(\"member5\", 100)); em.persist(new Member(\"member6\", 100)); List\u003cMember\u003e result = queryFactory .selectFrom(member) .where(member.age.eq(100)) .orderBy(member.age.desc(), member.username.asc().nullsLast()) .fetch(); Member member5 = result.get(0); Member member6 = result.get(1); Member memberNull = result.get(2); assertThat(member5.getUsername()).isEqualTo(\"member5\"); assertThat(member6.getUsername()).isEqualTo(\"member6\"); assertThat(memberNull.getUsername()).isNull(); } 일반 정렬 desc(): 내림차순, asc(): 올림차순 null 데이터 순서 부여 nullsLast(): null 마지막, nullsFirst(): null 처음 페이징 조회 건수 제한\n@Test public void paging1() { List\u003cMember\u003e result = queryFactory .selectFrom(member) .orderBy(member.username.desc()) .offset(1) .limit(2) .fetch(); assertThat(result.size()).isEqualTo(2); } offset(1): 0부터 시작이고 offset을 1로 설정 limit(2): 최대 2건 조회 전체 조회 수가 필요하면?\n@Test public void paging2() { QueryResults\u003cMember\u003e queryResults = queryFactory .selectFrom(member) .orderBy(member.username.desc()) .offset(1) .limit(2) .fetchResults(); assertThat(queryResults.getTotal()).isEqualTo(4); assertThat(queryResults.getLimit()).isEqualTo(2); assertThat(queryResults.getOffset()).isEqualTo(1); assertThat(queryResults.getResults().size()).isEqualTo(2); } 실무에서 페이징 쿼리를 작성할 때, 데이터를 조회하는 쿼리는 여러 테이블을 조인해야 하지만, count 쿼리는 조인이 필요 없는 경우도 있다. 그런데 이렇게 자동화된 count 쿼리는 원본 쿼리와 같이 모두 조인을 해버리기 때문에 성능이 안나올 수 있다. count 쿼리에 조인이 필요없는 성능 최적화가 필요하다면, count 전용 쿼리를 별도로 작성해야 한다.\n집합 집합 함수 회원수, 나이 합, 평균 나이, 최대 나이, 최소 나이를 구해보자\n@Test public void aggregation() { List\u003cTuple\u003e result = queryFactory .select( member.count(), member.age.sum(), member.age.avg(), member.age.max(), member.age.min() ) .from(member) .fetch(); Tuple tuple = result.get(0); assertThat(tuple.get(member.count())).isEqualTo(4); assertThat(tuple.get(member.age.sum())).isEqualTo(100); assertThat(tuple.get(member.age.avg())).isEqualTo(25); assertThat(tuple.get(member.age.max())).isEqualTo(40); assertThat(tuple.get(member.age.min())).isEqualTo(10); } JPQL이 제공하는 모든 집합 함수를 제공한다.\n쿼리 결과는 다음과 같이 작성된다.\n실무에서는 튜플많이 쓰지 않고 DTO를 사용하는 방법을 많이 사용한다.\nGroupBy 사용 팀의 이름과 각 팀의 평균 연령을 구해보자\n@Test public void group() throws Exception{ List\u003cTuple\u003e result = queryFactory .select( team.name, member.age.avg() ) .from(member) .join(member.team, team) .groupBy(team.name) .fetch(); Tuple teamA = result.get(0); Tuple teamB = result.get(1); assertThat(teamA.get(team.name)).isEqualTo(\"teamA\"); assertThat(teamA.get(member.age.avg())).isEqualTo(15); assertThat(teamB.get(team.name)).isEqualTo(\"teamB\"); assertThat(teamB.get(member.age.avg())).isEqualTo(35); } 쿼리 결과는 다음과 같이 나온다.\ngroupBy(), having() 예시\n… .groupBy(item.price) .having(item.price.gt(1000)) ... 조인 - 기본 조인 기본 조인 조인의 기본 문법은 첫 번째 파라미터에 조인 대상을 지정하고, 두 번째 파라미터에 별칭(alias)으로 사용할 Q 타입을 지정하면 된다.\njoin(조인 대상, 별칭으로 사용할 Q타입) 기본 조인\n팀 A에 소속된 모드 회원을 조회 해보자\n@Test public void join() { List\u003cMember\u003e result = queryFactory .selectFrom(member) .join(member.team, team) .where(team.name.eq(\"teamA\")) .fetch(); assertThat(result) .extracting(\"username\") .containsExactly(\"member1\", \"member2\"); } join(), innerJoin(): 내부 조인 leftJoin(): left 외부 조인 rightJoin(): right 외부 조인 쿼리 결과를 보면 조인이 되는것을 확이할 수 있다.\n세타 조인 세타 조인은 연관관계가 없는 필드로 조인하는 것이다.\n회원의 이름이 팀 이름과 같은 회원을 조회 해보자\n@Test public void theta_join() { em.persist(new Member(\"teamA\")); em.persist(new Member(\"teamB\")); em.persist(new Member(\"teamC\")); List\u003cMember\u003e result = queryFactory .select(member) .from(member, team) .where(member.username.eq(team.name)) .fetch(); assertThat(result) .extracting(\"username\") .containsExactly(\"teamA\", \"teamB\"); } from 절에 여러 엔티티를 선택해서 세타 조인을 할수있다. 조인 on을 사용하면 외부 조인이 가능하다. 쿼리 결과에서 세타 조인이 되는 것을 확인 할수 있다.\n조인 - on절 조인 대상 필터링 회원과 팀을 조인하면서, 팀 이름이 teamA인 팀만 조인하고 회원은 모두 조회해보자.\n@Test public void join_on_filtering() { List\u003cTuple\u003e result = queryFactory .select(member, team) .from(member) .leftJoin(member.team, team).on(team.name.eq(\"teamA\")) .fetch(); for (Tuple tuple : result) { System.out.println(\"tuple = \" + tuple); } } 쿼리 결과와 result는 다음과 같다.\nt=[Member(id=3, username=member1, age=10), Team(id=1, name=teamA)]\rt=[Member(id=4, username=member2, age=20), Team(id=1, name=teamA)]\rt=[Member(id=5, username=member3, age=30), null]\rt=[Member(id=6, username=member4, age=40), null] on 절을 활용해 조인 대상을 필터링 할 때, 외부조인이 아니라 내부조인(inner join)을 사용하면, where 절에서 필터링 하는 것과 기능이 동일하다. 따라서 on 절을 활용한 조인 대상 필터링을 사용할 때, 내부조인 이면 익숙한 where 절로 해결하고, 정말 외부조인이 필요한 경우에만 이 기능을 사용하자.\n내부조인을 사용하고 where절에서 필터링\n@Test public void join_on_filtering() { List\u003cTuple\u003e result = queryFactory .select(member, team) .from(member) .join(member.team, team) .where(team.name.eq(\"teamA\")) // .leftJoin(member.team, team).on(team.name.eq(\"teamA\")) .fetch(); for (Tuple tuple : result) { System.out.println(\"tuple = \" + tuple); } } 이전거와 동일한 결과이다.\n연관관계 없는 엔티티 외부 조인 회원의 이름과 팀의 이름이 같은 대상을 외부 조인 해보자.\n@Test public void join_on_no_relation() { em.persist(new Member(\"teamA\")); em.persist(new Member(\"teamB\")); em.persist(new Member(\"teamC\")); List\u003cTuple\u003e result = queryFactory .select(member, team) .from(member) .leftJoin(team).on(member.username.eq(team.name)) .fetch(); for (Tuple tuple : result) { System.out.println(\"tuple = \" + tuple); } } 연관관계 없는 외부 조인은 일반 조인과 문법이 다르다. leftJoin() 부분에 일반 조인과 다르게 엔티티 하나만 들어간다. 일반조인: leftJoin(member.team, team) on조인: from(member).leftJoin(team).on(xxx) 쿼리 결과와 result\nt=[Member(id=3, username=member1, age=10), null]\rt=[Member(id=4, username=member2, age=20), null]\rt=[Member(id=5, username=member3, age=30), null]\rt=[Member(id=6, username=member4, age=40), null]\rt=[Member(id=7, username=teamA, age=0), Team(id=1, name=teamA)]\rt=[Member(id=8, username=teamB, age=0), Team(id=2, name=teamB)] 조인 - 페치 조인 페치 조인 미적용\n지연로딩으로 Member SQL 쿼리만 실행된다.\n@PersistenceUnit EntityManagerFactory emf; @Test public void fetchJoinNo() { em.flush(); em.clear(); Member findMember = queryFactory .selectFrom(member) .where(member.username.eq(\"member1\")) .fetchOne(); boolean loaded = emf.getPersistenceUnitUtil().isLoaded(findMember.getTeam()); assertThat(loaded).as(\"페치 조인 미적용\").isFalse(); } EntityManagerFactory.getPersistenceUnitUtil().isLoaded()로 이미 초기화가 된 엔티티인지 아닌지 알수있다.\n쿼리 결과\n페치 조인 적용 전에는 member만 조회하는것을 알수 있다.\n페치 조인 적용\n즉시로딩으로 Members, Team SQL 쿼리 조인으로 한번에 조회한다.\n@Test public void fetchJoinUse() { em.flush(); em.clear(); Member findMember = queryFactory .selectFrom(member) .join(member.team, team).fetchJoin() .where(member.username.eq(\"member1\")) .fetchOne(); boolean loaded = emf.getPersistenceUnitUtil().isLoaded(findMember.getTeam()); assertThat(loaded).as(\"페치 조인 미적용\").isTrue(); } join(), leftJoin()등 조인 기능 뒤에 fetchJoin()을 추가하면 된다.\n쿼리 결과로 페치 조인이 잘 적용된것을 확인할수 있다.\n서브 쿼리 서브 쿼리를 사용하기 위해서 com.querydsl.jpa.JPAExpressions을사용한다.\n서브 쿼리 eq 사용\n나이가 가장 많은 회원을 조회 해보자.\n@Test public void subQuery() { QMember memberSub = new QMember(\"memberSub\"); List\u003cMember\u003e result = queryFactory .selectFrom(member) .where(member.age.eq( JPAExpressions .select(memberSub.age.max()) .from(memberSub) )) .fetch(); assertThat(result).extracting(\"age\") .containsExactly(40); } 서브 쿼리에 중복되는 alias를 가진 Qtype을 사용하면 안되기때문에 Qtype을 새로 생성해준다.\n쿼리 결과를 보면 where절에 서브 쿼리가 적용된것을 확인할수 있다.\n서브 쿼리 goe 사용\n@Test public void subQueryGoe() { QMember memberSub = new QMember(\"memberSub\"); List\u003cMember\u003e result = queryFactory .selectFrom(member) .where(member.age.goe( JPAExpressions .select(memberSub.age.avg()) .from(memberSub) )) .fetch(); assertThat(result).extracting(\"age\") .containsExactly(30, 40); } 쿼리 결과에서 where절에 ≥의 서브 쿼리가 적용된것을 확인할 수 있다.\n서브쿼리 여러 건 처리 in 사용\n@Test public void subQueryIn() { QMember memberSub = new QMember(\"memberSub\"); List\u003cMember\u003e result = queryFactory .selectFrom(member) .where(member.age.in( JPAExpressions .select(memberSub.age) .from(memberSub) .where(memberSub.age.gt(10)) )) .fetch(); assertThat(result).extracting(\"age\") .containsExactly(20, 30, 40); } 쿼리 결과를 보면 where 절에 in 서브 쿼리가 적용된것을 확인할수 있다.\nselect 절에 subquery\n@Test public void selectSubQuery() { QMember memberSub = new QMember(\"memberSub\"); List\u003cTuple\u003e result = queryFactory .select(member.username, JPAExpressions .select(memberSub.age.avg()) .from(memberSub) ) .from(member) .fetch(); for (Tuple tuple : result) { System.out.println(\"tuple = \" + tuple); } } 쿼리 결과를 보면 select절에 서브 쿼리가 적용된것을 확인할수 있다.\nstatic import 활용\nimport static com.querydsl.jpa.JPAExpressions.select; List\u003cTuple\u003e result = queryFactory .select(member.username, select(memberSub.age.avg()) .from(memberSub) ) .from(member) .fetch(); JPAExpressions을 static import를 활용해서 코드를 가독성있게 바꾸었다.\nfrom절의 서브쿼리 한계\nJPA JPQL 서브쿼리의 한계점은 from 절의 서브쿼리는 지원하지 않고 Querydsl도 지원하지 않는다. 하이버네이트 구현체를 사용하면 select 절의 서브쿼리는 지원하고 Querydsl도 하이버네이트 구현체를 사용하면 select 절의 서브쿼리를 지원한다.\nfrom절의 서브쿼리 해결방안\n가능하다면 서브쿼리를 join으로 변경한다. 애플리케이션에서 쿼리를 2번 분리해서 실행한다. nativeSQL을 사용한다. Case 문 select, where, order by 에서 사용 가능하다.\n단순한 조건\n@Test public void basicCase() { List\u003cString\u003e result = queryFactory .select(member.age .when(10).then(\"열살\") .when(20).then(\"스무살\") .otherwise(\"기타\")) .from(member) .fetch(); for (String s : result) { System.out.println(\"s = \" + s); } } 쿼리 결과를 보면 select절에 Case문이 적용된것을 확인할수 있다.\nresult 출력 결과\n복잡한 조건\n@Test public void complexCase() { List\u003cString\u003e result = queryFactory .select(new CaseBuilder() .when(member.age.between(0, 20)).then(\"0~20살\") .when(member.age.between(21, 30)).then(\"21~30살\") .otherwise(\"기타\") ) .from(member) .fetch(); for (String s : result) { System.out.println(\"s = \" + s); } } 복잡한 조건에서는 CaseBuilder를 사용한다.\n쿼리 결과를 보면 복잡한 case문이 적용된것을 확인할수 있다.\nresult 출력 결과\norderBy에서 Case 문 함께 사용\n다음과 같은 임의의 순서로 회원을 출력해보자\n0 ~ 30살이 아닌 회원을 가장 먼저 출력 0 ~ 20살 회원 출력 21 ~ 30살 회원 출력 @Test public void OrderByCase() { NumberExpression\u003cInteger\u003e rankPath = new CaseBuilder() .when(member.age.between(0, 20)).then(2) .when(member.age.between(21, 30)).then(1) .otherwise(3); List\u003cTuple\u003e result = queryFactory .select(member.username, member.age, rankPath) .from(member) .orderBy(rankPath.desc()) .fetch(); for (Tuple tuple : result) { String username = tuple.get(member.username); Integer age = tuple.get(member.age); Integer rank = tuple.get(rankPath); System.out.println(\"username = \" + username + \" age = \" + age + \" rank = \" + rank); } } Querydsl은 자바 코드로 작성하기 때문에 rankPath처럼 복잡한 조건을 변수로 선언해서 select절, orderBy절에서 함께 사용할 수 있다.\nresult 출력 결과\nusername = member4 age = 40 rank = 3\rusername = member1 age = 10 rank = 2\rusername = member2 age = 20 rank = 2\rusername = member3 age = 30 rank = 1 상수, 문자 더하기 상수가 필요하면 Expressions.constant(xxx)를 사용한다.\n@Test public void constant() { List\u003cTuple\u003e result = queryFactory .select(member.username, Expressions.constant(\"A\")) .from(member) .fetch(); for (Tuple tuple : result) { System.out.println(\"tuple = \" + tuple); } } 쿼리에서는 상수를 더한것이 적용되지않고 결과에서는 상수를 받는다.\nresult 출력 결과\n문자 더하기 concat @Test public void concat() { String result = queryFactory .select(member.username.concat(\"_\").concat(member.age.stringValue())) .from(member) .where(member.username.eq(\"member1\")) .fetchOne(); System.out.println(\"result = \" + result); } 쿼리 결과를 보면 concat이 적용된것을 확인할수 있다.\nresult 출력 결과\n문자가 아닌 다른 타입들은 stringValue()로 문자로 변환할 수 있다. 이 방법은 ENUM을 처리할 때도 자주 사용한다.\n","wordCount":"2032","inLanguage":"en","image":"https://yosong6729.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-10-07T22:17:33+09:00","dateModified":"2024-10-07T22:17:33+09:00","author":{"@type":"Person","name":"yosong6729"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yosong6729.github.io/post/querydsl---%EA%B8%B0%EB%B3%B8-%EB%AC%B8%EB%B2%95/"},"publisher":{"@type":"Organization","name":"Yosong6729 Blog","logo":{"@type":"ImageObject","url":"https://yosong6729.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yosong6729.github.io/ accesskey=h title="Yosong6729 블로그 (Alt + H)"><img src=https://yosong6729.github.io/apple-touch-icon.png alt aria-label=logo height=35>Yosong6729 블로그</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yosong6729.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://yosong6729.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yosong6729.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://yosong6729.github.io/post/>Posts</a></div><h1 class="post-title entry-hint-parent">[Querydsl]기본 문법</h1><div class=post-meta><span title='2024-10-07 22:17:33 +0900 KST'>October 7, 2024</span>&nbsp;·&nbsp;yosong6729&nbsp;|&nbsp;<a href=https://github.com/yosong6729/blog/tree/main/content/post/Querydsl%20-%20%ea%b8%b0%eb%b3%b8%20%eb%ac%b8%eb%b2%95/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#jpql-vs-querydsl aria-label="JPQL vs Querydsl">JPQL vs Querydsl</a><ul><li><a href=#jpaqueryfactory%eb%a5%bc-%ed%95%84%eb%93%9c%eb%a1%9c aria-label="JPAQueryFactory를 필드로">JPAQueryFactory를 필드로</a></li></ul></li><li><a href=#%ea%b8%b0%eb%b3%b8-q-type-%ed%99%9c%ec%9a%a9 aria-label="기본 Q-Type 활용">기본 Q-Type 활용</a></li><li><a href=#%ea%b2%80%ec%83%89-%ec%a1%b0%ea%b1%b4-%ec%bf%bc%eb%a6%ac aria-label="검색 조건 쿼리">검색 조건 쿼리</a><ul><li><a href=#jpql%ec%9d%b4-%ec%a0%9c%ea%b3%b5%ed%95%98%eb%8a%94-%eb%aa%a8%eb%93%a0-%ea%b2%80%ec%83%89-%ec%a1%b0%ea%b1%b4-%ec%a0%9c%ea%b3%b5 aria-label="JPQL이 제공하는 모든 검색 조건 제공">JPQL이 제공하는 모든 검색 조건 제공</a></li><li><a href=#and-%ec%a1%b0%ea%b1%b4%ec%9d%84-%ed%8c%8c%eb%9d%bc%eb%af%b8%ed%84%b0%eb%a1%9c-%ec%b2%98%eb%a6%ac aria-label="AND 조건을 파라미터로 처리">AND 조건을 파라미터로 처리</a></li></ul></li><li><a href=#%ea%b2%b0%ea%b3%bc-%ec%a1%b0%ed%9a%8c aria-label="결과 조회">결과 조회</a></li><li><a href=#%ec%a0%95%eb%a0%ac aria-label=정렬>정렬</a></li><li><a href=#%ed%8e%98%ec%9d%b4%ec%a7%95 aria-label=페이징>페이징</a></li><li><a href=#%ec%a7%91%ed%95%a9 aria-label=집합>집합</a><ul><li><a href=#%ec%a7%91%ed%95%a9-%ed%95%a8%ec%88%98 aria-label="집합 함수">집합 함수</a></li><li><a href=#groupby-%ec%82%ac%ec%9a%a9 aria-label="GroupBy 사용">GroupBy 사용</a></li></ul></li><li><a href=#%ec%a1%b0%ec%9d%b8---%ea%b8%b0%eb%b3%b8-%ec%a1%b0%ec%9d%b8 aria-label="조인 - 기본 조인">조인 - 기본 조인</a><ul><li><a href=#%ea%b8%b0%eb%b3%b8-%ec%a1%b0%ec%9d%b8 aria-label="기본 조인">기본 조인</a></li><li><a href=#%ec%84%b8%ed%83%80-%ec%a1%b0%ec%9d%b8 aria-label="세타 조인">세타 조인</a></li></ul></li><li><a href=#%ec%a1%b0%ec%9d%b8---on%ec%a0%88 aria-label="조인 - on절">조인 - on절</a><ul><li><a href=#%ec%a1%b0%ec%9d%b8-%eb%8c%80%ec%83%81-%ed%95%84%ed%84%b0%eb%a7%81 aria-label="조인 대상 필터링">조인 대상 필터링</a></li><li><a href=#%ec%97%b0%ea%b4%80%ea%b4%80%ea%b3%84-%ec%97%86%eb%8a%94-%ec%97%94%ed%8b%b0%ed%8b%b0-%ec%99%b8%eb%b6%80-%ec%a1%b0%ec%9d%b8 aria-label="연관관계 없는 엔티티 외부 조인">연관관계 없는 엔티티 외부 조인</a></li></ul></li><li><a href=#%ec%a1%b0%ec%9d%b8---%ed%8e%98%ec%b9%98-%ec%a1%b0%ec%9d%b8 aria-label="조인 - 페치 조인">조인 - 페치 조인</a></li><li><a href=#%ec%84%9c%eb%b8%8c-%ec%bf%bc%eb%a6%ac aria-label="서브 쿼리">서브 쿼리</a></li><li><a href=#case-%eb%ac%b8 aria-label="Case 문">Case 문</a></li><li><a href=#%ec%83%81%ec%88%98-%eb%ac%b8%ec%9e%90-%eb%8d%94%ed%95%98%ea%b8%b0 aria-label="상수, 문자 더하기">상수, 문자 더하기</a><ul><li><a href=#%eb%ac%b8%ec%9e%90-%eb%8d%94%ed%95%98%ea%b8%b0-concat aria-label="문자 더하기 concat">문자 더하기 concat</a></li></ul></li></ul></div></details></div><div class=post-content><blockquote><p>해당 글은 김영한님의 인프런 강의 <a href=https://www.inflearn.com/course/querydsl-%EC%8B%A4%EC%A0%84>실전! Querydsl</a>을 듣고 내용을 정리하기 위한 것으로 자세한 설명은 해당 강의를 통해 확인할 수 있습니다.</p></blockquote><hr><p>예제 도메인 모델을 엔티티 클래스와 ERD만 확인하고 넘어가겠다.</p><p><img loading=lazy src=images/image.png alt=image.png></p><hr><h2 id=jpql-vs-querydsl>JPQL vs Querydsl<a hidden class=anchor aria-hidden=true href=#jpql-vs-querydsl>#</a></h2><p><strong>테스트 기본 코드</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>QuerydslBasicTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PersistenceContext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>EntityManager</span><span class=w> </span><span class=n>em</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@BeforeEach</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>before</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queryFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JPAQueryFactory</span><span class=p>(</span><span class=n>em</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Team</span><span class=w> </span><span class=n>teamA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Team</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Team</span><span class=w> </span><span class=n>teamB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Team</span><span class=p>(</span><span class=s>&#34;teamB&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>teamB</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Member</span><span class=w> </span><span class=n>member1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Member</span><span class=w> </span><span class=n>member2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;member2&#34;</span><span class=p>,</span><span class=w> </span><span class=n>20</span><span class=p>,</span><span class=w> </span><span class=n>teamA</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Member</span><span class=w> </span><span class=n>member3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;member3&#34;</span><span class=p>,</span><span class=w> </span><span class=n>30</span><span class=p>,</span><span class=w> </span><span class=n>teamB</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Member</span><span class=w> </span><span class=n>member4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;member4&#34;</span><span class=p>,</span><span class=w> </span><span class=n>40</span><span class=p>,</span><span class=w> </span><span class=n>teamB</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>member1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>member2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>member3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=n>member4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>@BeforeEach로 각 테스트 실행전에 데이터를 세팅한다.</p><p><strong>Querydsl vs JPQL</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startJPQL</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>qlString</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;select m from Member m&#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34; where m.username =: username&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>findMember</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>em</span><span class=p>.</span><span class=na>createQuery</span><span class=p>(</span><span class=n>qlString</span><span class=p>,</span><span class=w> </span><span class=n>Member</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>setParameter</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;member1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>getSingleResult</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>findMember</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startQuerydsl</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>JPAQueryFactory</span><span class=w> </span><span class=n>queryFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JPAQueryFactory</span><span class=p>(</span><span class=n>em</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>QMember</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QMember</span><span class=p>(</span><span class=s>&#34;m&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Member</span><span class=w> </span><span class=n>findMember</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>fetchOne</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThat</span><span class=p>(</span><span class=n>findMember</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>EntityManger로 JPAQueryFactory를 생성한다.</li><li>QMember m = new QMember(”m”);의 “m”은 어떤 QMember인지 구분하기 위한 것이다.</li><li>Querydsl은 JPQL 빌더이다.</li><li>JPQL은 문자이기때문에 실행시점에 오류가 발생하지만, Querydsl은 자바 코드이기때문에 컴파일 시점에 오류가 발생한다.</li><li>JPQL은 파라미터 바인딩을 직접 하지만, Querydsl은 파라미터 바인딩을 자동처리가 된다.</li></ul><h3 id=jpaqueryfactory를-필드로>JPAQueryFactory를 필드로<a hidden class=anchor aria-hidden=true href=#jpaqueryfactory를-필드로>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@SpringBootTest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>QuerydslBasicTest</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PersistenceContext</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>EntityManager</span><span class=w> </span><span class=n>em</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>JPAQueryFactory</span><span class=w> </span><span class=n>queryFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@BeforeEach</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>before</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>queryFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JPAQueryFactory</span><span class=p>(</span><span class=n>em</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startQuerydsl</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>QMember</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QMember</span><span class=p>(</span><span class=s>&#34;m&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Member</span><span class=w> </span><span class=n>findMember</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>m</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>fetchOne</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>assertThat</span><span class=p>(</span><span class=n>findMember</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>JPAQueryFactory를 필드로 제공하면 동시성 문제는 JPAQueryFactory를 생성할때 제공하는 EntityManager(em)에 달려있다. 스프링 프레임워크는 여러 쓰레드에서 동시에 같은 EntityManager에 접근해도, <strong>트랜잭션 마다 별도의 영속성 컨텍스트를 제공</strong>하기 때문에, 동시성 문제는 걱정하지 않아도 된다.</p></blockquote><hr><h2 id=기본-q-type-활용>기본 Q-Type 활용<a hidden class=anchor aria-hidden=true href=#기본-q-type-활용>#</a></h2><p><strong>Q클래스 인스턴스를 사용하는 2가지 방법</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>QMember</span><span class=w> </span><span class=n>qMember</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QMember</span><span class=p>(</span><span class=s>&#34;m&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>//별칭 직접 지정</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>QMember</span><span class=w> </span><span class=n>qMember</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>QMember</span><span class=p>.</span><span class=na>member</span><span class=p>;</span><span class=w> </span><span class=c1>//기본 인스턴스 사용</span><span class=w>
</span></span></span></code></pre></div><p><strong>기본 인스턴스를 static import와 함께 사용하기</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import static</span><span class=w> </span><span class=nn>study.querydsl.entity.QMember.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startQuerydsl</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>findMember</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchOne</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>findMember</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>기본 인스턴스와 static import를 함께사용하면 코드를 간략화 할수 있다.</p><p>다음 설정을 추가하면 실행되는 JPQL을 볼수 있다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spring.jpa.properties.hibernate.use_sql_comments</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>테스트 코드를 실행하면 다음과 같이 /* ~~ */로 표시되는 JPQL을 확인할수 있고, 이후에 SQL문을 확인 할수 있다.</p><p><img loading=lazy src=images/image%201.png alt=image.png></p><p>위 JPQL코드에서 from Member member1의 “member1”은 Qmember 클래스안에 다음과 같이 정의된 것으로 나오게된다.</p><p><img loading=lazy src=images/image%202.png alt=image.png></p><blockquote><p>같은 테이블을 조인해야 하는 경우가 아니면 기본 인스턴스를 사용하자</p></blockquote><hr><h2 id=검색-조건-쿼리>검색 조건 쿼리<a hidden class=anchor aria-hidden=true href=#검색-조건-쿼리>#</a></h2><p><strong>기본 검색 쿼리</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>search</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>findMember</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>and</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=n>10</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchOne</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>findMember</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과로 and 조건이 붙은걸 확인 할수 있다.</p><p><img loading=lazy src=images/image%203.png alt=image.png></p><p>검색 조건은 .and(), or()를 메서드 체인으로 연결할수 있다. select, from을 selectFrom으로 합칠 수 있다.</p><h3 id=jpql이-제공하는-모든-검색-조건-제공>JPQL이 제공하는 모든 검색 조건 제공<a hidden class=anchor aria-hidden=true href=#jpql이-제공하는-모든-검색-조건-제공>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// username = &#39;member1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>ne</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>//username != &#39;member1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>).</span><span class=na>not</span><span class=p>()</span><span class=w> </span><span class=c1>// username != &#39;member1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>isNotNull</span><span class=p>()</span><span class=w> </span><span class=c1>//이름이 is not null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>in</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>20</span><span class=p>)</span><span class=w> </span><span class=c1>// age in (10,20)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>notIn</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=w> </span><span class=n>20</span><span class=p>)</span><span class=w> </span><span class=c1>// age not in (10, 20)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>between</span><span class=p>(</span><span class=n>10</span><span class=p>,</span><span class=n>30</span><span class=p>)</span><span class=w> </span><span class=c1>//between 10, 30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>goe</span><span class=p>(</span><span class=n>30</span><span class=p>)</span><span class=w> </span><span class=c1>// age &gt;= 30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>gt</span><span class=p>(</span><span class=n>30</span><span class=p>)</span><span class=w> </span><span class=c1>// age &gt; 30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>loe</span><span class=p>(</span><span class=n>30</span><span class=p>)</span><span class=w> </span><span class=c1>// age &lt;= 30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>lt</span><span class=p>(</span><span class=n>30</span><span class=p>)</span><span class=w> </span><span class=c1>// age &lt; 30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>like</span><span class=p>(</span><span class=s>&#34;member%&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>//like 검색</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=s>&#34;member&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// like ‘%member%’ 검색 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;member&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>//like ‘member%’ 검색</span><span class=w>
</span></span></span></code></pre></div><h3 id=and-조건을-파라미터로-처리>AND 조건을 파라미터로 처리<a hidden class=anchor aria-hidden=true href=#and-조건을-파라미터로-처리>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>searchAndParam</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>findMember</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=n>10</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchOne</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>findMember</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>where()에 파라미터로 검색 조건을 추가하면 AND 조건이 추가된다.</p><p>파라미터 검색 조건으로 null이 오면 null 값을 무시하기떄문에 메서드 추출을 활용해서 동적 쿼리를 만들수 있다.</p><p>쿼리 결과로 and 조건이 추가된것을 확인 할수 있다.</p><p><img loading=lazy src=images/image%204.png alt=image.png></p><hr><h2 id=결과-조회>결과 조회<a hidden class=anchor aria-hidden=true href=#결과-조회>#</a></h2><ul><li>fetch(): 리스트 조회, 데이터 없으면 빈 리스트 반환</li><li>fetchOne(): 단 건 조회<ul><li>결과가 없으면: null</li><li>결과가 둘 이상이면: com.querydsl.core.NonUniqueResultException 예외 발생</li></ul></li><li>fetchFirst(): limit(1).fetchOne()</li><li>fetchResults(): 페이징 정보 포함, total count 쿼리 추가 실행</li><li>fetchCount(): count 쿼리로 변경해서 count 수 조회</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>resultFetch</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//List</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>fetch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//단 건 조회</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>fetchOne</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchOne</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//처음 한 건 조회</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>fetchFirst</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchFirst</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//페이징에서 사용</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>QueryResults</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>results</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchResults</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        results.getTotal();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        List&lt;Member&gt; content = results.getResults();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//count 쿼리로 변경</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>fetchResults()는 totalCout의 값을 가져와야해서 다음과 같이 쿼리가 총 2번 실행 된다.</p><p><img loading=lazy src=images/image%205.png alt=image.png></p><p><img loading=lazy src=images/image%206.png alt=image.png></p><hr><h2 id=정렬>정렬<a hidden class=anchor aria-hidden=true href=#정렬>#</a></h2><p>회원 정렬 순서</p><ol><li>회원 나이 내림차순(desc)</li><li>회원 이름 올림차순(asc)</li></ol><p>단 2에서 회원 이름이 없으면 마지막에 출력(nulls last)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sort</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>100</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;member5&#34;</span><span class=p>,</span><span class=w> </span><span class=n>100</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;member6&#34;</span><span class=p>,</span><span class=w> </span><span class=n>100</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=n>100</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>orderBy</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>desc</span><span class=p>(),</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>asc</span><span class=p>().</span><span class=na>nullsLast</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>member5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>member6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>memberNull</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>member5</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;member5&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>member6</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;member6&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>memberNull</span><span class=p>.</span><span class=na>getUsername</span><span class=p>()).</span><span class=na>isNull</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>일반 정렬<ul><li>desc(): 내림차순, asc(): 올림차순</li></ul></li><li>null 데이터 순서 부여<ul><li>nullsLast(): null 마지막, nullsFirst(): null 처음</li></ul></li></ul><hr><h2 id=페이징>페이징<a hidden class=anchor aria-hidden=true href=#페이징>#</a></h2><p><strong>조회 건수 제한</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>paging1</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>orderBy</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>desc</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>offset</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>limit</span><span class=p>(</span><span class=n>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>size</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>offset(1): 0부터 시작이고 offset을 1로 설정</li><li>limit(2): 최대 2건 조회</li></ul><p><strong>전체 조회 수가 필요하면?</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>paging2</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>QueryResults</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>queryResults</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>orderBy</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>desc</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>offset</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>limit</span><span class=p>(</span><span class=n>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchResults</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>queryResults</span><span class=p>.</span><span class=na>getTotal</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>queryResults</span><span class=p>.</span><span class=na>getLimit</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>queryResults</span><span class=p>.</span><span class=na>getOffset</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>queryResults</span><span class=p>.</span><span class=na>getResults</span><span class=p>().</span><span class=na>size</span><span class=p>()).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>실무에서 페이징 쿼리를 작성할 때, 데이터를 조회하는 쿼리는 여러 테이블을 조인해야 하지만, count 쿼리는 조인이 필요 없는 경우도 있다. 그런데 이렇게 자동화된 count 쿼리는 원본 쿼리와 같이 모두 조인을 해버리기 때문에 성능이 안나올 수 있다. count 쿼리에 조인이 필요없는 성능 최적화가 필요하다면, count 전용 쿼리를 별도로 작성해야 한다.</p></blockquote><hr><h2 id=집합>집합<a hidden class=anchor aria-hidden=true href=#집합>#</a></h2><h3 id=집합-함수>집합 함수<a hidden class=anchor aria-hidden=true href=#집합-함수>#</a></h3><p>회원수, 나이 합, 평균 나이, 최대 나이, 최소 나이를 구해보자</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>aggregation</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Tuple</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>count</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>sum</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>avg</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>max</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>min</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Tuple</span><span class=w> </span><span class=n>tuple</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>tuple</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>count</span><span class=p>())).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>tuple</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>sum</span><span class=p>())).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>tuple</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>avg</span><span class=p>())).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>25</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>tuple</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>max</span><span class=p>())).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>40</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>tuple</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>min</span><span class=p>())).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>10</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>JPQL이 제공하는 모든 집합 함수를 제공한다.</p><p>쿼리 결과는 다음과 같이 작성된다.</p><p><img loading=lazy src=images/image%207.png alt=image.png></p><p>실무에서는 튜플많이 쓰지 않고 DTO를 사용하는 방법을 많이 사용한다.</p><h3 id=groupby-사용>GroupBy 사용<a hidden class=anchor aria-hidden=true href=#groupby-사용>#</a></h3><p>팀의 이름과 각 팀의 평균 연령을 구해보자</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>group</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Tuple</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>team</span><span class=p>.</span><span class=na>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>avg</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>team</span><span class=p>,</span><span class=w> </span><span class=n>team</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>groupBy</span><span class=p>(</span><span class=n>team</span><span class=p>.</span><span class=na>name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Tuple</span><span class=w> </span><span class=n>teamA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Tuple</span><span class=w> </span><span class=n>teamB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>teamA</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>team</span><span class=p>.</span><span class=na>name</span><span class=p>)).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>teamA</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>avg</span><span class=p>())).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>15</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>teamB</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>team</span><span class=p>.</span><span class=na>name</span><span class=p>)).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=s>&#34;teamB&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>teamB</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>avg</span><span class=p>())).</span><span class=na>isEqualTo</span><span class=p>(</span><span class=n>35</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과는 다음과 같이 나온다.</p><p><img loading=lazy src=images/image%208.png alt=image.png></p><p><strong>groupBy(), having() 예시</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=err>…</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>groupBy</span><span class=p>(</span><span class=n>item</span><span class=p>.</span><span class=na>price</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>having</span><span class=p>(</span><span class=n>item</span><span class=p>.</span><span class=na>price</span><span class=p>.</span><span class=na>gt</span><span class=p>(</span><span class=n>1000</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span></code></pre></div><hr><h2 id=조인---기본-조인>조인 - 기본 조인<a hidden class=anchor aria-hidden=true href=#조인---기본-조인>#</a></h2><h3 id=기본-조인>기본 조인<a hidden class=anchor aria-hidden=true href=#기본-조인>#</a></h3><p>조인의 기본 문법은 첫 번째 파라미터에 조인 대상을 지정하고, 두 번째 파라미터에 별칭(alias)으로 사용할 Q 타입을 지정하면 된다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>join</span><span class=p>(</span><span class=n>조인</span><span class=w> </span><span class=n>대상</span><span class=p>,</span><span class=w> </span><span class=n>별칭으로</span><span class=w> </span><span class=n>사용할</span><span class=w> </span><span class=n>Q타입</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><strong>기본 조인</strong></p><p>팀 A에 소속된 모드 회원을 조회 해보자</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>join</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>team</span><span class=p>,</span><span class=w> </span><span class=n>team</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>team</span><span class=p>.</span><span class=na>name</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>extracting</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>containsExactly</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;member2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>join(), innerJoin(): 내부 조인</li><li>leftJoin(): left 외부 조인</li><li>rightJoin(): right 외부 조인</li></ul><p>쿼리 결과를 보면 조인이 되는것을 확이할 수 있다.</p><p><img loading=lazy src=images/image%209.png alt=image.png></p><h3 id=세타-조인>세타 조인<a hidden class=anchor aria-hidden=true href=#세타-조인>#</a></h3><p>세타 조인은 연관관계가 없는 필드로 조인하는 것이다.</p><p>회원의 이름이 팀 이름과 같은 회원을 조회 해보자</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>theta_join</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;teamB&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;teamC&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>,</span><span class=w> </span><span class=n>team</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=n>team</span><span class=p>.</span><span class=na>name</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>extracting</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>containsExactly</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;teamB&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>from 절에 여러 엔티티를 선택해서 세타 조인을 할수있다.</li><li>조인 on을 사용하면 외부 조인이 가능하다.</li></ul><p>쿼리 결과에서 세타 조인이 되는 것을 확인 할수 있다.</p><p><img loading=lazy src=images/image%2010.png alt=image.png></p><hr><h2 id=조인---on절>조인 - on절<a hidden class=anchor aria-hidden=true href=#조인---on절>#</a></h2><h3 id=조인-대상-필터링>조인 대상 필터링<a hidden class=anchor aria-hidden=true href=#조인-대상-필터링>#</a></h3><p>회원과 팀을 조인하면서, 팀 이름이 teamA인 팀만 조인하고 회원은 모두 조회해보자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>join_on_filtering</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Tuple</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>,</span><span class=w> </span><span class=n>team</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>leftJoin</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>team</span><span class=p>,</span><span class=w> </span><span class=n>team</span><span class=p>).</span><span class=na>on</span><span class=p>(</span><span class=n>team</span><span class=p>.</span><span class=na>name</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Tuple</span><span class=w> </span><span class=n>tuple</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;tuple = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>tuple</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과와 result는 다음과 같다.</p><p><img loading=lazy src=images/image%2011.png alt=image.png></p><pre tabindex=0><code>t=[Member(id=3, username=member1, age=10), Team(id=1, name=teamA)]
t=[Member(id=4, username=member2, age=20), Team(id=1, name=teamA)]
t=[Member(id=5, username=member3, age=30), null]
t=[Member(id=6, username=member4, age=40), null]
</code></pre><blockquote><p>on 절을 활용해 조인 대상을 필터링 할 때, 외부조인이 아니라 내부조인(inner join)을 사용하면, where 절에서 필터링 하는 것과 기능이 동일하다. 따라서 on 절을 활용한 조인 대상 필터링을 사용할 때, 내부조인 이면 익숙한 where 절로 해결하고, 정말 외부조인이 필요한 경우에만 이 기능을 사용하자.</p></blockquote><p><strong>내부조인을 사용하고 where절에서 필터링</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>join_on_filtering</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Tuple</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>,</span><span class=w> </span><span class=n>team</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>team</span><span class=p>,</span><span class=w> </span><span class=n>team</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>team</span><span class=p>.</span><span class=na>name</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                .leftJoin(member.team, team).on(team.name.eq(&#34;teamA&#34;))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Tuple</span><span class=w> </span><span class=n>tuple</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;tuple = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>tuple</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>이전거와 동일한 결과이다.</p><h3 id=연관관계-없는-엔티티-외부-조인>연관관계 없는 엔티티 외부 조인<a hidden class=anchor aria-hidden=true href=#연관관계-없는-엔티티-외부-조인>#</a></h3><p>회원의 이름과 팀의 이름이 같은 대상을 외부 조인 해보자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>join_on_no_relation</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;teamA&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;teamB&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>persist</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Member</span><span class=p>(</span><span class=s>&#34;teamC&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Tuple</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>,</span><span class=w> </span><span class=n>team</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>leftJoin</span><span class=p>(</span><span class=n>team</span><span class=p>).</span><span class=na>on</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=n>team</span><span class=p>.</span><span class=na>name</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Tuple</span><span class=w> </span><span class=n>tuple</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;tuple = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>tuple</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><ul><li>연관관계 없는 외부 조인은 일반 조인과 문법이 다르다. leftJoin() 부분에 일반 조인과 다르게 엔티티 하나만 들어간다.<ul><li>일반조인: leftJoin(member.team, team)</li><li>on조인: from(member).leftJoin(team).on(xxx)</li></ul></li></ul><p><strong>쿼리 결과와 result</strong></p><p><img loading=lazy src=images/image%2012.png alt=image.png></p><pre tabindex=0><code>t=[Member(id=3, username=member1, age=10), null]
t=[Member(id=4, username=member2, age=20), null]
t=[Member(id=5, username=member3, age=30), null]
t=[Member(id=6, username=member4, age=40), null]
t=[Member(id=7, username=teamA, age=0), Team(id=1, name=teamA)]
t=[Member(id=8, username=teamB, age=0), Team(id=2, name=teamB)]
</code></pre><hr><h2 id=조인---페치-조인>조인 - 페치 조인<a hidden class=anchor aria-hidden=true href=#조인---페치-조인>#</a></h2><p><strong>페치 조인 미적용</strong></p><p>지연로딩으로 Member SQL 쿼리만 실행된다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@PersistenceUnit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>EntityManagerFactory</span><span class=w> </span><span class=n>emf</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>fetchJoinNo</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>findMember</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchOne</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>loaded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>emf</span><span class=p>.</span><span class=na>getPersistenceUnitUtil</span><span class=p>().</span><span class=na>isLoaded</span><span class=p>(</span><span class=n>findMember</span><span class=p>.</span><span class=na>getTeam</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>loaded</span><span class=p>).</span><span class=na>as</span><span class=p>(</span><span class=s>&#34;페치 조인 미적용&#34;</span><span class=p>).</span><span class=na>isFalse</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>EntityManagerFactory.getPersistenceUnitUtil().isLoaded()로 이미 초기화가 된 엔티티인지 아닌지 알수있다.</p><p><strong>쿼리 결과</strong></p><p><img loading=lazy src=images/image%2013.png alt=image.png></p><p>페치 조인 적용 전에는 member만 조회하는것을 알수 있다.</p><p><strong>페치 조인 적용</strong></p><p>즉시로딩으로 Members, Team SQL 쿼리 조인으로 한번에 조회한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>fetchJoinUse</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>em</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Member</span><span class=w> </span><span class=n>findMember</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>team</span><span class=p>,</span><span class=w> </span><span class=n>team</span><span class=p>).</span><span class=na>fetchJoin</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchOne</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>loaded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>emf</span><span class=p>.</span><span class=na>getPersistenceUnitUtil</span><span class=p>().</span><span class=na>isLoaded</span><span class=p>(</span><span class=n>findMember</span><span class=p>.</span><span class=na>getTeam</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>loaded</span><span class=p>).</span><span class=na>as</span><span class=p>(</span><span class=s>&#34;페치 조인 미적용&#34;</span><span class=p>).</span><span class=na>isTrue</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>join(), leftJoin()등 조인 기능 뒤에 fetchJoin()을 추가하면 된다.</p><p>쿼리 결과로 페치 조인이 잘 적용된것을 확인할수 있다.</p><p><img loading=lazy src=images/image%2014.png alt=image.png></p><hr><h2 id=서브-쿼리>서브 쿼리<a hidden class=anchor aria-hidden=true href=#서브-쿼리>#</a></h2><p>서브 쿼리를 사용하기 위해서 com.querydsl.jpa.JPAExpressions을사용한다.</p><p><strong>서브 쿼리 eq 사용</strong></p><p>나이가 가장 많은 회원을 조회 해보자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>subQuery</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>QMember</span><span class=w> </span><span class=n>memberSub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QMember</span><span class=p>(</span><span class=s>&#34;memberSub&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>JPAExpressions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>memberSub</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>max</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>memberSub</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>).</span><span class=na>extracting</span><span class=p>(</span><span class=s>&#34;age&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>containsExactly</span><span class=p>(</span><span class=n>40</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>서브 쿼리에 중복되는 alias를 가진 Qtype을 사용하면 안되기때문에 Qtype을 새로 생성해준다.</p><p>쿼리 결과를 보면 where절에 서브 쿼리가 적용된것을 확인할수 있다.</p><p><img loading=lazy src=images/image%2015.png alt=image.png></p><p><strong>서브 쿼리 goe 사용</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>subQueryGoe</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>QMember</span><span class=w> </span><span class=n>memberSub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QMember</span><span class=p>(</span><span class=s>&#34;memberSub&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>goe</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>JPAExpressions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>memberSub</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>avg</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>memberSub</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>).</span><span class=na>extracting</span><span class=p>(</span><span class=s>&#34;age&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>containsExactly</span><span class=p>(</span><span class=n>30</span><span class=p>,</span><span class=w> </span><span class=n>40</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과에서 where절에 ≥의 서브 쿼리가 적용된것을 확인할 수 있다.</p><p><img loading=lazy src=images/image%2016.png alt=image.png></p><p><strong>서브쿼리 여러 건 처리 in 사용</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>subQueryIn</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>QMember</span><span class=w> </span><span class=n>memberSub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QMember</span><span class=p>(</span><span class=s>&#34;memberSub&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Member</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>selectFrom</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>in</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>JPAExpressions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>memberSub</span><span class=p>.</span><span class=na>age</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>memberSub</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>memberSub</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>gt</span><span class=p>(</span><span class=n>10</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>assertThat</span><span class=p>(</span><span class=n>result</span><span class=p>).</span><span class=na>extracting</span><span class=p>(</span><span class=s>&#34;age&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>containsExactly</span><span class=p>(</span><span class=n>20</span><span class=p>,</span><span class=w> </span><span class=n>30</span><span class=p>,</span><span class=w> </span><span class=n>40</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과를 보면 where 절에 in 서브 쿼리가 적용된것을 확인할수 있다.</p><p><img loading=lazy src=images/image%2017.png alt=image.png></p><p><strong>select 절에 subquery</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>selectSubQuery</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>QMember</span><span class=w> </span><span class=n>memberSub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>QMember</span><span class=p>(</span><span class=s>&#34;memberSub&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Tuple</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>JPAExpressions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>memberSub</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>avg</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>memberSub</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Tuple</span><span class=w> </span><span class=n>tuple</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;tuple = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>tuple</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과를 보면 select절에 서브 쿼리가 적용된것을 확인할수 있다.</p><p><img loading=lazy src=images/image%2018.png alt=image.png></p><p><strong>static import 활용</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import static</span><span class=w> </span><span class=nn>com.querydsl.jpa.JPAExpressions.select</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>List</span><span class=o>&lt;</span><span class=n>Tuple</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>select</span><span class=p>(</span><span class=n>memberSub</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>avg</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>memberSub</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>JPAExpressions을 static import를 활용해서 코드를 가독성있게 바꾸었다.</p><p><strong>from절의 서브쿼리 한계</strong></p><p>JPA JPQL 서브쿼리의 한계점은 <strong>from 절의 서브쿼리는 지원하지 않고 Querydsl도 지원하지 않는다</strong>. 하이버네이트 구현체를 사용하면 select 절의 서브쿼리는 지원하고 Querydsl도 하이버네이트 구현체를 사용하면 select 절의 서브쿼리를 지원한다.</p><p>from절의 서브쿼리 해결방안</p><ol><li>가능하다면 서브쿼리를 join으로 변경한다.</li><li>애플리케이션에서 쿼리를 2번 분리해서 실행한다.</li><li>nativeSQL을 사용한다.</li></ol><hr><h2 id=case-문>Case 문<a hidden class=anchor aria-hidden=true href=#case-문>#</a></h2><p>select, where, order by 에서 사용 가능하다.</p><p><strong>단순한 조건</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>basicCase</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>when</span><span class=p>(</span><span class=n>10</span><span class=p>).</span><span class=na>then</span><span class=p>(</span><span class=s>&#34;열살&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>when</span><span class=p>(</span><span class=n>20</span><span class=p>).</span><span class=na>then</span><span class=p>(</span><span class=s>&#34;스무살&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>otherwise</span><span class=p>(</span><span class=s>&#34;기타&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;s = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>s</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과를 보면 select절에 Case문이 적용된것을 확인할수 있다.</p><p><img loading=lazy src=images/image%2019.png alt=image.png></p><p>result 출력 결과</p><p><img loading=lazy src=images/image%2020.png alt=image.png></p><p><strong>복잡한 조건</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>complexCase</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>CaseBuilder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>when</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>between</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>20</span><span class=p>)).</span><span class=na>then</span><span class=p>(</span><span class=s>&#34;0~20살&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>when</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>between</span><span class=p>(</span><span class=n>21</span><span class=p>,</span><span class=w> </span><span class=n>30</span><span class=p>)).</span><span class=na>then</span><span class=p>(</span><span class=s>&#34;21~30살&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=na>otherwise</span><span class=p>(</span><span class=s>&#34;기타&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;s = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>s</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>복잡한 조건에서는 <strong>CaseBuilder</strong>를 사용한다.</p><p>쿼리 결과를 보면 복잡한 case문이 적용된것을 확인할수 있다.</p><p><img loading=lazy src=images/image%2021.png alt=image.png></p><p>result 출력 결과</p><p><img loading=lazy src=images/image%2022.png alt=image.png></p><p><strong>orderBy에서 Case 문 함께 사용</strong></p><p>다음과 같은 임의의 순서로 회원을 출력해보자</p><ol><li>0 ~ 30살이 아닌 회원을 가장 먼저 출력</li><li>0 ~ 20살 회원 출력</li><li>21 ~ 30살 회원 출력</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>OrderByCase</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>NumberExpression</span><span class=o>&lt;</span><span class=n>Integer</span><span class=o>&gt;</span><span class=w> </span><span class=n>rankPath</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CaseBuilder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>when</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>between</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>20</span><span class=p>)).</span><span class=na>then</span><span class=p>(</span><span class=n>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>when</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>between</span><span class=p>(</span><span class=n>21</span><span class=p>,</span><span class=w> </span><span class=n>30</span><span class=p>)).</span><span class=na>then</span><span class=p>(</span><span class=n>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>otherwise</span><span class=p>(</span><span class=n>3</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Tuple</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w> </span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>,</span><span class=w> </span><span class=n>rankPath</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>orderBy</span><span class=p>(</span><span class=n>rankPath</span><span class=p>.</span><span class=na>desc</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Tuple</span><span class=w> </span><span class=n>tuple</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tuple</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>age</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tuple</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>rank</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tuple</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>rankPath</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;username = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>username</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; age = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>age</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; rank = &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>rank</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Querydsl은 자바 코드로 작성하기 때문에 rankPath처럼 복잡한 조건을 변수로 선언해서 select절, orderBy절에서 함께 사용할 수 있다.</p><p><strong>result 출력 결과</strong></p><pre tabindex=0><code>username = member4 age = 40 rank = 3
username = member1 age = 10 rank = 2
username = member2 age = 20 rank = 2
username = member3 age = 30 rank = 1
</code></pre><hr><h2 id=상수-문자-더하기>상수, 문자 더하기<a hidden class=anchor aria-hidden=true href=#상수-문자-더하기>#</a></h2><p>상수가 필요하면 Expressions.constant(xxx)를 사용한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>constant</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Tuple</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>,</span><span class=w> </span><span class=n>Expressions</span><span class=p>.</span><span class=na>constant</span><span class=p>(</span><span class=s>&#34;A&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetch</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Tuple</span><span class=w> </span><span class=n>tuple</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;tuple = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>tuple</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리에서는 상수를 더한것이 적용되지않고 결과에서는 상수를 받는다.</p><p><img loading=lazy src=images/image%2023.png alt=image.png></p><p>result 출력 결과</p><p><img loading=lazy src=images/image%2024.png alt=image.png></p><h3 id=문자-더하기-concat>문자 더하기 concat<a hidden class=anchor aria-hidden=true href=#문자-더하기-concat>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>concat</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queryFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>concat</span><span class=p>(</span><span class=s>&#34;_&#34;</span><span class=p>).</span><span class=na>concat</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>age</span><span class=p>.</span><span class=na>stringValue</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>member</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>where</span><span class=p>(</span><span class=n>member</span><span class=p>.</span><span class=na>username</span><span class=p>.</span><span class=na>eq</span><span class=p>(</span><span class=s>&#34;member1&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=na>fetchOne</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;result = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>쿼리 결과를 보면 concat이 적용된것을 확인할수 있다.</p><p><img loading=lazy src=images/image%2025.png alt=image.png></p><p>result 출력 결과</p><p><img loading=lazy src=images/image%2026.png alt=image.png></p><blockquote><p>문자가 아닌 다른 타입들은 stringValue()로 문자로 변환할 수 있다. 이 방법은 ENUM을 처리할 때도 자주 사용한다.</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://yosong6729.github.io/tags/querydsl/>Querydsl</a></li></ul><nav class=paginav><a class=prev href=https://yosong6729.github.io/post/querydsl---%EC%A4%91%EA%B8%89-%EB%AC%B8%EB%B2%95/><span class=title>« Prev</span><br><span>[Querydsl] 중급 문법</span>
</a><a class=next href=https://yosong6729.github.io/post/%EB%82%98%EB%A8%B8%EC%A7%80-%EA%B8%B0%EB%8A%A5/><span class=title>Next »</span><br><span>나머지 기능</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://yosong6729.github.io/>Yosong6729 Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>